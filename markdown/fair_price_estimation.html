

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>16. Fair price estimation &#8212; Advanced Analytics and Algorithmic Trading</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'markdown/fair_price_estimation';</script>
    <link rel="canonical" href="https://www.datasciencealgotrading.com/markdown/fair_price_estimation.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="17. Liquidity modelling" href="liquidity_modelling.html" />
    <link rel="prev" title="15. Market Making fundamentals" href="market_making_fundamentals.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../welcome.html">
  
  
  
  
  
  
    <p class="title logo__title">Advanced Analytics and Algorithmic Trading</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../welcome.html">
                    Welcome
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="dedication.html">Dedication</a></li>
<li class="toctree-l1"><a class="reference internal" href="preface.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="symbollist.html">Symbols</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Financial Markets Fundamentals</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="intro_financial_markets.html">1. Financial Markets</a></li>
<li class="toctree-l1"><a class="reference internal" href="intro_financial_instruments.html">2. Mechanics of Financial Instruments</a></li>
<li class="toctree-l1"><a class="reference internal" href="market_microstructure.html">3. Market microstructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithmic_trading.html">4. Algorithmic Trading</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Financial Modelling Fundamentals</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="intro_bayesian.html">5. Bayesian Modelling</a></li>
<li class="toctree-l1"><a class="reference internal" href="intro_causal.html">6. Causal inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="stochastic_calculus.html">7. Stochastic Calculus</a></li>
<li class="toctree-l1"><a class="reference internal" href="stochastic_optimal_control.html">8. Stochastic optimal control</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_driven_methods.html">9. Data-driven methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="generative_ai.html">10. Generative Artificial Intelligence</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Execution Algorithms</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="execution_fundamentals.html">11. Execution fundamentals</a></li>
<li class="toctree-l1"><a class="reference internal" href="lob_models.html">12. Modelling the Limit Order Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="almgren_chriss.html">13. The Almgren - Chriss Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="execution_tactics.html">14. Execution tactics</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Market Making Algorithms</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="market_making_fundamentals.html">15. Market Making fundamentals</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">16. Fair price estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="liquidity_modelling.html">17. Liquidity modelling</a></li>
<li class="toctree-l1"><a class="reference internal" href="rfq_models.html">18. Modelling RfQs in Dealer to Client Markets</a></li>
<li class="toctree-l1"><a class="reference internal" href="avellaneda_stoikov.html">19. The Avellaneda and Stoikov Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="enriching_avellaneda.html">20. Enriching the Avellaneda and Stoikov Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="hedging.html">21. Hedging strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="market_making_rl.html">22. Reinforcement Learning and Market Making</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Investment Algorithms</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="quant_investment_fundamentals.html">23. Quantitative investment fundamentals</a></li>
<li class="toctree-l1"><a class="reference internal" href="mean_reversion_strategies.html">24. Mean reversion strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="trend_following.html">25. Trend following strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="arbitrage.html">26. Arbitrage Strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="factor_investing.html">27. Factor Investing</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimal_portfolios.html">28. Optimal portfolios</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Glossary and References</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Notebooks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../notebooks/stochastic_calculus.html">Stochastic Calculus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/bayesian_theory.html">Bayesian Modelling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/market_microstructure.html">Market Microstructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/rfq_models.html">Modelling RfQs in Dealer to Client Markets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/fair_price_estimation.html">Fair Price Estimation</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/xaviweise/aaat" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/xaviweise/aaat/issues/new?title=Issue%20on%20page%20%2Fmarkdown/fair_price_estimation.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/markdown/fair_price_estimation.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Fair price estimation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">16.1. Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pricing-of-flow-products">16.2. Pricing of flow products</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-kalman-filter-model-for-pricing">16.2.1. The Kalman Filter model for pricing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#a-simple-pricing-model">16.2.1.1. A simple pricing model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#estimation-of-the-simple-pricing-model">16.2.1.2. Estimation of the simple pricing model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#inference-on-the-simple-pricing-model">16.2.1.3. Inference on the simple pricing model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#two-correlated-instruments">16.2.1.4. Two correlated instruments</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pricing-sources-and-models">16.2.2. Pricing sources and models</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#lob-traded">16.2.2.1. LOB traded</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#rfq-traded">16.2.2.2. RfQ traded</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#composites">16.2.2.2.1. Composites</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#rfqs">16.2.2.2.2. RfQs</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#trades">16.2.2.2.3. Trades</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#hitmiss">16.2.2.2.4. HitMiss</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#correlated-instruments">16.2.2.3. Correlated instruments</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#derivatives-pricing">16.3. Derivatives pricing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-utility-indifference-theory-of-derivatives-pricing">16.3.1. The utility indifference theory of derivatives pricing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-pricing-of-a-simple-contingent-claim">16.3.1.1. Example: pricing of a simple contingent claim</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-forward-on-a-non-dividend-paying-stock">16.3.1.2. Example: Forward on a non-dividend paying stock</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-european-call-options">16.3.1.3. Example: European Call Options</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-arbitrage-free-theory-of-derivatives-pricing">16.3.2. The arbitrage-free theory of derivatives pricing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">16.3.2.1. Example: Forward on a non-dividend paying stock</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">16.3.2.2. Example: European Call Options</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-black-scholes-merton-model">16.3.2.3. The Black - Scholes - Merton Model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-the-black-scholes-merton-equation">16.3.2.4. Solving the Black-Scholes-Merton equation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#an-alternative-derivation-the-market-price-of-risk">16.3.2.5. An alternative derivation: the market price of risk</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-bsm-framework-in-practice">16.3.2.6. Using the BSM framework in practice</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">16.4. Exercises</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="fair-price-estimation">
<h1><span class="section-number">16. </span>Fair price estimation<a class="headerlink" href="#fair-price-estimation" title="Permalink to this heading">#</a></h1>
<section id="introduction">
<h2><span class="section-number">16.1. </span>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
</section>
<section id="pricing-of-flow-products">
<h2><span class="section-number">16.2. </span>Pricing of flow products<a class="headerlink" href="#pricing-of-flow-products" title="Permalink to this heading">#</a></h2>
<p>For flow products that are relatively liquid, we can aim at extracting all the pricing information from price indications and trades in the market, without having to resort to economic theories of fair value. In this setup, we consider their price the one that market participants are willing to pay for.</p>
<p>The issue, though, is that price indications and trades cannot be considered themselves pure observations of fair price, since they might be affected by market frictions: bid ask spreads, particularities of the negotiation mechanism, liquidity fluctuations, specific needs of market participants at a given time, etc. When instruments trade in limit order books, a popular estimation of the fair price is using the mid-price, the arithmetic average of the best bid and ask. However, if bid-ask spreads are wide of liquidity is thin in the first levels, such estimation is not necessary very precise. Trades provide a lot of information, since they are real transaction and not indications of interests, the larger they are in principle the more information. Still, they are subject to the aforementioned market frictions that reduce their reliability.</p>
<p>These makes all these price observations noisy estimates of the fair price, so if we want to estimate a fair price out of them we need to be able to separate the signal from the noise, or in other words, filter those observations. This is precisely what, under certain model assumptions, a Kalman filter does.</p>
<section id="the-kalman-filter-model-for-pricing">
<h3><span class="section-number">16.2.1. </span>The Kalman Filter model for pricing<a class="headerlink" href="#the-kalman-filter-model-for-pricing" title="Permalink to this heading">#</a></h3>
<p>The Kalman filter was introduced in the chapter on <span class="xref myst">Bayesian Theory</span>. It is a Bayesian filtering algorithm that allows to perform exact inference, i.e. compute the closed-form distribution, of the latent state vector in a Linear Gaussian State Space Model (LG-SSM).</p>
<p>Recall that a <em>State Space Model (SSM)</em> is a model to describe dynamic systems where we have a non or partially observable state, a vector <span class="math notranslate nohighlight">\(\mathbf{x}\)</span>, whose dynamics in time is described by a so-called transition equation:</p>
<div class="math notranslate nohighlight">
\[ \mathbf{x}_{t+\Delta t} = f(\mathbf{x}_t, \mathbf{u}_t) + \mathbf{\epsilon}_t\]</div>
<p>where <span class="math notranslate nohighlight">\(f(\mathbf{x}_t, \mathbf{u}_t)\)</span> is a general function, <span class="math notranslate nohighlight">\(\mathbf{u}_t\)</span> are inputs (or controls) that affect the dynamics, <span class="math notranslate nohighlight">\(\Delta t\)</span> is the time-step between observations, and <span class="math notranslate nohighlight">\(\mathbf{ \epsilon}_t\)</span> is a transition noise with a given distribution. The state is observed indirectly via a proxy vector <span class="math notranslate nohighlight">\(\mathbf{y}\)</span> via the observation equation:</p>
<div class="math notranslate nohighlight">
\[\mathbf{y}_t = g(\mathbf{x}_t, \mathbf{u}_t)  + \mathbf{\eta}\]</div>
<p>where <span class="math notranslate nohighlight">\(g(\mathbf{x}_t, \mathbf{u}_t)\)</span> is another general function and <span class="math notranslate nohighlight">\(\mathbf{\eta}_t\)</span> the observation noise, meaning that observations have a degree of uncertainty with respect to the latent space.</p>
<p>A <em>Linear Gaussian Model (LGM)</em> is a specific case of the SSM were both the transition and observation functions are linear and the noise terms are Gaussian. In this case, we can use the Kalman filter algorithm to compute the distribution of the state vector at any time, given the observations and the transition and observation model. If some or all the parameters of these models are not known, they can be estimated using standard techniques like Maximum Likelihood Estimation (MLE) or Expectation Maximization (EM) when the former becomes computationally intractable due to the latent state vector.</p>
<p>For non-Linear Gaussian Models, there are extensions of the Kalman filter that can be used:</p>
<ul class="simple">
<li><p>Extended Kalman Filter (EKF): Extends the Kalman Filter to non-linear state space models by linearizing the dynamics and observation models around the current estimate using Taylor expansions.</p></li>
<li><p>Unscented Kalman Filter (UKF): Avoids linearization by using deterministic sampling to approximate the state distribution.</p></li>
</ul>
<section id="a-simple-pricing-model">
<h4><span class="section-number">16.2.1.1. </span>A simple pricing model<a class="headerlink" href="#a-simple-pricing-model" title="Permalink to this heading">#</a></h4>
<p>Let us consider a simple setup where we aim to infer the distribution of the mid-price <span class="math notranslate nohighlight">\(m_t\)</span> of a financial instrument that follows a random walk:</p>
<div class="math notranslate nohighlight">
\[m_{t+\Delta t} = m_t + \epsilon_t, \epsilon_t \sim N(0, \sigma_\epsilon^2 \Delta t)\]</div>
<p>We don’t observe this mid-price, only trades which we consider noisy observation of the mid since they include transaction costs and potentially other external factors like dealer inventory positions, etc:</p>
<div class="math notranslate nohighlight">
\[p_t = m_t + \nu_t, \nu_t \sim N(0, \sigma_\nu^2)\]</div>
<p>Readers will recognize that this is the local level model discussed extensively in the Chapter on <span class="xref myst">Bayesian Modelling</span>. For the observation noise we can introduce prior business knowledge about the confidence we have on trade observations as a source of pricing information. In his Option Trading’s book, Euan Sinclair describes a simple model that quantifies the information provided by trades based on the size of the trade, <span class="math notranslate nohighlight">\(v\)</span>:</p>
<div class="math notranslate nohighlight">
\[\sigma_\nu (v)= \sigma_p \left(\frac{v_\text{max}}{v}-1)\right)^+\]</div>
<p>where <span class="math notranslate nohighlight">\(\sigma_p\)</span> is a baseline observation noise and <span class="math notranslate nohighlight">\(v_\text{max}\)</span> is an input to the model, the trade size we believe saturates information the information provided in the sense that our mid estimation will essentially move the price of the trade. In contrast, trades of small size, <span class="math notranslate nohighlight">\(v \ll v_\text{max}\)</span>, will have <span class="math notranslate nohighlight">\(\sigma_p \rightarrow \infty\)</span> and will provide a negligible pricing information. An alternative simple model is:</p>
<div class="math notranslate nohighlight">
\[\sigma_\nu(v) = \sigma_p \frac{v_0}{v}\]</div>
<p>where <span class="math notranslate nohighlight">\(v_0\)</span> in this case is a size scale that separates the regimes where the information provided by the trade is negligible, <span class="math notranslate nohighlight">\(v \ll v_0\)</span>, or relevant <span class="math notranslate nohighlight">\(v \gg v_0\)</span>, but it does not saturate for a specific trading size, as in Sinclair’s model. Of course nothing prevents to use more business prior knowledge to enrich the observation model with other observable characteristics of the trade or the wider market context.</p>
</section>
<section id="estimation-of-the-simple-pricing-model">
<h4><span class="section-number">16.2.1.2. </span>Estimation of the simple pricing model<a class="headerlink" href="#estimation-of-the-simple-pricing-model" title="Permalink to this heading">#</a></h4>
<p>As discussed in <span class="xref myst">Bayesian Modelling</span>, the standard way to estimate the parameters of a Kalman Filter is using the Expectation Maximization (EM) algorithm, suitable for probabilistic models with latent variables. However, the properties of the simple pricing model can be exploited to obtain closed-form estimators for its parameters using moment matching.</p>
<p>Let us start by working with a model where observation errors have no dependency on the volume: <span class="math notranslate nohighlight">\(\sigma_\nu (v) = \sigma_\nu\)</span>. The key is to compute statistics of:</p>
<div class="math notranslate nohighlight">
\[d_t \equiv p_{t+\Delta t} - p_t = (m_{t+\Delta t}- m_t) + (\nu_{t+\Delta t} - \nu_t) = \epsilon_t + (\nu_{t+\Delta t} - \nu_t)\]</div>
<p>which depend only on observed trades. First we compute the variance:</p>
<div class="math notranslate nohighlight">
\[Var[d_t]= Var[\epsilon_t] + Var[(\nu_{t+\Delta t} - \nu_t)]= \sigma_\epsilon^2 \Delta t + 2 \sigma_\nu^2\\]</div>
<p>where we have used that <span class="math notranslate nohighlight">\(\epsilon_t\)</span>, <span class="math notranslate nohighlight">\(\nu_{t+\Delta t}\)</span> and <span class="math notranslate nohighlight">\(\nu_t\)</span> are independent random variables. This expression links the variance of the first differences in trade prices with the parameters to estimate. We need though a second expression to solve for each parameters separately. For that we compute the lag-1 auto-covariance of <span class="math notranslate nohighlight">\(d_t\)</span>:</p>
<div class="math notranslate nohighlight">
\[Cov[d_t,d_{t-\Delta t}]=Cov[\epsilon_t + (\nu_{t+\Delta t} - \nu_t), \epsilon_{t-\Delta t} + (\nu_t - \nu_{t-\Delta t})] = -Var[\nu_t] = -\sigma_\nu^2\]</div>
<p>where again we have used the independence between the noise terms. Our estimators read then:</p>
<div class="math notranslate nohighlight">
\[ \hat{\sigma}_\epsilon^2 \Delta t = \frac{1}{N-1} \sum_{i=1}^{N-1} d_{t_i}^2 - 2 \hat{\sigma}_\nu^2 \]</div>
<div class="math notranslate nohighlight">
\[ \hat{\sigma}_\nu^2 = -\frac{1}{N-2}\sum_{i=2}^{N-1} d_{t_i} d_{t_{i}-\Delta t}\]</div>
<p>The results have an interesting interpretation:</p>
<ul class="simple">
<li><p>Starting from the first equation: the variance of the mid-price must be lower than the variance of the observed trades, given the additional noise in the observation equation. Or, in other words, since the mid-price is filtered from the trades, which means that we estimate it by removing noise from the trades, it has to have a lower variance.</p></li>
<li><p>The second equation can be recognized as a form of the Roll estimator for effective bid-ask spreads, a typical measure of liquidity. Of course, by construction of the model, the noise that is filtered is essentially the bid-ask spread that liquidity providers request as a compensation for the liquidity provision.</p></li>
</ul>
<p>In the case of volume dependent observation errors, we can still compute these statistics, which now read:</p>
<div class="math notranslate nohighlight">
\[Var[d_t]= \sigma_\epsilon^2 \Delta t + \sigma_\nu^2(v_{t+\Delta t}) + \sigma_\nu^2(v_t)\]</div>
<div class="math notranslate nohighlight">
\[Cov[d_t,d_{t-\Delta t}]= -\sigma_\nu^2 (v_t)\]</div>
<p>The statistical estimator of the variance of the first differences can still be used, by accounting by the variability of the error with volume (heteroskedasticity):</p>
<div class="math notranslate nohighlight">
\[E[\frac{1}{N-1} \sum_{i=1}^{N-1} d_{t_i}^2]= \frac{1}{N-1} \sum_{i=1}^{N-1} \left(\sigma_\epsilon^2 \Delta t + \sigma_\nu^2(v_{t+\Delta t}) + \sigma_\nu^2(v_t)\right)=\sigma_\epsilon^2 \Delta t+\frac{1}{N-1} \sum_{i=1}^{N-1} \left( \sigma_\nu^2(v_{t+\Delta t}) + \sigma_\nu^2(v_t)\right)\]</div>
<p>Moving into the 1-lag covariance, we have:</p>
<div class="math notranslate nohighlight">
\[E[\frac{1}{N-2}\sum_{i=2}^{N-1} d_{t_i} d_{t_{i}-\Delta t}] = - \frac{1}{N-2}\sum_{i=2}^{N-1} \sigma_v^2(v_{t_i})\]</div>
<p>As far as we the volume dependency has a single parameter to fit, we can still use these two equations to solve for the parameters. If we use, for instance, the simple model <span class="math notranslate nohighlight">\(\sigma_\nu(v) = \sigma_p \frac{v_0}{v}\)</span>, where <span class="math notranslate nohighlight">\(v_0\)</span> is given and <span class="math notranslate nohighlight">\(\sigma_p\)</span> is to be estimated from data (notice that we could simply estimate <span class="math notranslate nohighlight">\(\sigma_p v_0\)</span>, the factorization is useful for business interpretation):</p>
<div class="math notranslate nohighlight">
\[E[\frac{1}{N-1} \sum_{i=1}^{N-1} d_{t_i}^2]=\sigma_\epsilon^2 \Delta t+  \frac{\sigma_p^2}{N-1} \sum_{i=1}^{N-1} \left(  \frac{v^2_0}{v^2_{t_i+\Delta t}}  +  \frac{v^2_0}{v^2_{t_i}} \right)\]</div>
<div class="math notranslate nohighlight">
\[E[\frac{1}{N-2}\sum_{i=2}^{N-1} d_{t_i} d_{t_{i}-\Delta t}] =  - \frac{\sigma_p^2}{N-2}\sum_{i=2}^{N-1} \frac{v^2_0}{v^2_{t_i}} \]</div>
<p>In this simple case, the estimation of the parameters <span class="math notranslate nohighlight">\(\sigma_p\)</span> and <span class="math notranslate nohighlight">\(\sigma_\epsilon\)</span> is straightforward. More complex functions like the one from Sinclair cannot be estimated with only two moments. Further moments can be computed to provide extra equations, although at this point it might be worthy to resort to standard estimation techniques like EM if available.</p>
</section>
<section id="inference-on-the-simple-pricing-model">
<h4><span class="section-number">16.2.1.3. </span>Inference on the simple pricing model<a class="headerlink" href="#inference-on-the-simple-pricing-model" title="Permalink to this heading">#</a></h4>
<p>We can use the general Kalman filter equations described in <span class="xref myst">Bayesian Modelling</span> to derive the distribution of our mid - price at the next time <span class="math notranslate nohighlight">\(t + \Delta t\)</span> where a trade happens.</p>
<p>The Kalman filter algorithm operates sequentially over observation steps applying two steps, the <em>predict</em> step, where we compute the distribution of the mid-price based purely on the random walk model, and the <em>update</em> step in which we incorporate the information provided by the observation of a new trade. We define <span class="math notranslate nohighlight">\(m_{t+\Delta t}^t\)</span> as the distribution of the mid-price at <span class="math notranslate nohighlight">\(t+\Delta t\)</span> before observing the trade, and <span class="math notranslate nohighlight">\(m_{t+\Delta}^{t+\Delta t}\)</span> afterwards.</p>
<p>Let us apply first the predict step. The distribution of <span class="math notranslate nohighlight">\(m_{t+\Delta t}^t\)</span> is Gaussian with mean and variance given by:</p>
<div class="math notranslate nohighlight">
\[\bar{m}_{t+\Delta t}^t = \bar{m}_{t}^t\]</div>
<div class="math notranslate nohighlight">
\[(\sigma_{m,t+\Delta t}^t)^2 = (\sigma_{m,t}^t)^2 + \sigma_\epsilon^2 \Delta t\]</div>
<p>Since our model uses a drift-less random walk dynamics for the evolution of the mid-price, the updated mean does not change and the variance increases proportionally to the time step <span class="math notranslate nohighlight">\(\Delta t\)</span>.</p>
<p>Now we use the update step to incorporate the information from a trade happening at <span class="math notranslate nohighlight">\(t + \Delta t\)</span>:</p>
<div class="math notranslate nohighlight">
\[\bar{m}_{t+\Delta t}^{t+\Delta t} = \bar{m}_{t}^{t+\Delta t} + K_t (p_t - \bar{m}_{t}^{t+\Delta t}) \]</div>
<div class="math notranslate nohighlight">
\[(\sigma_{m,t+\Delta t}^{t+\Delta t})^2 = \frac{(\sigma_{m,t+\Delta t}^t)^2  \sigma_\eta^2}{(\sigma_{m,t+\Delta t}^t)^2  + \sigma_\eta^2}\]</div>
<p>where <span class="math notranslate nohighlight">\(K_t\)</span> is the Kalman gain, given by:</p>
<div class="math notranslate nohighlight">
\[K_t = \frac{(\sigma_{m,t+\Delta t}^t)^2}{(\sigma_{m,t+\Delta t}^t)^2  + \sigma_\eta^2} \]</div>
<p>The updated mean is an interpolation between the predicted mean and the trade observation, weighted by the Kalman gain</p>
<ul class="simple">
<li><p>If the observation noise is much smaller than the uncertainty in the mean in the prediction step, namely <span class="math notranslate nohighlight">\(\sigma_\eta \ll \sigma_{m,t+\Delta t}^t\)</span>, the Kalman gain then tends to <span class="math notranslate nohighlight">\(K_t \rightarrow 1\)</span> and <span class="math notranslate nohighlight">\(\bar{m}_{t+\Delta t}^{t+\Delta t} = p_t\)</span>, i.e. since our confidence on the information from the trade is much higher than our best estimation of the mean, we essentially update the mean with the trade price.</p></li>
<li><p>On the contrary, if <span class="math notranslate nohighlight">\(\sigma_\eta \gg \sigma_{m,t+\Delta t}^t\)</span>, the Kalman gain then tends to <span class="math notranslate nohighlight">\(K_t \rightarrow 0\)</span> and <span class="math notranslate nohighlight">\(\bar{m}_{t+\Delta t}^{t+\Delta t} = \bar{m}_{t}^{t+\Delta t}\)</span>. In this case, our confidence on the information provided by the trade is very low, so essentially we ignore the trade information and use the predicted mean.</p></li>
<li><p>In between those two limiting cases, the updated mean combines the information from the prediction using the internal dynamics and our last update, and the trade information.</p></li>
</ul>
<p>If we look at the new standard deviation, we also find similar limiting behaviors:</p>
<ul class="simple">
<li><p>If <span class="math notranslate nohighlight">\(\sigma_\eta \ll \sigma_{m,t+\Delta t}\)</span>, then <span class="math notranslate nohighlight">\(\sigma_{m,t+\Delta t}^{t+\Delta t} \rightarrow \sigma_\eta\)</span>, since as we discussed above, we essentially use the trade information to inform our estimation of the mid.</p></li>
<li><p>If <span class="math notranslate nohighlight">\(\sigma_\eta \gg \sigma_{m,t+\Delta t}\)</span>, then <span class="math notranslate nohighlight">\(\sigma_{m,t+\Delta t}^{t+\Delta t} \rightarrow \sigma_{m,t+\Delta t}^t\)</span>, i.e. we stick with the estimation from the predict step</p></li>
</ul>
<p>One interesting consequence of the optimality of the Kalman filter is that the updated standard deviation cannot be larger than the predicted one, and for any finite <span class="math notranslate nohighlight">\(\sigma_\eta\)</span> is always smaller: the information from the trade always contributes to improve our estimation of the mid-price.  This is easily seen writing:
$<span class="math notranslate nohighlight">\(\sigma_{m,t+\Delta t}^{t+\Delta t} =\sigma_{m,t+\Delta t}^t \frac{1}{\sqrt{(\frac{\sigma_{m,t+\Delta t}^t}{\sigma_\eta})^2  + 1}}\)</span><span class="math notranslate nohighlight">\( 
Since \)</span>\frac{\sigma_{m,t+\Delta t}^t}{\sigma_\eta}$ is non-negative, then the denominator is never lower than 1.</p>
<p>TO DO: MENTION ROLE OF SMOOTHING: eg flow value computation a posteriori, calibraiton etc</p>
</section>
<section id="two-correlated-instruments">
<h4><span class="section-number">16.2.1.4. </span>Two correlated instruments<a class="headerlink" href="#two-correlated-instruments" title="Permalink to this heading">#</a></h4>
<p>In this case, the Kalman gain has the following structure:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
K_t = \frac{1}{(\sigma_{v,1}^2 + (\sigma_{1,t}^{t-1})^2)(\sigma_{v,2}^2 + (\sigma_{2,t}^{t-1})^2) -  (\rho_t^{t-1}\sigma_{1,t}^{t-1}\sigma_{2,t}^{t-1})^2} \nonumber \\
\begin{pmatrix} 
(\sigma_{1,t}^{t-1})^2 \sigma_{v,2}^2 + (\sigma_{1,t}^{t-1})^2(\sigma_{2,t}^{t-1})^2(1- (\rho_t^{t-1})^2) &amp;  \rho_t^{t-1} \sigma_{1,t}^{t-1}\sigma_{2,t}^{t-1}\sigma_{v,1}^2 \\ 
  \rho_t^{t-1} \sigma_{1,t}^{t-1}\sigma_{2,t}^{t-1}\sigma_{v,1}^2 &amp; (\sigma_{2,t}^{t-1})^2\sigma_{v,1}^2 + (\sigma_{1,t}^{t-1})^2 (\sigma_{2,t}^{t-1})^2)(1-(\rho_t^{t-1})^2)
  \nonumber \\
\end{pmatrix}
\end{aligned}\end{split}\]</div>
<p>For the case in which <span class="math notranslate nohighlight">\(\sigma_{v,2} = 0\)</span> let us see the effect of the
observation of the second instrument on the first one: $<span class="math notranslate nohighlight">\(\begin{aligned}
\hat{P}^{t}_{1,t} = \hat{P}^{t-1}_{1,t} + \frac{1}{1-(\rho_t^{t-1})^2 + (\frac{\sigma_{v,1}}{\sigma_{1,t}^{t-1}})^2}\left((1-(\rho_t^{t-1})^2)(O_{1,t} - \hat{P}^{t}_{1,t}) + \rho_t^{t-1} \frac{\sigma_{v,1}^2}{\sigma_{1,t}^{t-1} \sigma_{2,t}^{t-1}}(O_{2,t} - \hat{P}^{t}_{2,t})  \right)  \nonumber \\
\end{aligned}\)</span>$</p>
</section>
</section>
<section id="pricing-sources-and-models">
<h3><span class="section-number">16.2.2. </span>Pricing sources and models<a class="headerlink" href="#pricing-sources-and-models" title="Permalink to this heading">#</a></h3>
<section id="lob-traded">
<h4><span class="section-number">16.2.2.1. </span>LOB traded<a class="headerlink" href="#lob-traded" title="Permalink to this heading">#</a></h4>
</section>
<section id="rfq-traded">
<h4><span class="section-number">16.2.2.2. </span>RfQ traded<a class="headerlink" href="#rfq-traded" title="Permalink to this heading">#</a></h4>
<section id="composites">
<h5><span class="section-number">16.2.2.2.1. </span>Composites<a class="headerlink" href="#composites" title="Permalink to this heading">#</a></h5>
</section>
<section id="rfqs">
<h5><span class="section-number">16.2.2.2.2. </span>RfQs<a class="headerlink" href="#rfqs" title="Permalink to this heading">#</a></h5>
</section>
<section id="trades">
<h5><span class="section-number">16.2.2.2.3. </span>Trades<a class="headerlink" href="#trades" title="Permalink to this heading">#</a></h5>
</section>
<section id="hitmiss">
<h5><span class="section-number">16.2.2.2.4. </span>HitMiss<a class="headerlink" href="#hitmiss" title="Permalink to this heading">#</a></h5>
</section>
</section>
<section id="correlated-instruments">
<h4><span class="section-number">16.2.2.3. </span>Correlated instruments<a class="headerlink" href="#correlated-instruments" title="Permalink to this heading">#</a></h4>
</section>
</section>
</section>
<section id="derivatives-pricing">
<h2><span class="section-number">16.3. </span>Derivatives pricing<a class="headerlink" href="#derivatives-pricing" title="Permalink to this heading">#</a></h2>
<p>Derivatives are financial instruments whose value depends on the price of an underlying instrument, hence the name “derivative”. It is therefore logic to assume that their pricing should be somehow restricted by that of the underlying. Of course if a derivative trades in relatively liquid markets, to compute its fair price we can simply resort to the techniques discussed above, unless we are trying to identify arbitrage opportunities so we aim at challenging those market prices. Of course, precisely because of the existence of investors that seek to capitalize on those opportunities, one could expect that in those cases markets tend to reflect, at least on average, prices that are consistent with such “relative pricing models”. In the absence of liquidity, though, such models become critical to be able to quote prices of derivatives to clients.</p>
<p>A comprehensive description of techniques for derivatives pricing is out of the scope of this book. Let us concentrate on some of the most popular and liquid contracts, which are more relevant for algorithmic trading</p>
<section id="the-utility-indifference-theory-of-derivatives-pricing">
<h3><span class="section-number">16.3.1. </span>The utility indifference theory of derivatives pricing<a class="headerlink" href="#the-utility-indifference-theory-of-derivatives-pricing" title="Permalink to this heading">#</a></h3>
<p>Let us consider a simple derivative contract that pays off <span class="math notranslate nohighlight">\(P_T = f(S_T)\)</span> at a given expiry date <span class="math notranslate nohighlight">\(T &gt; t\)</span>, being <span class="math notranslate nohighlight">\(t\)</span> the present time. For ease of exposition, we consider <span class="math notranslate nohighlight">\(T\)</span> to be determinist, but it could also be contingent to a certain event detailed in the derivative’s contract. The pay-off function <span class="math notranslate nohighlight">\(P_T\)</span> depends on the value of the underlying <span class="math notranslate nohighlight">\(S_T\)</span> at the expiry time <span class="math notranslate nohighlight">\(T\)</span>. It can also depend on other parameters that are deterministic. For instance, for an European call option we have <span class="math notranslate nohighlight">\(P_T = C_T = (S_T-K)^+\)</span>, where <span class="math notranslate nohighlight">\(K\)</span> is the strike.</p>
<p>The derivative pays in the future a quantity that is contingent to the future value of the underlying, whose value is known today but is uncertain in the future. Therefore, the future pay-off is uncertain, so  which the price would a rational investor be willing to accept to get into this contract, the so-called premium of the derivative? To get an estimation, we need to use probability theory to put some bounds to our uncertainty, so we characterize <span class="math notranslate nohighlight">\(S_T\)</span> by a random distribution function <span class="math notranslate nohighlight">\(g(S_T)\)</span>. As we saw in chapter <a class="reference internal" href="stochastic_calculus.html#stochastic-calculus"><span class="std std-ref">Stochastic Calculus</span></a>, a popular model that allows us to compute such future distribution is a random walk model or a geometric random walk, the latter being a natural choice for prices that cannot be negative. In those cases the future distribution can be computed, being a normal distribution in the first case, and a log-normal distribution in the second, e.g. in the case of stocks. Although for short expiries the random walk can also be a good model for stocks. These models allow us to get sometimes closed-form solutions, but more realistic models that capture better empirical distributions of prices can be used.</p>
<p>We can now use the theory of a rational risk-averse investor to compute the value of the premium. We consider that investors might be risk averse, meaning that they need to be compensated increasingly more to take extra risk. In chapter XXX we saw that such behaviour is described by utility functions. And since the derivative’s payoff is uncertain before the expiry, we need to compute expected utilities to characterize the value that the investor places on the contract. Using exponential utility, this means:</p>
<div class="math notranslate nohighlight">
\[ \mathbb{E}[U] = 1- \mathbb{E}[e^{-\gamma_i \left(e^{-r(T-t)}f(S_T)\right)}] \]</div>
<p>where <span class="math notranslate nohighlight">\(\gamma_i\)</span> is the risk aversion coefficient of the investor. We have discounted the payoff at <span class="math notranslate nohighlight">\(T\)</span> by the discount factor <span class="math notranslate nohighlight">\(e^{-r(T-t)}\)</span> in order to consider the opportunity cost of holding the cash in a deposit or money-market fund. For simplicity, we have considered the interest rate <span class="math notranslate nohighlight">\(r\)</span> as constant and determinist up to <span class="math notranslate nohighlight">\(T\)</span>, but the model can be extended to cover non-deterministic interest rates.</p>
<p>If the investor needs to pay (or be paid) a premium <span class="math notranslate nohighlight">\(P_t\)</span> to enter into the derivative’s contract today, the utility calculation changes, since it needs to take into account the premium:</p>
<div class="math notranslate nohighlight">
\[ \mathbb{E}[U] = 1- \mathbb{E}[e^{-\gamma_i \left(e^{-r(T-t)}f(S_T) -P_t\right)}] \]</div>
<p>When modelling rational risk-averse agents with utility functions, we model their decisions as those that maximize the expected utility. However, in this case this cannot be used to compute the premium, since naturally the premium that maximizes utility is <span class="math notranslate nohighlight">\(P_t = -\infty\)</span>!. The problem is, of course, that it does not take into account the utility maximization of the dealer selling the derivative, who would not enter into the contract at this premium. Of course, the same framework could be used to model the dealer’s payoff, which is the reverse from the investor, albeit with a different dealer’s risk aversion, <span class="math notranslate nohighlight">\(\gamma_d\)</span>:</p>
<div class="math notranslate nohighlight">
\[ \mathbb{E}[U] = 1- \mathbb{E}[e^{-\gamma_d \left(P_t - e^{-r(T-t)}f(S_T) \right)}] \]</div>
<p>but even introducing the dealer’s utility function, how could we compute the value of the premium?</p>
<p>For the answer, we need first to frame the problem in other terms: what is the maximum premium that the investor would be willing to pay to enter into the contract? Since the alternative to not entering into the contract implies a zero payoff with total certainty, whose expected utility in this framework is <span class="math notranslate nohighlight">\(\mathbb{E}[U_0] = 0\)</span>, we can argue that the investor would be willing to buy the derivative as far as the premium makes him/her better off, i.e. <span class="math notranslate nohighlight">\(E[U] &gt; 0\)</span>. For a value of the premium such that <span class="math notranslate nohighlight">\(\mathbb{E}[U] = 0 = \mathbb{E}[U_0]\)</span>, the investor is indifferent to buy or not buy. This value of the premium is called the <em>reservation price</em> or the <em>utility indifference price</em> of the investor. Of course the same computation could be done for the dealer, obtaining a different reservation price. An agreement will only happen if the maximum premium that the investor is willing to pay is above the minimum premium that the dealer is willing to receive.</p>
<p>Let us first see the problem from the dealer’s point of view. In real situations, it is typically the investor who comes to the dealer and request a price for the derivative. The minimum premium that the dealer would be willing to accept to provide the contract as a reference for derivatives pricing, i.e. the reservation price of the dealer, is the one that solves:</p>
<div class="math notranslate nohighlight">
\[ 1- \mathbb{E}[e^{-\gamma_d \left(P_t - e^{-r(T-t)}f(S_T) \right)}] = 0\]</div>
<p>We can now obtain a general expression for the premium:</p>
<div class="math notranslate nohighlight">
\[ P_t^d =  \frac{1}{\gamma_d} \log \mathbb{E}[e^{\gamma_d \left(e^{-r(T-t)}f(S_T)\right)}] = \frac{1}{\gamma_d} \log \int dS_T g(S_T) e^{\gamma_d \left(e^{-r(T-t)}f(S_T)\right)} \]</div>
<p>For those dealers that have zero risk aversion, i.e. they are <em>risk neutral</em>, by taking the limit <span class="math notranslate nohighlight">\(\gamma_d \rightarrow 0\)</span> we get:</p>
<div class="math notranslate nohighlight">
\[ P_{0,t} = \mathbb{E}[ e^{-r(T-t)}f(S_T)] = \int dS_T g(S_T) e^{-r(T-t)}f(S_T)\]</div>
<p>And for small, but positive risk aversion:</p>
<div class="math notranslate nohighlight">
\[ P_t^d = P_{0,t} +  \frac{\gamma_d}{2}\int dS_T g(S_T) e^{-2r(T-t)}f^2(S_T) + O(\gamma_d^2)\]</div>
<p>We can derive the same expression for a investor we get:</p>
<div class="math notranslate nohighlight">
\[ P_t^i =  -\frac{1}{\gamma_i} \log \mathbb{E}[e^{-\gamma_i \left(e^{-r(T-t)}f(S_T)\right)}] = -\frac{1}{\gamma_i} \log \int dS_T g(S_T) e^{-\gamma_i \left(e^{-r(T-t)}f(S_T)\right)} \]</div>
<p>If the investor has a small but positive risk aversion:</p>
<div class="math notranslate nohighlight">
\[ P_t^i = P_{0,t} - \frac{\gamma_i}{2}\int dS_T g(S_T) e^{-2r(T-t)}f^2(S_T) + O(\gamma_i^2)\]</div>
<p>We see immediately that <span class="math notranslate nohighlight">\(P_t^i \leq P_d^i\)</span>, so there is only agreement if both investor and dealer are risk neutral, or at least one is risk prone, which is not a normal situation. Therefore, according to this theory of pricing, there would not be trading of derivatives! However, we know empirically that it is not the case. So what was wrong in our theory? We will see that the dealer is not simply taking the opposite bet than the investor, and therefore we need to modify this analysis. Before that, though, let us see particular examples of the computation of the premium for investors.</p>
<section id="example-pricing-of-a-simple-contingent-claim">
<h4><span class="section-number">16.3.1.1. </span>Example: pricing of a simple contingent claim<a class="headerlink" href="#example-pricing-of-a-simple-contingent-claim" title="Permalink to this heading">#</a></h4>
<p>A contingent claim is a contract that pays off only under the realization of an uncertain event. Many derivatives contracts like options are contingent claims. The most simple contingent claim pays 1$ under the realization of a specific uncertain event, and zero in all other cases. These contingent claims are called Arrow-Debreu securities, and have a theoretical interest since we could in principle decompose any contingent claim as a linear combination of these securities. Therefore, if we know the prices (premiums) of Arrow-Debreu securities, we could price any contingent claim.</p>
<p>For our purposes, though, we just want to discuss a simple example of reservation prices. Let us consider a contingent claim in which the dealer pays the investor 1$ if we get heads when tossing a fair coin in the present. In our framework, the underlying now is the side of the coin, heads or tails, with probabilities <span class="math notranslate nohighlight">\(p_H = p_T = 1/2\)</span>. We also make <span class="math notranslate nohighlight">\(T = t\)</span> since we toss the coin in the present. The value of the reservation price for the investor reads then:</p>
<div class="math notranslate nohighlight">
\[ P_t^i = -\frac{1}{\gamma_i} \log \left(\frac{1}{2}e^{-\gamma_i} + \frac{1}{2} \right) = \frac{1}{2} - \frac{1}{\gamma_i}\log \cosh \left(\frac{\gamma_i}{2}\right)\]</div>
<p>For a risk-neutral investor, by making <span class="math notranslate nohighlight">\(\gamma_i \rightarrow 0\)</span>, we get simply <span class="math notranslate nohighlight">\(P_t^i = 1/2\)</span>, which makes sense: the investor is willing to pay 0.5$ to make the game <em>fair</em>. Or in other terms, to make the expected value of the game zero. A fully risk averse investor for whom <span class="math notranslate nohighlight">\(\gamma_i \rightarrow \infty\)</span> has <span class="math notranslate nohighlight">\(P_t = 0\)</span>, i.e. only is willing to buy the contract when there is guarantee of no losses under any scenario. In the middle, the premium lies between those two values: the investor will be willing to pay more than 0$ to trade, as far as the payoff is skewed in its favor.</p>
</section>
<section id="example-forward-on-a-non-dividend-paying-stock">
<h4><span class="section-number">16.3.1.2. </span>Example: Forward on a non-dividend paying stock<a class="headerlink" href="#example-forward-on-a-non-dividend-paying-stock" title="Permalink to this heading">#</a></h4>
<p>Let us now focus on a more realistic case and find the maximum premium that a risk averse investor would be willing to pay for a forward contract on a non-dividend paying stock <a class="footnote-reference brackets" href="#id5" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>. The buyer of a forward has the obligation to buy a stock at the expire <span class="math notranslate nohighlight">\(T\)</span> at a pre-agreed price <span class="math notranslate nohighlight">\(K\)</span>. Therefore, the payoff function reads:</p>
<div class="math notranslate nohighlight">
\[ f(S_T) = S_T - K\]</div>
<p>The maximum premium that the investor is willing to pay reads then:</p>
<div class="math notranslate nohighlight">
\[ P_t^i = - \frac{1}{\gamma_i} \log \int dS_T g(S_T) e^{-\gamma_i e^{-r(T-t)}(S_T-K)} \]</div>
<p>which in the case of a risk-neutral investor reduces to:</p>
<div class="math notranslate nohighlight">
\[ P_{0,t}^i = \int dS_T g(S_T) e^{-r(T-t)}(S_T-K) = e^{-r(T-t)}(E[S_T] - K) 
\]</div>
<p>i.e. the price is simply the discounted expected pay-off. The expectation represents the belief from the investor on the value of the stock at expiry, and it is model-free, i.e. we don’t need to specify a model for the evolution of the stock to compute the maximum premium, although of course an investor could be using a model to compute it. The value of the premium has the following dependencies:</p>
<ul class="simple">
<li><p>The larger the expected value of the stock at T, the more the investor is willing to pay for the forward</p></li>
<li><p>The larger the risk-free interest rate <span class="math notranslate nohighlight">\(r\)</span>, the lower the investor is willing to pay for the forward, since the present value of the payoff is reduced</p></li>
<li><p>The larger the strike, the less attractive is the forward purchase and therefore the less the investor is willing to pay for it.</p></li>
</ul>
</section>
<section id="example-european-call-options">
<h4><span class="section-number">16.3.1.3. </span>Example: European Call Options<a class="headerlink" href="#example-european-call-options" title="Permalink to this heading">#</a></h4>
<p>The calculation for a forward was relatively tractable since the payoff of the derivative was linear on the stock. What about non-linear payoffs? This is the case for instance of an European Call option on a stock, which has the payoff:</p>
<div class="math notranslate nohighlight">
\[ f(S_T) = (S_T - K)^+ \]</div>
<p>where <span class="math notranslate nohighlight">\(K\)</span> is the strike of the option. The risk-averse investor will be willing to pay the dealer a maximum premium of:</p>
<div class="math notranslate nohighlight">
\[ P_t^i = -\frac{1}{\gamma_i} \log \int dS_T g(S_T) e^{-\gamma_i e^{-r(T-t)}(S_T-K)^+} \]</div>
<p>In the limit of a risk-neutral investor, the premium is:</p>
<div class="math notranslate nohighlight">
\[ P_{0,t}^i = \int dS_T g(S_T) e^{-r(T-t)} (S_T-K)^+ \]</div>
<p>Let us consider the case of a non-dividend paying stock, which we model as Geometrical Brownian Motion to ensure non-negative prices are allowed:</p>
<div class="math notranslate nohighlight">
\[d S_t = \mu S_t dt + \sigma S_t d W_t\]</div>
<p>where <span class="math notranslate nohighlight">\(\mu\)</span> and <span class="math notranslate nohighlight">\(\sigma\)</span> are the drift and volatility of the stock, respectively, and <span class="math notranslate nohighlight">\(W_t\)</span> a Wiener process. Integrating this SDE up to T:</p>
<div class="math notranslate nohighlight">
\[ S_T = S_t e^{(\mu - \frac{\sigma^2}{2})(T-t) + \sigma \sqrt{T-t} Z} \]</div>
<p>where <span class="math notranslate nohighlight">\(Z \sim N(0,1)\)</span>. We can further decompose the expression of the premimum as:</p>
<div class="math notranslate nohighlight">
\[ P_{0,t}^i = \int_0^\infty dS_T g(S_T) e^{-r(T-t)}  (S_T-K)^+ = \int_K^\infty dS_T g(S_T) e^{-r(T-t)}  (S_T - K) \]</div>
<div class="math notranslate nohighlight">
\[= e^{-r(T-t)} \left(\int_K^\infty dS_T g(S_T) S_T - K \int_K^\infty dS_T g(S_T)\right) \]</div>
<p>Let us now change variables from <span class="math notranslate nohighlight">\(S_T\)</span> to <span class="math notranslate nohighlight">\(Z\)</span> in the integration. The first integral becomes:</p>
<div class="math notranslate nohighlight">
\[ \int_K^\infty dS_T g(S_T) S_T = S_t \int_{\frac{1}{\sigma \sqrt{T-t}} \left(\log \frac{K}{S_t} - (\mu - \frac{\sigma^2}{2})(T-t)\right)}^\infty \frac{dZ}{\sqrt{2\pi}} e^{-\frac{Z^2}{2}} e^{(\mu - \frac{\sigma^2}{2})(T-t) + \sigma \sqrt{T-t} Z}\]</div>
<div class="math notranslate nohighlight">
\[ = S_t e^{(\mu - \frac{\sigma^2}{2})(T-t)} \int_{-d_2(\mu)}^\infty \frac{dZ}{\sqrt{2\pi}} e^{-\frac{Z^2}{2}} e^{ \sigma \sqrt{T-t} Z} = S_t e^{\mu (T-t)} \int_{-d_2(\mu)-\sigma\sqrt{T-t}}^\infty \frac{dZ}{\sqrt{2\pi}} e^{-\frac{(Z-\sigma \sqrt{T-t})^2}{2}}\]</div>
<div class="math notranslate nohighlight">
\[ = S_t e^{\mu (T-t)} \left(1-N(-d_1(\mu))\right)\]</div>
<p>where we have defined the functions:</p>
<div class="math notranslate nohighlight">
\[d_1(\mu) = \frac{1}{\sigma \sqrt{T-t}} \left(\log \frac{S_t}{K} + (\mu - \frac{\sigma^2}{2})(T-t)\right) \]</div>
<div class="math notranslate nohighlight">
\[d_2(\mu) = \frac{1}{\sigma \sqrt{T-t}} \left(\log \frac{S_t}{K} + (\mu + \frac{\sigma^2}{2})(T-t)\right) \]</div>
<p>and <span class="math notranslate nohighlight">\(N(x)\)</span> is the cumulative distribution function of the standard normal distribution. The second integral is then:</p>
<div class="math notranslate nohighlight">
\[ \int_K^\infty dS_T g(S_T) = \int_{-d_2(\mu)}^\infty \frac{1}{\sqrt{2 \pi}} e^{-\frac{Z^2}{2}} = 1-N(-d_2(\mu))\]</div>
<p>Wrapping up all we get:</p>
<div class="math notranslate nohighlight">
\[P_{0,t}^i=S_t e^{(\mu-r)(T-t)}N(d_1(\mu))-K e^{-r(T-t)} N(d_2(\mu)) \]</div>
<p>where we have used the property <span class="math notranslate nohighlight">\(1-N(-x) = N(x)\)</span>. Let us analyze this formula, which recall is the maximum premium that a investor is willing to pay for the call option. It depends on the following parameters:</p>
<ul class="simple">
<li><p>Current stock price <span class="math notranslate nohighlight">\(S_t\)</span>: as the current stock price increases, the premium increases. This is because the call option gives the right to buy the stock at the strike price, so a higher current stock price makes this option more valuable.</p></li>
<li><p>Strike price <span class="math notranslate nohighlight">\(K\)</span>: as the strike price increases, the premium decreases. A higher strike price makes the option less valuable since it would cost more to exercise the option.</p></li>
<li><p>Time to maturity <span class="math notranslate nohighlight">\(T-t\)</span>: as the time to maturity increases, the premium  increases. More time to maturity means more opportunity for the stock price to move favorably.</p></li>
<li><p>Risk-free interest rate <span class="math notranslate nohighlight">\(r\)</span>: as the risk-free interest rate increases, the premium decreases. A higher risk-free rate reduces the present value of the option payoff, making the option less attractive.</p></li>
<li><p>Expected stock drift <span class="math notranslate nohighlight">\(\mu\)</span>: as the stock drift increases, the premium increases, since it is more likely that the option will be exercised.</p></li>
<li><p>Expected volatility <span class="math notranslate nohighlight">\(\sigma\)</span>: as volatility increases, the premium increases. Higher volatility increases the probability of the stock price moving significantly, which benefits the option holder.</p></li>
</ul>
<p>We plot those dependencies in the following picture:</p>
<figure class="align-default" id="fig-option-indifference-premium">
<a class="reference internal image-reference" href="../_images/option_indifference_premium.png"><img alt="../_images/option_indifference_premium.png" src="../_images/option_indifference_premium.png" style="width: 8in;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 16.1 </span><span class="caption-text">Dependencies of a call option premium for a risk neutral investor, derived as the maximum premium the investor is willing to pay (reservation or indifference price). We use the parameters <span class="math notranslate nohighlight">\(S_t=100\)</span>, <span class="math notranslate nohighlight">\(K =100\)</span>, <span class="math notranslate nohighlight">\(T-t = 1\)</span> in years, <span class="math notranslate nohighlight">\(r = 0.05\)</span>, <span class="math notranslate nohighlight">\(\mu = 0.1\)</span>, <span class="math notranslate nohighlight">\(\sigma = 0.2\)</span>.</span><a class="headerlink" href="#fig-option-indifference-premium" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
</section>
<section id="the-arbitrage-free-theory-of-derivatives-pricing">
<h3><span class="section-number">16.3.2. </span>The arbitrage-free theory of derivatives pricing<a class="headerlink" href="#the-arbitrage-free-theory-of-derivatives-pricing" title="Permalink to this heading">#</a></h3>
<p>When we were applying the utility indifference theory of derivatives pricing to both parties agreeing in the transaction, the investor and the dealer, we found the issue that according to this theory, there would be a trade only if both of them are risk averse, since they are taking opposite sides of the bet on the payoff result. In reality, both dealers are investors are generally risk-averse and we observe transactions, so what are we missing in our theory?</p>
<p>The answer, as we anticipated above, is that the dealer is not really simply taking the opposite of the bet. There are mainly two ways a dealer will conduct this business:</p>
<ul class="simple">
<li><p>If the market on derivatives is relatively liquid in both sides, with plenty of investors willing to take the long or short position in the derivative over periods much shorter than the expiry, the dealer will act as a market-maker of the derivatives. In this case, the dealer will quote bid and asks prices for the derivatives that compensate it for the provision of liquidity with its own capital, incurring potential inventory risk or information asymmetry risk</p></li>
<li><p>If the market is one-sided and / or illiquid, in the sense of having a small number of potential transactions before the expiry of the contract, the dealer will try to hedge the risk using other financial instruments available.</p></li>
<li><p>In practice, a combination of both situations will also happen often</p></li>
</ul>
<p>As we discussed in the first part of this chapter, if we are in the first situation, we might not need a derivatives pricing model since we can extract the prices of derivatives directly from observations of trades or request for quotes that are not closed. It is the second case where we need a theory of derivatives pricing that takes into account potential hedging strategies that mitigate the risk of the dealer. We anticipate then that in this framework, the minimum price or premium that the dealer will accept to sell the derivative will be one that compensates it for the costs of hedging plus the residual risk.</p>
<p>More interestingly, we will see that in some cases, under certain theoretical situations, a perfect hedging strategy might exist, so the minimum price will be exactly the cost of the hedging strategy, which in this setup is also called the perfect replication strategy (since a perfect hedging implies no risk, and therefore a replication of the payoff using other financial instruments). A consequence of the existence of such replication strategy is that dealers are forced to price derivatives consistently, otherwise they would be generating risk-free arbitrage opportunities where other dealers who price correctly the derivative trade with the one miss-pricing it, and pocket the difference without risk. Hence, this theory of derivatives pricing is also called the arbitrage-free theory of derivatives pricing.</p>
<p>Let us revisit the case of forwards and options under this optic.</p>
<section id="id2">
<h4><span class="section-number">16.3.2.1. </span>Example: Forward on a non-dividend paying stock<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h4>
<p>Under the modelling hypothesis used in the previous sections to value the premium of a forward, namely, that 1) the interest risk is locked during the period of the forward, 2) there is no counter-party risk, i.e. no risk that the investor will not satisfy its obligations, then there is actually a simple replication strategy that hedges all the risk of the contract. If the dealer is selling the forward to the investor, therefore guaranteeing a price <span class="math notranslate nohighlight">\(K\)</span> to buy a share at time <span class="math notranslate nohighlight">\(T\)</span>, then:</p>
<ul class="simple">
<li><p>Borrows <span class="math notranslate nohighlight">\(S_t\)</span> dollars in the repo monetary markets at interest rate <span class="math notranslate nohighlight">\(r\)</span> during the period of the forward. We assume that interest accrues daily but is settled at the expiry. The stock bought is used as collateral in the repo.</p></li>
<li><p>Buys the underlying stock with this money at inception, paying <span class="math notranslate nohighlight">\(S_t\)</span></p></li>
<li><p>At the expiry of the forward it delivers the stock to the investor, receives <span class="math notranslate nohighlight">\(K\)</span> and repays the loan plus remaining interests</p></li>
</ul>
<p>If we consider that daily accruing of interest can be well approximated by continuous accruing, then the investor needs to repay at <span class="math notranslate nohighlight">\(T\)</span> an amount <span class="math notranslate nohighlight">\(S_t e^{r(T-t)}\)</span>. The payoff for the dealer at the expiry is therefore:</p>
<div class="math notranslate nohighlight">
\[ K - S_t e^{r(T-t)}\]</div>
<p>which is deterministic under the hypotheses of the model. A rational dealer of course will not accept a determinist loss, so the minimum premium that will command for this contract is the discounted value of this payoff:</p>
<div class="math notranslate nohighlight">
\[P_{F,t} = K e^{-r(T-t)} - S_t\]</div>
<p>In practice, forward markets work by quoting the strike such that the premium is zero, hence:</p>
<div class="math notranslate nohighlight">
\[ F_t \equiv K = S_t e^{r(T-t)} \]</div>
<p>This is the arbitrage-free price of a forward contract. As mentioned above, it is called arbitrage-free since any other price would represent a risk-free arbitrage opportunity for other dealer. For example, let’s assume this dealer quotes a <span class="math notranslate nohighlight">\(\bar{K}_t &lt; K_t\)</span>. Another dealer could buy the forward from the dealer, and use the opposite replication strategy:</p>
<ul class="simple">
<li><p>Borrow the stock in repo and sell it in the market at price <span class="math notranslate nohighlight">\(S_t\)</span> to fund the repo.</p></li>
<li><p>At time <span class="math notranslate nohighlight">\(T\)</span> close the repo with the stock delivered by the dealer selling the forward, receive <span class="math notranslate nohighlight">\(S_t e^{r(T-t)}\)</span> in cash and pay <span class="math notranslate nohighlight">\(\bar{K}_t\)</span>.</p></li>
</ul>
<p>The payoff for this dealer is then:</p>
<div class="math notranslate nohighlight">
\[  S_t e^{r(T-t)} - \bar{K}_t &gt;  S_t e^{r(T-t)} - S_t e^{r(T-t)}  = 0\]</div>
<p>i.e. a risk-free profit!</p>
</section>
<section id="id3">
<h4><span class="section-number">16.3.2.2. </span>Example: European Call Options<a class="headerlink" href="#id3" title="Permalink to this heading">#</a></h4>
<p>In the case of options there is no such obvious static replication strategy if we are only allowed to use the underlying stock and repo contracts. By static replication strategy we mean that we don’t need to modify the positions of the replication portfolio (the stock and the repo) during the life of the forward. If we are able to trade other derivatives there is actually a static replication strategy. If the dealer sells the call option to an investor, then immediately</p>
<ul class="simple">
<li><p>Buys to other dealer a put option with the same strike and expiry</p></li>
<li><p>Buys to another dealer a forward with the same strike and expiry</p></li>
</ul>
<p>The payoff at the expiry is:</p>
<div class="math notranslate nohighlight">
\[ -(S_T-K)^+ + (K-S_T)^+ + (S_T-K) = 0 \]</div>
<p>meaning that the replication portfolio of a put and a forward replicates the call option. At inception, the dealer is paid for the call a premium <span class="math notranslate nohighlight">\(P_{C,t}\)</span> and pays <span class="math notranslate nohighlight">\(P_{P,t}\)</span> for the put and <span class="math notranslate nohighlight">\(P_{F,t}\)</span> for the forward, hence the payoff at inception is:</p>
<div class="math notranslate nohighlight">
\[P_{C,t} - P_{F,t} - P_{F,t}\]</div>
<p>In order to avoid losses, the minimum premium that must command is therefore:</p>
<div class="math notranslate nohighlight">
\[P_{C,t} = P_{F,t} + P_{F,t}\]</div>
<p>which is called the put-call parity relationship. The premium for the forward can be derived as discussed in the previous section, however we are left with a sort of chicken and the egg problem with regards to the call and put premiums: given one, we can determine the other, but we don’t have yet a replication strategy for the put to derive the call premium, and vice-versa.</p>
<p>If no static replication is available, is it possible to find a dynamical one that reproduces the payoff without uncertainty? Or are we left with strategies that, though they might minimize uncertainty, they don’t remove it and therefore we need to go back to our utility indifference theory?</p>
</section>
<section id="the-black-scholes-merton-model">
<h4><span class="section-number">16.3.2.3. </span>The Black - Scholes - Merton Model<a class="headerlink" href="#the-black-scholes-merton-model" title="Permalink to this heading">#</a></h4>
<p>Fisher Black and Myron Scholes [&#64;black1973pricing], and separately Robert Merton [&#64;merton1973theory] provided an answer to this question: under certain theoretical conditions, we can indeed find a dynamic replication strategy based on the underlying stock and a risk free account, that reproduces the payoff with no uncertainty. The main conditions are the following:</p>
<ul class="simple">
<li><p>The stock price follows a Geometric Brownian Motion dynamics:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[ d S_t = \mu S_t dt + \sigma S_t d W_t \]</div>
<div style="margin-left: 40px;">
We have considered the drift $\mu$ and volatility $\sigma$ constant, but the model can be generalized to time-dependent deterministic drifts and volatilities. Other dynamics can also be considered within the same framework. Also, we will consider a non-dividend paying stock, but the model can be adjusted to consider deterministic dividends. </div>
<ul class="simple">
<li><p>The replicating portfolio is composed of a position <span class="math notranslate nohighlight">\(\Delta_t\)</span> in the underlying stock and a cash account <span class="math notranslate nohighlight">\(\beta_t\)</span> from which we can borrow or lend money freely at a determinist risk-free rate <span class="math notranslate nohighlight">\(r\)</span>:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\Pi_t = \Delta_t S_t + \beta_t \]</div>
<div style="margin-left: 40px;"> The model can be generalized easily to time-dependent risk-free interest rates. The original model considers a generic cash account, although in practice is more realistic to assume a repo on the stock is used for funding. </div>
<ul class="simple">
<li><p>The position in the stock can be adjusted continuously over the life of the option, without restriction like market trading hours, etc. There are also no transaction costs when buying or selling the stock. There are no restrictions on shorting the stock.</p></li>
<li><p>The replication portfolio is self-financing, meaning that no cash is added or withdrawn from the portfolio after the initial investment. Any proceeds from selling at immediately reinvested in the portfolio.  Mathematically, it means that:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[ d\Pi_t = \Delta_t d S_t + d \beta_t = \Delta_t d S_t + r \beta_t dt = \Delta_t d S_t + r (\Pi_t - \Delta_t S_t) dt \]</div>
<div style="margin-left: 40px;"> Notice that the position in the stock depends on time, but is always adjusted ex-post, i.e. after the market moves. </div>
<ul class="simple">
<li><p>There is no counterparty default risk, i.e. the investor and the dealer will pay whatever obligations they have at the end of the option</p></li>
</ul>
<p>If the portfolio <span class="math notranslate nohighlight">\(\Pi_t\)</span> indeed replicates the option payoff at the maturity <span class="math notranslate nohighlight">\(T\)</span> in any scenario, we must have <span class="math notranslate nohighlight">\(\Pi_T = C_T = (S_T - K)^+\)</span>, where we have considered a Call option but the argument applies to any other payoff function. But since by construction the portfolio <span class="math notranslate nohighlight">\(\Pi_t\)</span> is self-financing, then if such dynamic strategy exists we must have <span class="math notranslate nohighlight">\(\Pi_t = C_t\)</span> for any time <span class="math notranslate nohighlight">\(t \leq T\)</span>. Otherwise, there would be a risk-free arbitrage opportunity, e.g. selling the option at price <span class="math notranslate nohighlight">\(C_t\)</span> in the case <span class="math notranslate nohighlight">\(C_t &gt; \Pi_t\)</span>, buying with the cash from the premium the replicating portfolio <span class="math notranslate nohighlight">\(\Pi_t\)</span> and making an instantaneous gain of the difference <span class="math notranslate nohighlight">\(C_t - \Pi_t\)</span>. The same reasoning applies <span class="math notranslate nohighlight">\(C_t &lt; \Pi_t\)</span>, only in this case we buy the option paying a discounted premium. Therefore, if we can find such strategy we immediately solve the problem of option pricing, since the premium is equal to the cost of replication by using the non-arbitrage opportunity argument.</p>
<p>The condition <span class="math notranslate nohighlight">\(\Pi_t = C_t\)</span> is equivalent to <span class="math notranslate nohighlight">\(\Pi_T = C_T\)</span> and <span class="math notranslate nohighlight">\(d \Pi_t = dC_t\)</span>. Additionally, this equality implies that <span class="math notranslate nohighlight">\(C_t = C(t, S_t)\)</span>, i.e. the premium of the option has to be a function of time and the contemporary value of the stock. We can then use Ito’s lemma to further understand the requirements for such strategy to exist:</p>
<div class="math notranslate nohighlight">
\[
d C_t = \frac{\partial C_t}{\partial t} dt + \frac{\partial C_t}{\partial S_t} dS_t + \frac{1}{2}\frac{\partial^2 C_t}{\partial^2 S_t} \sigma^2 S_t^2 dt = d\Pi_t = \Delta_t d S_t + r\beta_t dt
\]</div>
<p>Grouping the terms dependent on <span class="math notranslate nohighlight">\(dt\)</span> and <span class="math notranslate nohighlight">\(d S_t\)</span> separately we have:</p>
<div class="math notranslate nohighlight">
\[
\left(\frac{\partial C_t}{\partial t} + \frac{1}{2} \sigma^2 S_t^2 \frac{\partial^2 C_t}{\partial^2 S_t} +r\beta\right) dt  + \left(\frac{\partial C_t}{\partial S_t} - \Delta_t\right) dS_t = 0
\]</div>
<p>Since the equality must apply for any arbitrary <span class="math notranslate nohighlight">\(dt\)</span> and <span class="math notranslate nohighlight">\(dS_t\)</span>, each term in parenthesis must cancel separately. Starting with the right hand term we have:</p>
<div class="math notranslate nohighlight">
\[\Delta_t = \frac{\partial C_t}{\partial S_t} \]</div>
<p>which is call the delta-hedging condition, given its obvious connection with linear hedging strategies where we try to neutralize the exposure of a financial portfolio to a risk factor like the stock price in this case. Delta hedging the portfolio we ensure that its value is independent on the random dynamics of the stock, at least during an infinitesimal time. However, a strategy that delta-hedges at every time the portfolio is not necessarily self-financing, i.e. we might need to add extra cash during the life of the portfolio. The problem is that a priori the cash required for delta-hedging would depend on the path of the stock, making it a random variable. In that case the premium would also be a random quantity with a certain distribution.</p>
<p>In order to have a deterministic premium the portfolio has to be self-financing, which requires that the first term of the equality above is also zero, namely:</p>
<div class="math notranslate nohighlight">
\[ \frac{\partial C_t}{\partial t} + \frac{1}{2} \sigma^2 S_t^2 \frac{\partial^2 C_t}{\partial^2 S_t} + r S_t \frac{\partial C_t}{\partial S_t} = rC_t \]</div>
<p>where we have used the self-financing condition <span class="math notranslate nohighlight">\(\beta_t = \Pi_t - \Delta_t S_t = C_t - \frac{\partial C_t}{\partial S_t} S_t\)</span>. The resulting equation is the celebrated Black-Scholes-Merton (BSM) partial differential equation. Solving this equation with the terminal condition <span class="math notranslate nohighlight">\(C_T = (S_T - K)^+\)</span> allows us to compute the value of the premium for any time <span class="math notranslate nohighlight">\(t \leq T\)</span> deterministically. Therefore, by virtue of the replicating portfolio and non-arbitrage opportunity arguments, if the Black-Scholes-Merton conditions are satisfied the price of an option is no longer a random quantity as in the utility indifference framework.</p>
<p>Before discussing the solution to this equation, we can get another insight simply by inspecting it: the option premium does not depend on the drift <span class="math notranslate nohighlight">\(\mu\)</span> of the stock, only the volatility. In the utility indifference framework, the estimation of the drift plays a big role in the price that the investor is willing to pay for the option, since it affects the probability of exercising or not the option. However, for a dealer pricing the option, as far as the BSM framework holds, the directionality of the market is irrelevant since the strategy guarantees a replication of the payoff in any scenario by investing the premium into the BSM dynamic portfolio and implementing the dynamic strategy.</p>
</section>
<section id="solving-the-black-scholes-merton-equation">
<h4><span class="section-number">16.3.2.4. </span>Solving the Black-Scholes-Merton equation<a class="headerlink" href="#solving-the-black-scholes-merton-equation" title="Permalink to this heading">#</a></h4>
<p>There are different ways to solve the BSM equation. Most introductory textbooks on the topic (see for example [&#64;joshi2003concepts], [&#64;wilmott2007introduces]) follow the derivation used in the seminal paper that uses an ansatz for the solution that transforms the equation into the heat-equation, whose analytical solution is well-known [&#64;evans2010partial]. Here, we will take a different approach and use the Feynman - Kac theorem introduced in Chapter (#stochastic_calculus), section (#feynman_kac). Recall that the Feynman - Kac theorem provides a general solution to a family of partial differential equations in term of an expected value. In the interest of the reader we review it again here: the solution to the PDE</p>
<div class="math notranslate nohighlight">
\[\frac{\partial u}{\partial t} + \mu(x,t) \frac{\partial u}{\partial x} + \frac{1}{2} \sigma^2(x,t) \frac{\partial^2 u}{\partial x^2} - r(x,t)u = 0\]</div>
<p>with the boundary condition <span class="math notranslate nohighlight">\(u(x,T) = f(x)\)</span>, is the following expected value</p>
<div class="math notranslate nohighlight">
\[u(x,t) = \mathbb{E}\left[ e^{-\int_t^T r(X_s,s) ds} f(X_T) \Big| X_t = x \right]\]</div>
<p>where <span class="math notranslate nohighlight">\(X_t\)</span> satisfies the general stochastic differential equation:</p>
<div class="math notranslate nohighlight">
\[ d X_t = \mu(X_t, t) dt + \sigma(X_t, t) dW_t\]</div>
<p>The BSM equation is a specific case of this general PDE where <span class="math notranslate nohighlight">\(X_t \rightarrow S_t\)</span>, <span class="math notranslate nohighlight">\(u(x,t) \rightarrow C(s, t)\)</span>, <span class="math notranslate nohighlight">\(\mu(x,t) \rightarrow r\)</span>, <span class="math notranslate nohighlight">\(\sigma(x,t) \rightarrow \sigma\)</span>, <span class="math notranslate nohighlight">\(r(x,t) \rightarrow r\)</span>. The solution of the BSM equation can be expressed as:</p>
<div class="math notranslate nohighlight">
\[ C(s, t) = \mathbb{E}\left[ e^{-r(T-t)} (S_T - K)^+ \Big| S_t = s \right]\]</div>
<p>where <span class="math notranslate nohighlight">\(S_t\)</span> satisfies the SDE:</p>
<div class="math notranslate nohighlight">
\[ d S_t = r S_t dt + \sigma S_t dW_t\]</div>
<p>The first crucial observation is that the solution is remarkably close to the one analyzed in the context of utility indifference pricing for a risk-neutral investor, with one caveat: the expected value is taken with respect to a SDE for the stock price that has the drift <span class="math notranslate nohighlight">\(\mu\)</span> replaced by the risk-free interest <span class="math notranslate nohighlight">\(r\)</span>. In the former, the investor was taking the risk of the contract, but was indifferent to risk. In the latter, the dealer might be risk averse, but since the BSM dynamic hedging strategy neutralizes the risk (if the hypotheses are correct), there is no risk taken, only a deterministic cost to execute the hedging strategy, which is charged to the investor as the premium (plus potentially a margin for the service). In the jargon, the dealer prices the derivative as a risk-neutral investor if it computes probabilities in a different probability measure, where the drift is <span class="math notranslate nohighlight">\(r\)</span>. Such measure is usually called the risk-neutral measure. This framework for derivatives pricing can be generalized to other derivatives, allowing dealers to compute prices directly skipping the construction of the hedging portfolio and solving the PDE. It is appropriately referred as risk-neutral derivatives pricing.</p>
<p>From a financial point of view, though, it is convenient not to lose the connection to the dynamic hedging strategy, since the validity of this theory is linked to the validity of the hypotheses done to derive the PDE. If we are interested in introducing more realistic dynamics into the pricing, like non-continuous hedging and transaction costs, we need to start again from the point of view of the replication portfolio and the hedging strategy. When those hypotheses are relaxed, though, we come back to a probability distribution to characterize the premium of the option instead of a deterministic one, the latter being one of the main remarkable results of the BSM theory.</p>
<p>The computation of the expectation value for the option premium can be reused from the one done in the context of utility indifference pricing, simply by substituting <span class="math notranslate nohighlight">\(\mu \rightarrow r\)</span> in the expressions:</p>
<div class="math notranslate nohighlight">
\[C(S_t,t)= S_t N(d_1(\mu))-K e^{-r(T-t)} N(d_2(\mu)) \]</div>
<p>where:</p>
<div class="math notranslate nohighlight">
\[d_1(\mu) = \frac{1}{\sigma \sqrt{T-t}} \left(\log \frac{S_t}{K} + (r - \frac{\sigma^2}{2})(T-t)\right) \]</div>
<div class="math notranslate nohighlight">
\[d_2(\mu) = \frac{1}{\sigma \sqrt{T-t}} \left(\log \frac{S_t}{K} + (r + \frac{\sigma^2}{2})(T-t)\right) \]</div>
<p>This is the infamous Black-Scholes-Merton option pricing formula. It provides dealers with option prices that depend on</p>
<ul class="simple">
<li><p>the current stock price <span class="math notranslate nohighlight">\(S_t\)</span></p></li>
<li><p>the expected volatility of the stock <span class="math notranslate nohighlight">\(\sigma\)</span></p></li>
<li><p>the risk-free interest rate <span class="math notranslate nohighlight">\(r\)</span></p></li>
<li><p>the time to maturity <span class="math notranslate nohighlight">\(T-t\)</span></p></li>
<li><p>the option strike <span class="math notranslate nohighlight">\(K\)</span>.</p></li>
</ul>
<p>It does not depend on the stock drift <span class="math notranslate nohighlight">\(\mu\)</span>, i.e. the expected trend of the market. This is because in the BSM framework, the dealer uses the dynamic hedging strategy to make the portfolio risk-free and therefore shielded from any market trend.</p>
<p>Again, we must emphasize that despite the similarity with the risk-neutral option premium computed in the utility indifference framework, in the BSM framework the dealer is not computing the premium based on real probability scenarios of stock prices. The connection between replicating strategies and expectation values provided by the Feynman - Kac theorem is a useful mathematical result that simplifies the computation of derivatives premia in the BSM framework. But they shall not be interpreted in the sense of real probabilities (or probabilities in the real probability measure, as they are also referred to).</p>
<p>The dependencies of the option formula for a European call option with respect to the parameters are similar to the ones seen in the context of utility indifference pricing, with the exception of the dependence with respect to the risk-free interest rate <span class="math notranslate nohighlight">\(r\)</span>, whose role in the formula goes now beyond cash-flow discounting. In the following picture we compare the premia derived with BSM versus utility indifference pricing:</p>
<figure class="align-default" id="fig-bsm-vs-indifference-option">
<a class="reference internal image-reference" href="../_images/bsm_vs_indifference_option.png"><img alt="../_images/bsm_vs_indifference_option.png" src="../_images/bsm_vs_indifference_option.png" style="width: 8in;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 16.2 </span><span class="caption-text">Option price premium calculated using the utility indifference pricing versus arbitrage-free theory. The results are shown for an european call option with parameters <span class="math notranslate nohighlight">\(S_t=100\)</span>, <span class="math notranslate nohighlight">\(K =100\)</span>, <span class="math notranslate nohighlight">\(T-t = 1\)</span> in years, <span class="math notranslate nohighlight">\(r = 0.05\)</span>, <span class="math notranslate nohighlight">\(\mu = 0.1\)</span>, <span class="math notranslate nohighlight">\(\sigma = 0.2\)</span>.</span><a class="headerlink" href="#fig-bsm-vs-indifference-option" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>The first main differences is, as commented, the dependence with respect to the risk-free interest: in BSM theory, the premium is more valuable as interest rates increase, wheres in utility indifference pricing it was the other way around. In the latter, interest rates enter the formula to discount the value of future cash-flows. As interest rates grow, the opportunity cost of investing the premium for the future cash-flows of the options increases, since a risk-free deposit generates comparatively a larger yield. In other words, for an investor, the option becomes less attractive and is willing to pay less for it. However, in BSM theory used by dealers to price options, the opposite happens: bigger interest rates make funding the hedging strategy more costly, therefore requiring a larger compensation in terms of premium to execute the replication strategy.</p>
<p>The second big difference is of course the dependence with respect to the expected market drift, since in the BSM theory the premium is independent of it. The resulting plot is interesting because it points out to the resolution of the question of why are options traded in practice, assuming both dealers and investors have the same view of the market. As mentioned before, if both were to value the option as an investment, there would be no agreement on the premium to pay, since they hold opposite sides in the trade. However, if the dealer uses BSM theory there is room for agreement, at least for those investors whose expectations on market drifts make the premium requested by the dealer attractive. In the picture, such situation corresponds to those expected drifts that make the premium that an investor is willing to pay larger than the one commanded by the dealer.</p>
<p>From a classical Economics point of view, those frameworks fit well together to explain the derivatives market in terms of demand and supply. Demand for options is driven by investors looking to generate returns on investment, whereas supply comes from dealers that “fabricate” those options using replication strategies. The BSM premium is essentially the cost of “fabricating” the option, in analogy to the language used in the production of goods.</p>
</section>
<section id="an-alternative-derivation-the-market-price-of-risk">
<h4><span class="section-number">16.3.2.5. </span>An alternative derivation: the market price of risk<a class="headerlink" href="#an-alternative-derivation-the-market-price-of-risk" title="Permalink to this heading">#</a></h4>
<p>An alternative derivation of the BSM equation that can be helpful to gain intuition on the theory uses the financial concept of market price of risk. The market price of risk is essentially a Sharpe ratio, commonly used in the theory of investment. The Sharpe ratio computes the excess returns of an investment, i.e. the expected returns devoted fom the risk-free interest, over their risk defined as the volatility of the returns. For the stock that is the underlying of the option, and using continuos time, this is:</p>
<div class="math notranslate nohighlight">
\[\lambda_{S} = \frac{ \mathbb{E}[\frac{dS_t}{S_t}]- rdt}{\sqrt{Var[\frac{dS_t}{S_t}]}} = \frac{\mu_t - r}{\sigma}\sqrt{dt}\]</div>
<p>CHECK AND CITE REBONATO</p>
<p>We can now use Ito’s formula to compute the market price of risk of the option:</p>
<div class="math notranslate nohighlight">
\[\lambda_{C} = \frac{ \mathbb{E}[\frac{dC}{C}]- rdt}{\sqrt{Var[\frac{dC}{C}]}} = \frac{\frac{\partial C}{\partial t}+ \mu_t S_t\frac{\partial C}{\partial S_t}+\frac{1}{2}\sigma^2 S_t^2 \frac{\partial^2 C}{\partial S_t^2} - rC}{\sigma S_t \frac{\partial C}{\partial S_t}} \sqrt{dt}\]</div>
<p>We can now apply a different version of the arbitrage-free theory. Since the value of the option is essentially derived from the underlying stock, which the only risk factor affecting the option price in the BSM theory, then as investment opportunities both should have the same Sharpe ratio or market price of risk, i.e. <span class="math notranslate nohighlight">\(\lambda_S = \lambda_C\)</span>. Otherwise, investors would bid up the price of the one with the largest Sharpe ratio until both of them equalize. Applying this equality the terms proportional to the drift <span class="math notranslate nohighlight">\(\mu_t\)</span> cancel and we get back to the BSM differential equation.</p>
<p>One could of course have used the argument in reverse, reorganizing the BSM equation in terms of market prices of risk to prove that the equality of those is a consequence of the arbitrate-free argument used when building the replication portfolio.</p>
</section>
<section id="using-the-bsm-framework-in-practice">
<h4><span class="section-number">16.3.2.6. </span>Using the BSM framework in practice<a class="headerlink" href="#using-the-bsm-framework-in-practice" title="Permalink to this heading">#</a></h4>
<p>The Black - Scholes - Merton pricing theory supposed a change of paradigm for dealers creating liquidity in option markets. The theory allows for a consistent pricing of derivatives beyond options, providing not only a way to calculate the premium but a hedging strategy that neutralizes the risk of the derivative, or from a different angle, a recipe to synthesize those derivatives from liquid tradable instruments.</p>
<p>However, the BSM theory is based on multiple hypothesis that are not necessarily realistic, so the dealer needs to take into account how relevant is for the pricing and hedging of derivatives that those hypothesis are not consistent with reality. For instance:</p>
<ul class="simple">
<li><p>The BSM theory does not take into account liquidity and transaction costs of the hedging instruments, which will increase the costs of the replication strategy in a non-deterministic way. The premium becomes dependent on specific market microstructure details of how the instruments of the hedging portfolio are traded, for instance if they are traded in limit order book based markets, the fees of orders, the bid-ask spread, the tick size, etc. How the dealer executes those trades becomes also relevant, for instance, which types or orders are used, or if execution algorithms are to be used, in whose case the theory needs to incorporate an estimation of the cost of execution of those strategies, based on transaction cost analysis (TCA)</p></li>
<li><p>The BSM theory assumes continuous hedging, which is not feasible in practice, both because of the costs mentioned in the previous point, and because markets in financial instruments usually are not open 24 hours per day. Even when they do, liquidity tends to vary widely across trading hours. In practice, dealers tend to hedge less frequently (e.g. daily), deviating from the pure BSM paradigm</p></li>
<li><p>The BSM theory assumes a specific dynamics for the evolution of the underlyings, namely the Geometric Brownian Motion in the case of stocks (for underlyings that can become negative, like interest rates or inflation, a Brownian Motion is also typically used). Markets in practice follow more complicated dynamics, for instance they exhibit fatter tails in the distribution of returns or they might show sudden jumps, particularly in the overnight gap <a class="footnote-reference brackets" href="#id6" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>.</p></li>
<li><p>The original BSM theory assumes hedging strategies based on the underlying. The theory can be applied equally if we assume hedging with other derivatives as far as they share the same underlyings, or in a more fundamental level, the same risk factors driving the underlyings. In practice, dealers might use liquid derivatives to hedge non-liquid ones. For instance, european options with non-standard strikes or maturities with respect to liquid ones traded in exchanges. As an exercise for the reader, we propose to prove that the Black-Scholes-Merton differential equation can be derived using a hedging portfolio where instead of the underlying we trade another option with a different strike.</p></li>
</ul>
<p>In general, these deviations from the assumptions make the premium no longer deterministic, since they introduce uncertainty in its estimation. Dealers typically will need to estimate how much do they need to increase the BSM premium to compensate for those risks. In the following plots we show the histogram of differences between the replication portfolio and the option payoff at maturity, when different assumptions of Black - Scholes - Merton theory are violated, namely:</p>
<ul class="simple">
<li><p>Continuous re-hedging, which can be violated by using increasingly smaller frequencies of re-hedging</p></li>
<li><p>BSM volatility (the one used in the BSM pricing and hedging formulae) equals to market realized volatility</p></li>
<li><p>Lognormal stock dynamics, which can be challenged using a different dynamics like for instance the Heston model, which considers that volatility of the log-normal process is also stochastic, with its variance (volatility squared) following a CIR mean-reverting process:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\begin{split}d S_t = \mu S_t dt + \sqrt{V_t} S_t dW_{1,t} \\
d V_t = \kappa (\theta - V_t) + \chi \sqrt{V_t} dW_{2,t} \\
 \mathbb{E}\left[dW_{1,t}dW_{2,t}\right] = \rho dt \end{split}\]</div>
<ul class="simple">
<li><p>Zero transaction costs, which can be violated for instance by assuming the dealer pays the half bid-ask spread of the market every time the underlying is bought or sold when rebalancing the portfolio.</p></li>
</ul>
<figure class="align-default" id="fig-bsmreal">
<a class="reference internal image-reference" href="../_images/BSMreal.png"><img alt="../_images/BSMreal.png" src="../_images/BSMreal.png" style="width: 8in;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 16.3 </span><span class="caption-text">Histograms showing the difference between the replication portfolio using the BSM dynamic hedging strategy, and the actual payoff of an European call option. Each plot shows the impact of violating a different hypothesis of the BSM theory. We run 10000 simulations for each case. We use the parameters <span class="math notranslate nohighlight">\(S_t=100\)</span>, <span class="math notranslate nohighlight">\(K =100\)</span>, <span class="math notranslate nohighlight">\(T-t = 1\)</span> in years, <span class="math notranslate nohighlight">\(r = 0.05\)</span>, <span class="math notranslate nohighlight">\(\mu = 0.1\)</span>, <span class="math notranslate nohighlight">\(\sigma = 0.2\)</span> for the baseline scenario where we expect close to perfect replication when re-hedging continuously. To test the effect of different realized volatilities we use use <span class="math notranslate nohighlight">\(\sigma = 0.19\)</span> and <span class="math notranslate nohighlight">\(\sigma = 0.21\)</span>, respectively. To test the effect of transaction cost we add a constant bid-ask half-spread of 0.005%. To test the effect of a different market dynamics we use a Heston model with parameters <span class="math notranslate nohighlight">\(\kappa = 20\)</span> (mean reversion rate of the volatility squared), <span class="math notranslate nohighlight">\(\theta = 0.04\)</span> (long-term volatility squared mean), <span class="math notranslate nohighlight">\(\xi = 0.2\)</span> (volatility of volatility squared), <span class="math notranslate nohighlight">\(\rho = -0.7\)</span> (correlation between stock and stochastic volatility risk factors).</span><a class="headerlink" href="#fig-bsmreal" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>In the plots, we can see the different impacts that the violations produce on the distribution of the residuals. Whereas a less frequent re-hedging increases the dispersion of the residual, those are still unbiased and symmetrical. Other violations produce skewed distributions with non-zero mean. When introducing transaction costs, residuals have a negative mean, meaning that the BSM premium is insufficient to cover the actual costs of replication, as expected since the BSM derivation does not take into account such transaction costs. The effect of a different dynamics for the underlying is more nuanced: depending on the actual process, the distribution of residuals might have positive or negative mean, meaning that the BSM premium over-estimates or under-estimates, respectively, the costs of replication. For instance, if the realized volatility is lower than the one used for pricing and hedging in the BSM model, the mean of the residual is positive. This is, again, intuitive, since as we seen the premium of the option increases with volatility, so overestimating it means charging a larger premium than necessary for replication. Notice that this is not necessarily good for a dealer in competition, since if other dealers have a better estimation of market volatilities, they will be able to offer more competitive prices to clients and close more deals.</p>
</section>
</section>
</section>
<section id="exercises">
<h2><span class="section-number">16.4. </span>Exercises<a class="headerlink" href="#exercises" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Derive the Black-Scholes-Merton differential equation by using the portfolio replication argument for a dealer that hedges the risk of an european option (call or put) with strike <span class="math notranslate nohighlight">\(K_1\)</span> and maturity <span class="math notranslate nohighlight">\(T\)</span>, using another (liquid) option tradable in the market with strike <span class="math notranslate nohighlight">\(K_2\)</span> and same maturity <span class="math notranslate nohighlight">\(T\)</span>. As in the original BSM derivation, the dealer uses a cash account to remunerate cash positions or borrow cash. Formally, the replication or hedging portfolio is <span class="math notranslate nohighlight">\(\Pi_t = \Delta_t C_2(S_t, t) + \beta_t\)</span>, with the terminal condition <span class="math notranslate nohighlight">\(\Pi_T = C_1(S_T, T)\)</span>. Hint: link the result with the market price of risk for options introduced in this chapter.</p></li>
</ul>
<hr class="footnotes docutils" />
<aside class="footnote brackets" id="id5" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>We consider non-dividend paying stocks for simplicity, the extension of the theory to dividend paying stocks is relatively straightforward</p>
</aside>
<aside class="footnote brackets" id="id6" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">2</a><span class="fn-bracket">]</span></span>
<p>A well-known historical short-coming of the BSM framework is the implication that european options on the same underlying with different strikes and maturities should have the same implied volatility, equal to the expected volatility of the stock. The implied volatility is the one obtained by inverting the BSM formula given prices observed in the market, assuming for instance that there is a set of standard options that are traded in an exchange. In the first years of application of the BSM theory to price options, around the 1980s, this had the consequence of having very small premiums for options, particularly put options, with strikes very deep out-the-money (i.e. far from the underlying price at the time of quoting). This was a consequence of a Gaussian assumption on price returns, that predicted a very low probability of such options being exercised. In 1989, such prediction was contradicted when the market dramatically crashed, forcing dealers to readjust the prices with respect to the BSM formula. Multiple models such as local or stochastic volatility models, or models with jumps in the dynamics, have been proposed later to address these issues. One point to bear in mind is that the logic applied in the BSM framework can be still applied when introducing these more complex dynamics, and deterministic premiums can be derived as far as we add extra instruments in the hedging portfolio that allows the dealer to neutralize those risks (stochastic volatility, jumps, etc)</p>
</aside>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./markdown"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="market_making_fundamentals.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">15. </span>Market Making fundamentals</p>
      </div>
    </a>
    <a class="right-next"
       href="liquidity_modelling.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">17. </span>Liquidity modelling</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">16.1. Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pricing-of-flow-products">16.2. Pricing of flow products</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-kalman-filter-model-for-pricing">16.2.1. The Kalman Filter model for pricing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#a-simple-pricing-model">16.2.1.1. A simple pricing model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#estimation-of-the-simple-pricing-model">16.2.1.2. Estimation of the simple pricing model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#inference-on-the-simple-pricing-model">16.2.1.3. Inference on the simple pricing model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#two-correlated-instruments">16.2.1.4. Two correlated instruments</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pricing-sources-and-models">16.2.2. Pricing sources and models</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#lob-traded">16.2.2.1. LOB traded</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#rfq-traded">16.2.2.2. RfQ traded</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#composites">16.2.2.2.1. Composites</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#rfqs">16.2.2.2.2. RfQs</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#trades">16.2.2.2.3. Trades</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#hitmiss">16.2.2.2.4. HitMiss</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#correlated-instruments">16.2.2.3. Correlated instruments</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#derivatives-pricing">16.3. Derivatives pricing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-utility-indifference-theory-of-derivatives-pricing">16.3.1. The utility indifference theory of derivatives pricing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-pricing-of-a-simple-contingent-claim">16.3.1.1. Example: pricing of a simple contingent claim</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-forward-on-a-non-dividend-paying-stock">16.3.1.2. Example: Forward on a non-dividend paying stock</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-european-call-options">16.3.1.3. Example: European Call Options</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-arbitrage-free-theory-of-derivatives-pricing">16.3.2. The arbitrage-free theory of derivatives pricing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">16.3.2.1. Example: Forward on a non-dividend paying stock</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">16.3.2.2. Example: European Call Options</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-black-scholes-merton-model">16.3.2.3. The Black - Scholes - Merton Model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-the-black-scholes-merton-equation">16.3.2.4. Solving the Black-Scholes-Merton equation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#an-alternative-derivation-the-market-price-of-risk">16.3.2.5. An alternative derivation: the market price of risk</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-bsm-framework-in-practice">16.3.2.6. Using the BSM framework in practice</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">16.4. Exercises</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Javier Sabio González
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>