<!DOCTYPE html><html lang="en" class="" style="scroll-padding:60px"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Fair Price Estimation - Advanced Analytics and Algorithmic Trading</title><meta property="og:title" content="Fair Price Estimation - Advanced Analytics and Algorithmic Trading"/><meta name="generator" content="mystmd"/><meta name="keywords" content=""/><meta name="image" content="/build/cover-09caa9dd03fd74a2e96de11fa5332265.jpg"/><meta property="og:image" content="/build/cover-09caa9dd03fd74a2e96de11fa5332265.jpg"/><link rel="stylesheet" href="/build/_assets/app-AIT5GAEP.css"/><link rel="stylesheet" href="/build/_assets/thebe-core-VKVHG5VY.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jupyter-matplotlib@0.11.3/css/mpl_widget.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css" integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ" crossorigin="anonymous"/><link rel="icon" href="/favicon.ico"/><link rel="stylesheet" href="/myst-theme.css"/><script>
  const savedTheme = localStorage.getItem("myst:theme");
  const theme = window.matchMedia("(prefers-color-scheme: light)").matches ? 'light' : 'dark';
  const classes = document.documentElement.classList;
  const hasAnyTheme = classes.contains('light') || classes.contains('dark');
  if (!hasAnyTheme) classes.add(savedTheme ?? theme);
</script></head><body class="m-0 transition-colors duration-500 bg-white dark:bg-stone-900"><div class="myst-skip-to-article fixed top-1 left-1 h-[0px] w-[0px] focus-within:z-40 focus-within:h-auto focus-within:w-auto bg-white overflow-hidden focus-within:p-2 focus-within:ring-1" aria-label="skip to content options"><a href="#skip-to-frontmatter" class="myst-skip-to-link block px-2 py-1 text-black underline">Skip to article frontmatter</a><a href="#skip-to-article" class="myst-skip-to-link block px-2 py-1 text-black underline">Skip to article content</a></div><dialog id="myst-no-css" style="position:fixed;left:0px;top:0px;width:100vw;height:100vh;font-size:4rem;padding:1rem;color:black;background:white"><strong>Site not loading correctly?</strong><p>This may be due to an incorrect <code>BASE_URL</code> configuration. See<!-- --> <a href="https://mystmd.org/guide/deployment#deploy-base-url">the MyST Documentation</a> <!-- -->for reference.</p><script>
    (() => {
            // Test for has-styling variable set by the MyST stylesheet
            const node = document.currentScript.parentNode;
            const hasCSS = window.getComputedStyle(node).getPropertyValue("--has-styling");
            if (hasCSS === ""){
                    node.showModal();
            }

    })()
</script></dialog><div class="myst-top-nav bg-white/80 backdrop-blur dark:bg-stone-900/80 shadow dark:shadow-stone-700 p-3 md:px-8 sticky w-screen top-0 z-30 h-[60px]"><nav class="myst-top-nav-bar flex items-center justify-between flex-nowrap max-w-[1440px] mx-auto"><div class="flex flex-row xl:min-w-[19.5rem] mr-2 sm:mr-7 justify-start items-center shrink-0"><div class="block xl:hidden"><button class="myst-top-nav-menu-button flex items-center justify-center border-stone-400 text-stone-800 hover:text-stone-900 dark:text-stone-200 hover:dark:text-stone-100 w-10 h-10"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" width="1.5rem" height="1.5rem"><path fill-rule="evenodd" d="M3 6.75A.75.75 0 0 1 3.75 6h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 6.75ZM3 12a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 12Zm0 5.25a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd"></path></svg><span class="sr-only">Open Menu</span></button></div><a class="myst-home-link flex items-center ml-3 dark:text-white w-fit md:ml-5 xl:ml-7" href="/"><span class="text-md sm:text-xl tracking-tight sm:mr-5">Made with MyST</span></a></div><div class="flex items-center flex-grow w-auto"><div class="flex-grow hidden text-md lg:block"></div><div class="flex-grow block"></div><button type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-:R75cp:" data-state="closed" class="myst-search-bar flex items-center h-10 aspect-square sm:w-64 text-left text-gray-600 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 myst-search-bar-disabled hover:ring-blue-500 dark:hover:ring-blue-500 hover:border-blue-500 dark:hover:border-blue-500"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="p-2.5 h-10 w-10 aspect-square"><path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z" clip-rule="evenodd"></path></svg><span class="myst-search-text-placeholder hidden sm:block grow">Search</span><div aria-hidden="true" class="myst-search-shortcut items-center hidden mx-1 font-mono text-sm text-gray-600 sm:flex gap-x-1"><kbd class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-[0px_2px_0px_0px_rgba(0,0,0,0.08)] dark:shadow-none hide-mac">CTRL</kbd><kbd class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-[0px_2px_0px_0px_rgba(0,0,0,0.08)] dark:shadow-none show-mac">⌘</kbd><kbd class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-[0px_2px_0px_0px_rgba(0,0,0,0.08)] dark:shadow-none ">K</kbd><script>
;(() => {
const script = document.currentScript;
const root = script.parentElement;

const isMac = /mac/i.test(
      window.navigator.userAgentData?.platform ?? window.navigator.userAgent,
    );
root.querySelectorAll(".hide-mac").forEach(node => {node.classList.add(isMac ? "hidden" : "block")});
root.querySelectorAll(".show-mac").forEach(node => {node.classList.add(!isMac ? "hidden" : "block")});
})()</script></div></button><button class="myst-theme-button theme rounded-full aspect-square border border-stone-700 dark:border-white hover:bg-neutral-100 border-solid overflow-hidden text-stone-700 dark:text-white hover:text-stone-500 dark:hover:text-neutral-800 w-10 h-10 mx-3" title="Toggle theme between light and dark mode" aria-label="Toggle theme between light and dark mode"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="myst-theme-moon-icon h-full w-full p-0.5 hidden dark:block"><path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 0 1 .162.819A8.97 8.97 0 0 0 9 6a9 9 0 0 0 9 9 8.97 8.97 0 0 0 3.463-.69.75.75 0 0 1 .981.98 10.503 10.503 0 0 1-9.694 6.46c-5.799 0-10.5-4.7-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 0 1 .818.162Z" clip-rule="evenodd"></path></svg><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="myst-theme-sun-icon h-full w-full p-0.5 dark:hidden"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z"></path></svg></button><div class="block sm:hidden"><div class="myst-action-menu relative" data-headlessui-state=""><div><button class="myst-action-menu-button flex text-sm bg-transparent rounded-full focus:outline-none" id="headlessui-menu-button-:Rr5cp:" type="button" aria-haspopup="menu" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Open Menu</span><div class="flex items-center text-stone-200 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" width="2rem" height="2rem" class="p-1"><path fill-rule="evenodd" d="M10.5 6a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0Zm0 6a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0Zm0 6a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0Z" clip-rule="evenodd"></path></svg></div></button></div></div></div><div class="hidden sm:block"><a href="https://www.datasciencealgotrading.com" target="_blank" rel="noopener noreferrer" class="inline-block px-4 py-2 mx-1 mt-0 leading-none border rounded text-md border-stone-700 dark:border-white text-stone-700 dark:text-white hover:text-stone-500 dark:hover:text-neutral-800 hover:bg-neutral-100">Data Science Algo Trading</a></div></div></nav></div><div class="myst-primary-sidebar fixed xl:article-grid grid-gap xl:w-screen xl:pointer-events-none overflow-auto max-xl:min-w-[300px] hidden z-10" style="top:60px"><div class="myst-primary-sidebar-pointer pointer-events-auto xl:col-margin-left flex-col overflow-hidden hidden xl:flex"><div class="myst-primary-sidebar-nav flex-grow py-6 overflow-y-auto primary-scrollbar"><nav aria-label="Navigation" class="myst-primary-sidebar-topnav overflow-y-hidden transition-opacity ml-3 xl:ml-0 mr-3 max-w-[350px] lg:hidden"><div class="w-full px-1 dark:text-white font-medium"></div></nav><div class="my-3 border-b-2 lg:hidden"></div><nav aria-label="Table of Contents" class="myst-primary-sidebar-toc flex-grow overflow-y-hidden transition-opacity ml-3 xl:ml-0 mr-3 max-w-[350px]"><div class="myst-toc w-full px-1 dark:text-white"><a title="Advanced Analytics and Algorithmic Trading" class="block break-words focus:outline outline-blue-200 outline-2 rounded myst-toc-item p-2 my-1 rounded-lg hover:bg-slate-300/30 font-bold" href="/">Advanced Analytics and Algorithmic Trading</a><div data-state="closed" class="w-full"><div class="myst-toc-item flex flex-row w-full gap-2 px-2 my-1 text-left rounded-lg outline-none hover:bg-slate-300/30"><div title="Introduction" class="block break-words rounded py-2 grow cursor-pointer">Introduction</div><button class="self-center flex-none rounded-md group hover:bg-slate-300/30 focus:outline outline-blue-200 outline-2" aria-label="Open Folder" type="button" aria-controls="radix-:Rmpsp:" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="transition-transform duration-300 group-data-[state=open]:rotate-90 text-text-slate-700 dark:text-slate-100" height="1.5rem" width="1.5rem"><path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd"></path></svg></button></div><div data-state="closed" id="radix-:Rmpsp:" hidden="" class="pl-3 pr-[2px] collapsible-content"></div></div><div data-state="closed" class="w-full"><div class="myst-toc-item flex flex-row w-full gap-2 px-2 my-1 text-left rounded-lg outline-none hover:bg-slate-300/30"><div title="Financial Markets Fundamentals" class="block break-words rounded py-2 grow cursor-pointer">Financial Markets Fundamentals</div><button class="self-center flex-none rounded-md group hover:bg-slate-300/30 focus:outline outline-blue-200 outline-2" aria-label="Open Folder" type="button" aria-controls="radix-:Rupsp:" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="transition-transform duration-300 group-data-[state=open]:rotate-90 text-text-slate-700 dark:text-slate-100" height="1.5rem" width="1.5rem"><path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd"></path></svg></button></div><div data-state="closed" id="radix-:Rupsp:" hidden="" class="pl-3 pr-[2px] collapsible-content"></div></div><div data-state="closed" class="w-full"><div class="myst-toc-item flex flex-row w-full gap-2 px-2 my-1 text-left rounded-lg outline-none hover:bg-slate-300/30"><div title="Financial Modelling Fundamentals" class="block break-words rounded py-2 grow cursor-pointer">Financial Modelling Fundamentals</div><button class="self-center flex-none rounded-md group hover:bg-slate-300/30 focus:outline outline-blue-200 outline-2" aria-label="Open Folder" type="button" aria-controls="radix-:R16psp:" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="transition-transform duration-300 group-data-[state=open]:rotate-90 text-text-slate-700 dark:text-slate-100" height="1.5rem" width="1.5rem"><path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd"></path></svg></button></div><div data-state="closed" id="radix-:R16psp:" hidden="" class="pl-3 pr-[2px] collapsible-content"></div></div><div data-state="closed" class="w-full"><div class="myst-toc-item flex flex-row w-full gap-2 px-2 my-1 text-left rounded-lg outline-none hover:bg-slate-300/30"><div title="Execution Algorithms" class="block break-words rounded py-2 grow cursor-pointer">Execution Algorithms</div><button class="self-center flex-none rounded-md group hover:bg-slate-300/30 focus:outline outline-blue-200 outline-2" aria-label="Open Folder" type="button" aria-controls="radix-:R1epsp:" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="transition-transform duration-300 group-data-[state=open]:rotate-90 text-text-slate-700 dark:text-slate-100" height="1.5rem" width="1.5rem"><path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd"></path></svg></button></div><div data-state="closed" id="radix-:R1epsp:" hidden="" class="pl-3 pr-[2px] collapsible-content"></div></div><div data-state="closed" class="w-full"><div class="myst-toc-item flex flex-row w-full gap-2 px-2 my-1 text-left rounded-lg outline-none hover:bg-slate-300/30"><div title="Market Making Algorithms" class="block break-words rounded py-2 grow cursor-pointer">Market Making Algorithms</div><button class="self-center flex-none rounded-md group hover:bg-slate-300/30 focus:outline outline-blue-200 outline-2" aria-label="Open Folder" type="button" aria-controls="radix-:R1mpsp:" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="transition-transform duration-300 group-data-[state=open]:rotate-90 text-text-slate-700 dark:text-slate-100" height="1.5rem" width="1.5rem"><path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd"></path></svg></button></div><div data-state="closed" id="radix-:R1mpsp:" hidden="" class="pl-3 pr-[2px] collapsible-content"></div></div><div data-state="closed" class="w-full"><div class="myst-toc-item flex flex-row w-full gap-2 px-2 my-1 text-left rounded-lg outline-none hover:bg-slate-300/30"><div title="Investment Algorithms" class="block break-words rounded py-2 grow cursor-pointer">Investment Algorithms</div><button class="self-center flex-none rounded-md group hover:bg-slate-300/30 focus:outline outline-blue-200 outline-2" aria-label="Open Folder" type="button" aria-controls="radix-:R1upsp:" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="transition-transform duration-300 group-data-[state=open]:rotate-90 text-text-slate-700 dark:text-slate-100" height="1.5rem" width="1.5rem"><path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd"></path></svg></button></div><div data-state="closed" id="radix-:R1upsp:" hidden="" class="pl-3 pr-[2px] collapsible-content"></div></div><div data-state="closed" class="w-full"><div class="myst-toc-item flex flex-row w-full gap-2 px-2 my-1 text-left rounded-lg outline-none hover:bg-slate-300/30"><div title="Glossary and References" class="block break-words rounded py-2 grow cursor-pointer">Glossary and References</div><button class="self-center flex-none rounded-md group hover:bg-slate-300/30 focus:outline outline-blue-200 outline-2" aria-label="Open Folder" type="button" aria-controls="radix-:R26psp:" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="transition-transform duration-300 group-data-[state=open]:rotate-90 text-text-slate-700 dark:text-slate-100" height="1.5rem" width="1.5rem"><path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd"></path></svg></button></div><div data-state="closed" id="radix-:R26psp:" hidden="" class="pl-3 pr-[2px] collapsible-content"></div></div><div data-state="open" class="w-full"><div class="myst-toc-item flex flex-row w-full gap-2 px-2 my-1 text-left rounded-lg outline-none hover:bg-slate-300/30"><div title="Notebooks" class="block break-words rounded py-2 grow font-semibold text-blue-800 dark:text-blue-200 cursor-pointer">Notebooks</div><button class="self-center flex-none rounded-md group hover:bg-slate-300/30 focus:outline outline-blue-200 outline-2" aria-label="Open Folder" type="button" aria-controls="radix-:R2epsp:" aria-expanded="true" data-state="open"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="transition-transform duration-300 group-data-[state=open]:rotate-90 text-text-slate-700 dark:text-slate-100" height="1.5rem" width="1.5rem"><path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd"></path></svg></button></div><div data-state="open" id="radix-:R2epsp:" class="pl-3 pr-[2px] collapsible-content"><a title="Stochastic Calculus" class="block break-words focus:outline outline-blue-200 outline-2 rounded myst-toc-item p-2 my-1 rounded-lg hover:bg-slate-300/30" href="/notebooks/stochastic-calculus">Stochastic Calculus</a><a title="Bayesian Modelling" class="block break-words focus:outline outline-blue-200 outline-2 rounded myst-toc-item p-2 my-1 rounded-lg hover:bg-slate-300/30" href="/notebooks/bayesian-theory">Bayesian Modelling</a><a title="Market Microstructure" class="block break-words focus:outline outline-blue-200 outline-2 rounded myst-toc-item p-2 my-1 rounded-lg hover:bg-slate-300/30" href="/notebooks/market-microstructure">Market Microstructure</a><a title="Modelling RfQs in Dealer to Client Markets" class="block break-words focus:outline outline-blue-200 outline-2 rounded myst-toc-item p-2 my-1 rounded-lg hover:bg-slate-300/30" href="/notebooks/rfq-models">Modelling RfQs in Dealer to Client Markets</a><a title="Fair Price Estimation" aria-current="page" class="block break-words focus:outline outline-blue-200 outline-2 rounded myst-toc-item p-2 my-1 rounded-lg myst-toc-item-exact bg-blue-300/30 active" href="/notebooks/fair-price-estimation">Fair Price Estimation</a></div></div></div></nav></div><div class="myst-primary-sidebar-footer flex-none py-6 transition-all duration-700 translate-y-6 opacity-0"><a class="myst-made-with-myst flex mx-auto text-gray-700 w-fit hover:text-blue-700 dark:text-gray-200 dark:hover:text-blue-400" href="https://mystmd.org/made-with-myst" target="_blank" rel="noreferrer"><svg style="width:24px;height:24px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" stroke="none"><g id="icon"><path fill="currentColor" d="M23.8,54.8v-3.6l4.7-0.8V17.5l-4.7-0.8V13H36l13.4,31.7h0.2l13-31.7h12.6v3.6l-4.7,0.8v32.9l4.7,0.8v3.6h-15
          v-3.6l4.9-0.8V20.8H65L51.4,53.3h-3.8l-14-32.5h-0.1l0.2,17.4v12.1l5,0.8v3.6H23.8z"></path><path fill="#F37726" d="M47,86.9c0-5.9-3.4-8.8-10.1-8.8h-8.4c-5.2,0-9.4-1.3-12.5-3.8c-3.1-2.5-5.4-6.2-6.8-11l4.8-1.6
          c1.8,5.6,6.4,8.6,13.8,8.8h9.2c6.4,0,10.8,2.5,13.1,7.5c2.3-5,6.7-7.5,13.1-7.5h8.4c7.8,0,12.7-2.9,14.6-8.7l4.8,1.6
          c-1.4,4.9-3.6,8.6-6.8,11.1c-3.1,2.5-7.3,3.7-12.4,3.8H63c-6.7,0-10,2.9-10,8.8"></path></g></svg><span class="self-center ml-2 text-sm">Made with MyST</span></a></div></div></div><main class="article-grid grid-gap"><article class="article-grid subgrid-gap col-screen article content"><div class="hidden"></div><div id="skip-to-frontmatter" aria-label="article frontmatter" class="myst-fm-block mb-8 pt-9"><div class="myst-fm-block-header flex items-center mb-5 h-6 text-sm font-light"><div class="flex-grow"></div><div class="myst-fm-block-badges"><a href="https://github.com/xaviweise/aaat" title="GitHub Repository: xaviweise/aaat" target="_blank" rel="noopener noreferrer" class="myst-fm-github-link text-inherit hover:text-inherit"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" width="1.25rem" height="1.25rem" class="myst-fm-github-icon inline-block mr-1 opacity-60 hover:opacity-100"><path d="M12 2.5c-5.4 0-9.8 4.4-9.8 9.7 0 4.3 2.8 8 6.7 9.2.5.1.7-.2.7-.5v-1.8c-2.4.5-3.1-.6-3.3-1.1-.1-.3-.6-1.1-1-1.4-.3-.2-.8-.6 0-.6s1.3.7 1.5 1c.9 1.5 2.3 1.1 2.8.8.1-.6.3-1.1.6-1.3-2.2-.2-4.4-1.1-4.4-4.8 0-1.1.4-1.9 1-2.6-.1-.2-.4-1.2.1-2.6 0 0 .8-.3 2.7 1 .8-.2 1.6-.3 2.4-.3.8 0 1.7.1 2.4.3 1.9-1.3 2.7-1 2.7-1 .5 1.3.2 2.3.1 2.6.6.7 1 1.5 1 2.6 0 3.7-2.3 4.6-4.4 4.8.4.3.7.9.7 1.8V21c0 .3.2.6.7.5 3.9-1.3 6.6-4.9 6.6-9.2 0-5.4-4.4-9.8-9.8-9.8z"></path></svg></a></div><a href="https://github.com/xaviweise/aaat/edit/main/notebooks/fair_price_estimation.ipynb" title="Edit This Page" target="_blank" rel="noopener noreferrer" class="myst-fm-edit-link text-inherit hover:text-inherit"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="1.25rem" height="1.25rem" class="myst-fm-edit-icon inline-block mr-1 opacity-60 hover:opacity-100"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"></path></svg></a><div class="myst-fm-downloads-dropdown relative flex inline-block mx-1 grow-0" data-headlessui-state=""><button class="myst-fm-downloads-button relative ml-2 -mr-1" id="headlessui-menu-button-:Rs8ucp:" type="button" aria-haspopup="menu" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Downloads</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="1.25rem" height="1.25rem" class="myst-fm-downloads-icon"><title>Download</title><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"></path></svg></button></div></div><h1 class="myst-fm-block-title mb-0">Fair Price Estimation</h1><header class="myst-fm-authors-affiliations mt-4 not-prose"><div class="myst-fm-authors-list"><span class="myst-fm-author font-semibold text-sm myst-fm-author-item inline-block"><button class="myst-fm-author-popover focus:shadow-[0_0_0_2px] focus:shadow-black outline-none hover:underline" aria-label="Author Details" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-:R78ucp:" data-state="closed"><span class="myst-fm-author-name">Javier Sabio González</span></button></span></div></header></div><div class="block my-10 lg:sticky lg:z-10 lg:h-0 lg:pt-0 lg:my-0 lg:ml-10 lg:col-margin-right" style="top:60px"><nav></nav></div><div id="skip-to-article"></div><div id="rM7OUsgfEY" class="myst-jp-nb-block relative group/block"></div><div id="Gi4omT66bB" class="myst-jp-nb-block relative group/block"><h1 id="fair-price-estimation" class="relative group"><span class="heading-text">Fair Price Estimation</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#fair-price-estimation" title="Link to this Section" aria-label="Link to this Section">¶</a></h1></div><div id="TvhiapiA2z" class="myst-jp-nb-block relative group/block"><h2 id="pricing-of-flow-products" class="relative group"><span class="heading-text">Pricing of flow products</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#pricing-of-flow-products" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><h3 id="the-kalman-filter-model-for-pricing" class="relative group"><span class="heading-text">The Kalman Filter model for pricing</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#the-kalman-filter-model-for-pricing" title="Link to this Section" aria-label="Link to this Section">¶</a></h3></div><div id="gsx93G9OKu" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># Compromise execution: run full algorithm but with fewer timesteps/day so it completes here.
# Use 22 days × 60 steps/day = 1320 timesteps (faster but pattern preserved).
import numpy as np
import matplotlib.pyplot as plt
np.random.seed(100)

def make_obs_pattern(days=22, steps_per_day=60):
    pattern = []
    for _ in range(days):
        base = steps_per_day // 3
        rem = steps_per_day - 3 * base
        for _ in range(base): pattern.append(np.array([1, 0], dtype=bool))
        for _ in range(base): pattern.append(np.array([1, 1], dtype=bool))
        for _ in range(base + rem): pattern.append(np.array([0, 1], dtype=bool))
    return np.array(pattern)

def simulate_continuous_trades(Q, R, obs_pattern):
    # Q is the covariance matrix of the mid-price process
    # R is the covariance matrix of the observation process
    T = len(obs_pattern); n = Q.shape[0]
    mids = np.zeros((T, n)); trades = np.zeros((T,n))
    for t in range(1, T):
        mids[t] = mids[t-1] + np.random.multivariate_normal(np.zeros(n), Q)
    for t in range(T):
        trades[t] = mids[t] + np.random.multivariate_normal(np.zeros(n), R)
    return mids, trades

def kalman_filter_timevarying(y, R_time, A, Q, x0=None, P0=None):
    T = y.shape[0]; n = A.shape[0]
    xs = np.zeros((T, n)); Ps = np.zeros((T, n, n))
    if x0 is None: x0 = np.zeros(n)
    if P0 is None: P0 = np.eye(n)
    x_pred = x0.copy(); P_pred = P0.copy()
    for t in range(T):
        R_t = R_time[t]
        S = P_pred + R_t + np.eye(n)*1e-12
        K = P_pred @ np.linalg.inv(S)
        innov = y[t] - x_pred
        x_upd = x_pred + K @ innov
        P_upd = (np.eye(n) - K) @ P_pred
        xs[t] = x_upd; Ps[t] = P_upd
        x_pred = A @ x_upd
        P_pred = A @ P_upd @ A.T + Q
    return xs, Ps

def rts_smoother(xs, Ps, A, Q):
    T, n = xs.shape
    x_s = np.zeros_like(xs); P_s = np.zeros_like(Ps)
    x_s[-1] = xs[-1].copy(); P_s[-1] = Ps[-1].copy()
    for t in range(T-2, -1, -1):
        P_pred = A @ Ps[t] @ A.T + Q + np.eye(n)*1e-12
        J = Ps[t] @ A.T @ np.linalg.inv(P_pred)
        x_s[t] = xs[t] + J @ (x_s[t+1] - A @ xs[t])
        P_s[t] = Ps[t] + J @ (P_s[t+1] - P_pred) @ J.T
    return x_s, P_s

def em_timevaryingR(y, obs_pattern, A, large_R=1e8, max_iter=25, tol=1e-6):
    T, n = y.shape
    Q = np.eye(n) * 1e-4
    R_diag = np.array([1e-3, 2e-3])
    prev_ll = -np.inf; history = []
    for it in range(max_iter):
        R_time = np.zeros((T,n,n))
        for t in range(T):
            diag = np.array([R_diag[i] if obs_pattern[t,i] else large_R for i in range(n)])
            R_time[t] = np.diag(diag)
        xs_filt, Ps_filt = kalman_filter_timevarying(y, R_time, A, Q)
        xs_smooth, Ps_smooth = rts_smoother(xs_filt, Ps_filt, A, Q)
        Exx = Ps_smooth + np.einsum(&#x27;ti,tj-&gt;tij&#x27;, xs_smooth, xs_smooth)
        Exx_lag = np.zeros((T-1,n,n))
        for t in range(1,T):
            P_pred = A @ Ps_filt[t-1] @ A.T + Q
            J = Ps_filt[t-1] @ A.T @ np.linalg.inv(P_pred + np.eye(n)*1e-12)
            P_t_t1 = J @ Ps_smooth[t]
            Exx_lag[t-1] = P_t_t1 + np.outer(xs_smooth[t], xs_smooth[t-1])
        sumQ = np.zeros((n,n))
        for t in range(1,T):
            sumQ += Exx[t] - Exx_lag[t-1] - Exx_lag[t-1].T + Exx[t-1]
        Q_new = (sumQ / (T-1) + sumQ.T / (T-1)) / 2
        R_new = np.zeros(n); counts = np.zeros(n,dtype=int)
        for t in range(T):
            for i in range(n):
                if obs_pattern[t,i]:
                    y_i = y[t,i]; Ex_i = xs_smooth[t,i]; Exx_ii = Exx[t,i,i]
                    R_new[i] += (y_i*y_i - 2*y_i*Ex_i + Exx_ii)
                    counts[i] += 1
        for i in range(n):
            if counts[i]&gt;0:
                R_new[i] = R_new[i] / counts[i]
            else:
                R_new[i] = R_diag[i]
        Q_new += np.eye(n)*1e-12
        R_new = np.maximum(R_new, 1e-12)
        Q = 0.7*Q + 0.3*Q_new
        R_diag = 0.7*R_diag + 0.3*R_new
        history.append((Q.copy(), R_diag.copy()))
        # approx ll
        ll = 0.0; x_pred = np.zeros(n); P_pred = np.eye(n)
        for t in range(T):
            R_t = np.diag([R_diag[i] if obs_pattern[t,i] else large_R for i in range(n)])
            S = P_pred + R_t + np.eye(n)*1e-12
            innov = y[t] - x_pred
            invS = np.linalg.inv(S)
            ll += -0.5*(np.log(np.linalg.det(2*np.pi*S)) + innov.T @ invS @ innov)
            K = P_pred @ invS
            x_upd = x_pred + K @ innov
            P_upd = (np.eye(n) - K) @ P_pred
            x_pred = A @ x_upd
            P_pred = A @ P_upd @ A.T + Q
        if it&gt;0 and abs(ll - prev_ll) &lt; tol:
            break
        prev_ll = ll
    return Q, np.diag(R_diag), history, ll

# Run with 22 days x 60 steps/day
days = 22; steps_per_day = 60
obs_pattern = make_obs_pattern(days, steps_per_day); T = len(obs_pattern)
# Parameters
rho = 0.9   # correlation
sigma1 = np.sqrt(5e-4)   # std of instrument 1
sigma2 = np.sqrt(4e-4)   # std of instrument 2
# Construct covariance matrix
Q_true = np.array([
    [sigma1**2, rho * sigma1 * sigma2],
    [rho * sigma1 * sigma2, sigma2**2]
]) # We make transition covariance non-diagonal
R_true = np.diag([1e-3,2e-3]) # We make observation covariance diagonal
mids_true, trades = simulate_continuous_trades(Q_true, R_true, obs_pattern)
T_half = T//2; y_train = trades[:T_half]; y_test = trades[T_half:]
obs_train = obs_pattern[:T_half]; obs_test = obs_pattern[T_half:]
mids_test = mids_true[T_half:]; A = np.eye(2)

Q_est, R_est, history, ll_final = em_timevaryingR(y_train, obs_train, A, large_R=1e8, max_iter=25, tol=1e-5)
def build_R_time_from_diag(R_diag, obs_pattern, large_R=1e8):
    T = len(obs_pattern); n = len(R_diag); R_time = np.zeros((T,n,n))
    for t in range(T):
        diag = np.array([R_diag[i] if obs_pattern[t,i] else large_R for i in range(n)])
        R_time[t] = np.diag(diag)
    return R_time
R_time_test = build_R_time_from_diag(np.diag(R_est), obs_test, large_R=1e8)
mids_est, _ = kalman_filter_timevarying(y_test, R_time_test, A, Q_est)
rmse = np.sqrt(np.mean((mids_est - mids_test)**2, axis=0))

print(&quot;T (timesteps):&quot;, T)
print(&quot;True Q:\n&quot;, Q_true)
print(&quot;Estimated Q:\n&quot;, Q_est)
print(&quot;True R diag:&quot;, np.diag(R_true))
print(&quot;Estimated R diag:&quot;, np.diag(R_est))
print(&quot;Final approx loglik:&quot;, ll_final)
print(&quot;RMSE on second half:&quot;, rmse)

# Plot window without showing trades when market closed
plt.figure(figsize=(14, 8))
w0 = 200
w1 = min(w0 + 200, y_test.shape[0])
t = np.arange(T_half + w0, T_half + w1)

# Rerun filter on test to get covariance sequence for error bars
mids_est, Ps_est = kalman_filter_timevarying(y_test, R_time_test, A, Q_est)

# Extract ±1 std from diagonal of P (filter uncertainty)
stds = np.sqrt(np.array([np.diag(P) for P in Ps_est]))

# --- Instrument 1 ---
plt.subplot(2, 1, 1)
plt.plot(t, mids_test[w0:w1, 0], label=&#x27;True mid 1&#x27;, lw=2)
plt.plot(t, mids_est[w0:w1, 0], label=&#x27;Estimated mid 1&#x27;, lw=1.5, ls=&#x27;--&#x27;)
plt.fill_between(
    t,
    mids_est[w0:w1, 0] - stds[w0:w1, 0],
    mids_est[w0:w1, 0] + stds[w0:w1, 0],
    color=&#x27;gray&#x27;, alpha=0.2, label=&#x27;±1 std (KF)&#x27;
)
mask_plot = obs_test[w0:w1, 0]
plt.scatter(t[mask_plot], y_test[w0:w1, 0][mask_plot],
            s=8, label=&#x27;Trades 1 (open)&#x27;, alpha=0.6)
plt.title(&#x27;Instrument 1&#x27;)
plt.legend()

# --- Instrument 2 ---
plt.subplot(2, 1, 2)
plt.plot(t, mids_test[w0:w1, 1], label=&#x27;True mid 2&#x27;, lw=2)
plt.plot(t, mids_est[w0:w1, 1], label=&#x27;Estimated mid 2&#x27;, lw=1.5, ls=&#x27;--&#x27;)
plt.fill_between(
    t,
    mids_est[w0:w1, 1] - stds[w0:w1, 1],
    mids_est[w0:w1, 1] + stds[w0:w1, 1],
    color=&#x27;gray&#x27;, alpha=0.2, label=&#x27;±1 std (KF)&#x27;
)
mask_plot1 = obs_test[w0:w1, 1]
plt.scatter(t[mask_plot1], y_test[w0:w1, 1][mask_plot1],
            s=8, label=&#x27;Trades 2 (open)&#x27;, alpha=0.6)
plt.title(&#x27;Instrument 2&#x27;)
plt.legend()

plt.tight_layout()
plt.show()

</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="X6NkR1XNFCTOO2Z8Gnsxc" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>T (timesteps): 1320
True Q:
 [[0.0005     0.00040249]
 [0.00040249 0.0004    ]]
Estimated Q:
 [[0.00031037 0.0001628 ]
 [0.0001628  0.00022782]]
True R diag: [0.001 0.002]
Estimated R diag: [0.00117355 0.00253554]
Final approx loglik: -3121.7461477103247
RMSE on second half: [0.03244913 0.09017213]
</span></code></pre></div></div><div data-name="safe-output-image"><img src="/build/98bd8bd742243ae50dd6f3cfb65dd6de.png" alt="&lt;Figure size 1400x800 with 2 Axes&gt;"/></div></div></div><div id="HPSFBIz54k" class="myst-jp-nb-block relative group/block"><h2 id="the-utility-indifference-theory-for-derivatives-pricing" class="relative group"><span class="heading-text">The utility indifference theory for derivatives pricing</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#the-utility-indifference-theory-for-derivatives-pricing" title="Link to this Section" aria-label="Link to this Section">¶</a></h2></div><div id="tx9JuaXlYm" class="myst-jp-nb-block relative group/block"><h3 id="call-option-premium-using-the-utility-indifference-principle" class="relative group"><span class="heading-text">Call option premium using the utility indifference principle</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#call-option-premium-using-the-utility-indifference-principle" title="Link to this Section" aria-label="Link to this Section">¶</a></h3></div><div id="PL8bvemNO1" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">import numpy as np
import matplotlib.pyplot as plt
from scipy.stats import norm

# Black-Scholes formula with drift implementation
def black_scholes_with_drift(S, K, T, t, r, mu, sigma):
    d1_mu = (np.log(S / K) + (mu + 0.5 * sigma**2) * (T - t)) / (sigma * np.sqrt(T - t))
    d2_mu = d1_mu - sigma * np.sqrt(T - t)
    call_price_with_drift = S * np.exp((mu - r) * (T - t)) * norm.cdf(d1_mu) - K * np.exp(-r * (T - t)) * norm.cdf(d2_mu)
    return call_price_with_drift

# Parameters for the plots
S_t = 100   # Current stock price
K = 100     # Strike price
T = 1       # Time to maturity (1 year)
t = 0       # Current time (now)
r = 0.05    # Risk-free interest rate (5%)
mu = 0.1    # Drift rate (10%)
sigma = 0.2 # Volatility (20%)

# Generate data for each dependency plot
S_values = np.linspace(50, 150, 400)
K_values = np.linspace(50, 150, 400)
T_values = np.linspace(0.01, 2, 400)
r_values = np.linspace(0, 0.2, 400)
sigma_values = np.linspace(0.01, 1, 400)
mu_values = np.linspace(-0.1, 0.3, 400)

# Calculate call prices with drift
C_S_drift = [black_scholes_with_drift(S, K, T, t, r, mu, sigma) for S in S_values]
C_K_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for K in K_values]
C_T_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for T in T_values]
C_r_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for r in r_values]
C_sigma_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for sigma in sigma_values]
C_mu_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for mu in mu_values]

# Plotting all dependencies in a single figure for export

fig, axs = plt.subplots(3, 2, figsize=(15, 18))

# Current Stock Price (S) with Drift
axs[0, 0].plot(S_values, C_S_drift)
axs[0, 0].set_title(&#x27;Call Option Price vs Current Stock Price (S) with Drift&#x27;)
axs[0, 0].set_xlabel(&#x27;Current Stock Price (S)&#x27;)
axs[0, 0].set_ylabel(&#x27;Call Option Price (P)&#x27;)
axs[0, 0].grid(True)

# Strike Price (K) with Drift
axs[0, 1].plot(K_values, C_K_drift)
axs[0, 1].set_title(&#x27;Call Option Price vs Strike Price (K) with Drift&#x27;)
axs[0, 1].set_xlabel(&#x27;Strike Price (K)&#x27;)
axs[0, 1].set_ylabel(&#x27;Call Option Price (P)&#x27;)
axs[0, 1].grid(True)

# Time to Maturity (T) with Drift
axs[1, 0].plot(T_values, C_T_drift)
axs[1, 0].set_title(&#x27;Call Option Price vs Time to Maturity (T) with Drift&#x27;)
axs[1, 0].set_xlabel(&#x27;Time to Maturity (T)&#x27;)
axs[1, 0].set_ylabel(&#x27;Call Option Price (P)&#x27;)
axs[1, 0].grid(True)

# Risk-Free Interest Rate (r) with Drift
axs[1, 1].plot(r_values, C_r_drift)
axs[1, 1].set_title(&#x27;Call Option Price vs Risk-Free Interest Rate (r) with Drift&#x27;)
axs[1, 1].set_xlabel(&#x27;Risk-Free Interest Rate (r)&#x27;)
axs[1, 1].set_ylabel(&#x27;Call Option Price (P)&#x27;)
axs[1, 1].grid(True)

# Volatility (σ) with Drift
axs[2, 0].plot(sigma_values, C_sigma_drift)
axs[2, 0].set_title(&#x27;Call Option Price vs Volatility (σ) with Drift&#x27;)
axs[2, 0].set_xlabel(&#x27;Volatility (σ)&#x27;)
axs[2, 0].set_ylabel(&#x27;Call Option Price (P)&#x27;)
axs[2, 0].grid(True)

# Drift (μ)
axs[2, 1].plot(mu_values, C_mu_drift)
axs[2, 1].set_title(&#x27;Call Option Price vs Drift (μ)&#x27;)
axs[2, 1].set_xlabel(&#x27;Drift (μ)&#x27;)
axs[2, 1].set_ylabel(&#x27;Call Option Price (P)&#x27;)
axs[2, 1].grid(True)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="Zk2Z4VWaf_C_o_HCbhEmN" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-image"><img src="/build/0357c4253a819a842cf3941221e4e212.png" alt="&lt;Figure size 1500x1800 with 6 Axes&gt;"/></div></div></div><div id="PYDSOvHTTC" class="myst-jp-nb-block relative group/block"><h2 id="the-arbitrage-free-theory-of-derivatives-pricing" class="relative group"><span class="heading-text">The arbitrage-free theory of derivatives pricing</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#the-arbitrage-free-theory-of-derivatives-pricing" title="Link to this Section" aria-label="Link to this Section">¶</a></h2></div><div id="SYxKzFR4H7" class="myst-jp-nb-block relative group/block"><h3 id="call-option-premium-using-arbitrage-free-theory" class="relative group"><span class="heading-text">Call option premium using arbitrage-free theory</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#call-option-premium-using-arbitrage-free-theory" title="Link to this Section" aria-label="Link to this Section">¶</a></h3></div><div id="THUeGsKssb" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">import numpy as np
import matplotlib.pyplot as plt
from scipy.stats import norm

# Black-Scholes formula with drift implementation
def black_scholes_with_drift(S, K, T, t, r, mu, sigma):
    d1_mu = (np.log(S / K) + (mu + 0.5 * sigma**2) * (T - t)) / (sigma * np.sqrt(T - t))
    d2_mu = d1_mu - sigma * np.sqrt(T - t)
    call_price_with_drift = S * np.exp((mu - r) * (T - t)) * norm.cdf(d1_mu) - K * np.exp(-r * (T - t)) * norm.cdf(d2_mu)
    return call_price_with_drift

# Standard Black-Scholes formula (mu = r)
def black_scholes_standard(S, K, T, t, r, sigma):
    return black_scholes_with_drift(S, K, T, t, r, r, sigma)

# Parameters for the plots
S_t = 100   # Current stock price
K = 100     # Strike price
T = 1       # Time to maturity (1 year)
t = 0       # Current time (now)
r = 0.05    # Risk-free interest rate (5%)
mu = 0.1    # Drift rate (10%)
sigma = 0.2 # Volatility (20%)

# Generate data for each dependency plot
S_values = np.linspace(50, 150, 400)
K_values = np.linspace(50, 150, 400)
T_values = np.linspace(0.01, 2, 400)
r_values = np.linspace(0, 0.2, 400)
sigma_values = np.linspace(0.01, 1, 400)
mu_values = np.linspace(-0.1, 0.3, 400)

# Calculate call prices with drift
C_S_drift = [black_scholes_with_drift(S, K, T, t, r, mu, sigma) for S in S_values]
C_K_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for K in K_values]
C_T_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for T in T_values]
C_r_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for r in r_values]
C_sigma_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for sigma in sigma_values]
C_mu_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for mu in mu_values]

# Calculate call prices using standard Black-Scholes formula (mu = r)
C_S_standard = [black_scholes_standard(S, K, T, t, r, sigma) for S in S_values]
C_K_standard = [black_scholes_standard(S_t, K, T, t, r, sigma) for K in K_values]
C_T_standard = [black_scholes_standard(S_t, K, T, t, r, sigma) for T in T_values]
C_r_standard = [black_scholes_standard(S_t, K, T, t, r, sigma) for r in r_values]
C_sigma_standard = [black_scholes_standard(S_t, K, T, t, r, sigma) for sigma in sigma_values]
C_mu_standard = [black_scholes_standard(S_t, K, T, t, r, sigma) for mu in mu_values]

# Plotting all dependencies in a single figure for comparison
fig, axs = plt.subplots(3, 2, figsize=(15, 18))

# Current Stock Price (S) comparison
axs[0, 0].plot(S_values, C_S_drift, label=&quot;With Drift (mu = 0.1)&quot;)
axs[0, 0].plot(S_values, C_S_standard, label=&quot;Standard (mu = r)&quot;, linestyle=&quot;--&quot;)
axs[0, 0].set_title(&#x27;Call Option Price vs Current Stock Price (S)&#x27;)
axs[0, 0].set_xlabel(&#x27;Current Stock Price (S)&#x27;)
axs[0, 0].set_ylabel(&#x27;Call Option Price (P)&#x27;)
axs[0, 0].legend()
axs[0, 0].grid(True)

# Strike Price (K) comparison
axs[0, 1].plot(K_values, C_K_drift, label=&quot;With Drift (mu = 0.1)&quot;)
axs[0, 1].plot(K_values, C_K_standard, label=&quot;Standard (mu = r)&quot;, linestyle=&quot;--&quot;)
axs[0, 1].set_title(&#x27;Call Option Price vs Strike Price (K)&#x27;)
axs[0, 1].set_xlabel(&#x27;Strike Price (K)&#x27;)
axs[0, 1].set_ylabel(&#x27;Call Option Price (P)&#x27;)
axs[0, 1].legend()
axs[0, 1].grid(True)

# Time to Maturity (T) comparison
axs[1, 0].plot(T_values, C_T_drift, label=&quot;With Drift (mu = 0.1)&quot;)
axs[1, 0].plot(T_values, C_T_standard, label=&quot;Standard (mu = r)&quot;, linestyle=&quot;--&quot;)
axs[1, 0].set_title(&#x27;Call Option Price vs Time to Maturity (T)&#x27;)
axs[1, 0].set_xlabel(&#x27;Time to Maturity (T)&#x27;)
axs[1, 0].set_ylabel(&#x27;Call Option Price (P)&#x27;)
axs[1, 0].legend()
axs[1, 0].grid(True)

# Risk-Free Interest Rate (r) comparison
axs[1, 1].plot(r_values, C_r_drift, label=&quot;With Drift (mu = 0.1)&quot;)
axs[1, 1].plot(r_values, C_r_standard, label=&quot;Standard (mu = r)&quot;, linestyle=&quot;--&quot;)
axs[1, 1].set_title(&#x27;Call Option Price vs Risk-Free Interest Rate (r)&#x27;)
axs[1, 1].set_xlabel(&#x27;Risk-Free Interest Rate (r)&#x27;)
axs[1, 1].set_ylabel(&#x27;Call Option Price (P)&#x27;)
axs[1, 1].legend()
axs[1, 1].grid(True)

# Volatility (σ) comparison
axs[2, 0].plot(sigma_values, C_sigma_drift, label=&quot;With Drift (mu = 0.1)&quot;)
axs[2, 0].plot(sigma_values, C_sigma_standard, label=&quot;Standard (mu = r)&quot;, linestyle=&quot;--&quot;)
axs[2, 0].set_title(&#x27;Call Option Price vs Volatility (σ)&#x27;)
axs[2, 0].set_xlabel(&#x27;Volatility (σ)&#x27;)
axs[2, 0].set_ylabel(&#x27;Call Option Price (P)&#x27;)
axs[2, 0].legend()
axs[2, 0].grid(True)

# Drift (μ) comparison
axs[2, 1].plot(mu_values, C_mu_drift, label=&quot;With Drift (mu = varying)&quot;)
axs[2, 1].plot(mu_values, C_mu_standard, label=&quot;Standard (mu = r)&quot;, linestyle=&quot;--&quot;)
axs[2, 1].set_title(&#x27;Call Option Price vs Drift (μ)&#x27;)
axs[2, 1].set_xlabel(&#x27;Drift (μ)&#x27;)
axs[2, 1].set_ylabel(&#x27;Call Option Price (P)&#x27;)
axs[2, 1].legend()
axs[2, 1].grid(True)

plt.tight_layout()
plt.show()
</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="WNt7qOFF5eGoOzMgMLNHC" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-image"><img src="/build/b943001b0796b61535a083e024d7fe00.png" alt="&lt;Figure size 1500x1800 with 6 Axes&gt;"/></div></div></div><div id="Mj7lL6kZXK" class="myst-jp-nb-block relative group/block"><h3 id="using-the-bsm-framework-in-practice" class="relative group"><span class="heading-text">Using the BSM framework in practice</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#using-the-bsm-framework-in-practice" title="Link to this Section" aria-label="Link to this Section">¶</a></h3></div><div id="b116YBkKQN" class="myst-jp-nb-block relative group/block"><div class="myst-jp-nb-block-spinner flex sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:hidden"><div class="flex absolute top-0 right-0"></div></div><div class="myst-jp-nb-block sticky top-[115px] z-10 opacity-90 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute -top-[12px] right-0 flex flex-row rounded bg-white dark:bg-slate-800"></div></div><div class="relative myst-code group not-prose my-5 text-sm shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 border border-l-4 border-gray-200 border-l-blue-400 dark:border-l-blue-400 dark:border-gray-800"><pre class="block overflow-auto p-3 myst-code-body hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">import numpy as np
import matplotlib.pyplot as plt
from scipy.stats import norm
import pandas as pd

def black_scholes_price(S, K, T, r, sigma, option_type=&#x27;call&#x27;):
    &quot;&quot;&quot;
    Calculate Black-Scholes option price.
    &quot;&quot;&quot;
    d1 = (np.log(S / K) + (r + 0.5 * sigma **2 ) * T ) / (sigma * np.sqrt(T))
    d2 = d1 - sigma * np.sqrt(T)
    
    if option_type == &#x27;call&#x27;:
        price = S * norm.cdf(d1) - K * np.exp(-r * T) * norm.cdf(d2)
    elif option_type == &#x27;put&#x27;:
        price = K * np.exp(-r * T) * norm.cdf(-d2) - S * norm.cdf(-d1)
    else:
        raise ValueError(&quot;option_type must be &#x27;call&#x27; or &#x27;put&#x27;&quot;)
    return price

def black_scholes_delta(S, K, T, r, sigma, option_type=&#x27;call&#x27;):
    &quot;&quot;&quot;
    Calculate Black-Scholes option delta.
    &quot;&quot;&quot;
    d1 = (np.log(S / K) + (r + 0.5 * sigma **2 ) * T ) / (sigma * np.sqrt(T))
    
    if option_type == &#x27;call&#x27;:
        delta = norm.cdf(d1)
    elif option_type == &#x27;put&#x27;:
        delta = norm.cdf(d1) - 1
    else:
        raise ValueError(&quot;option_type must be &#x27;call&#x27; or &#x27;put&#x27;&quot;)
    return delta

def simulate_gbm_paths(S0, mu, sigma, T, dt, n_paths, 
                      stochastic_vol=False, kappa=2.0, theta=0.04, xi=0.2, rho=-0.7):
    &quot;&quot;&quot;
    Simulate GBM paths with optional stochastic volatility based on the Heston model.
    
    Parameters:
    - S0: initial stock price
    - mu: drift
    - sigma: initial volatility
    - T: maturity
    - dt: time step
    - n_paths: number of simulation paths
    - stochastic_vol: if True, use the Heston stochastic volatility model
    - kappa: rate of mean reversion of variance (only if stochastic_vol=True)
    - theta: long-term variance mean (only if stochastic_vol=True)
    - xi: volatility of variance (only if stochastic_vol=True)
    - rho: correlation between stock and variance (only if stochastic_vol=True)
    
    Returns:
    - paths: array of shape (n_steps +1, n_paths)
    &quot;&quot;&quot;
    n_steps = int(T / dt)
    paths = np.zeros((n_steps +1, n_paths))
    paths[0] = S0
    
    if stochastic_vol:
        # Initialize variance
        V0 = sigma ** 2
        variances = np.zeros((n_steps +1, n_paths))
        variances[0] = V0
        
        # Precompute correlation matrix and Cholesky decomposition
        cov_matrix = np.array([[1.0, rho],
                               [rho, 1.0]])
        L = np.linalg.cholesky(cov_matrix)
        
        for t in range(1, n_steps +1):
            # Simulate two correlated random variables
            Z = np.random.standard_normal((2, n_paths))
            correlated_Z = L @ Z
            Z_S = correlated_Z[0]
            Z_V = correlated_Z[1]
            
            # Update variance using CIR process
            V_prev = variances[t-1]
            V = V_prev + kappa * (theta - V_prev) * dt + xi * np.sqrt(np.maximum(V_prev, 0)) * np.sqrt(dt) * Z_V
            V = np.maximum(V, 0)  # Ensure variance is non-negative
            variances[t] = V
            
            # Update stock price
            S_prev = paths[t-1]
            S = S_prev * np.exp( (mu - 0.5 * V_prev) * dt + np.sqrt(V_prev) * np.sqrt(dt) * Z_S )
            paths[t] = S
    else:
        for t in range(1, n_steps +1):
            Z = np.random.standard_normal(n_paths)
            paths[t] = paths[t-1] * np.exp( (mu - 0.5 * sigma **2 ) * dt + sigma * np.sqrt(dt) * Z )
    
    return paths

def dynamic_hedging(paths, S0, K, T, r, sigma_bs, option_type=&#x27;call&#x27;, dt=1/252,
                   rehedge_freq=1, half_spread=0.0, sigma_sim=None):
    &quot;&quot;&quot;
    Implement dynamic hedging strategy.
    
    Parameters:
    - paths: simulated stock price paths (array of shape (n_steps+1, n_paths))
    - S0: initial stock price
    - K: strike price
    - T: maturity
    - r: risk-free rate
    - sigma_bs: volatility used in BS model
    - option_type: &#x27;call&#x27; or &#x27;put&#x27;
    - dt: time step size
    - rehedge_freq: frequency of rehedging in terms of number of steps. If 1, rebalance every step.
    - half_spread: transaction cost as a fraction of price (half spread for buying and selling)
    - sigma_sim: volatility used in simulation (if different from sigma_bs)
    
    Returns:
    - differences: array of portfolio - payoff for each path
    &quot;&quot;&quot;
    n_steps, n_paths = paths.shape[0]-1, paths.shape[1]
    # Calculate option price and initial delta
    option_price = black_scholes_price(S0, K, T, r, sigma_bs, option_type)
    option_delta = black_scholes_delta(S0, K, T, r, sigma_bs, option_type)
    
    # Initialize portfolio
    portfolio = np.full(n_paths, option_price)
    stock_position = np.full(n_paths, option_delta)
    cash_position = portfolio - stock_position * S0
    
    # Time steps
    times = np.linspace(0, T, n_steps +1)
    
    # Rehedge steps
    rehedge_steps = rehedge_freq
    
    for t in range(1, n_steps +1):
        tau = T - times[t]
        if tau &lt;= 0:
            tau = 1e-10  # Avoid division by zero
        
        # Determine if rebalancing is needed
        if t % rehedge_steps == 0:
            # Compute delta using BS formula
            current_S = paths[t]
            current_delta = black_scholes_delta(current_S, K, tau, r, sigma_bs, option_type)
            
            # Calculate change in delta
            delta_change = current_delta - stock_position
            # Calculate transaction cost
            transaction_cost = half_spread * np.abs(delta_change * current_S)
            
            # Update cash position
            cash_position = cash_position * np.exp(r * dt) - delta_change * current_S - transaction_cost
            
            # Update stock position
            stock_position = current_delta
        else:
            # Just grow the cash position
            cash_position = cash_position * np.exp(r * dt)
        
        # Update portfolio value
        portfolio = cash_position + stock_position * paths[t]
    
    # Option payoff
    if option_type == &#x27;call&#x27;:
        payoff = np.maximum(paths[-1] - K, 0)
    elif option_type == &#x27;put&#x27;:
        payoff = np.maximum(K - paths[-1], 0)
    else:
        raise ValueError(&quot;option_type must be &#x27;call&#x27; or &#x27;put&#x27;&quot;)
    
    differences = portfolio - payoff
    return differences

def run_simulation():
    # Parameters
    S0 = 100          # Initial stock price
    K = 100           # Strike price
    T = 1.0           # 1 year
    r = 0.05          # 5% risk-free rate
    sigma_bs = 0.20   # 20% volatility used in Black-Scholes model
    mu = 0.1          # 10% drift
    option_type = &#x27;call&#x27;
    n_paths = 10000   # Number of simulation paths
    dt = 1/10000      # Fixed small time step for accurate approximation
    
    # Perfect setup with varying rehedging frequency
    rehedge_freq_values = [1, 10, 100]  # Rebalance every 1, 10, 100 steps
    differences_rehedge_freq = {}
    
    # Simulate perfect hedging with varying rehedging frequencies
    for freq in rehedge_freq_values:
        print(f&quot;Simulating Perfect Setup with Rehedging Frequency: Every {freq} steps&quot;)
        paths_perfect = simulate_gbm_paths(S0, mu, sigma_bs, T, dt, n_paths, stochastic_vol=False)
        differences = dynamic_hedging(paths_perfect, S0, K, T, r, sigma_bs, option_type, dt, 
                                     rehedge_freq=freq, half_spread=0.0)
        differences_rehedge_freq[freq] = differences
    
    # Baseline residuals (Rebalance every step)
    residuals_perfect = differences_rehedge_freq[1]
    
    # Violations
    # 1. Different volatility for simulation (sigma_sim = 0.19 and 0.21)
    sigma_sim_values = [0.19, 0.21]
    differences_sigma_sim = {}
    for sigma_sim in sigma_sim_values:
        print(f&quot;Simulating Different Volatility in Simulation: sigma_sim = {sigma_sim}&quot;)
        paths_diff_vol = simulate_gbm_paths(S0, mu, sigma_sim, T, dt, n_paths, stochastic_vol=False)
        differences = dynamic_hedging(paths_diff_vol, S0, K, T, r, sigma_bs, option_type, dt, 
                                     rehedge_freq=1, half_spread=0.0)
        differences_sigma_sim[sigma_sim] = differences
    
    # 2. Stochastic Volatility (Heston Model)
    print(&quot;Simulating Stochastic Volatility (Heston Model)&quot;)
    paths_stoch_vol = simulate_gbm_paths(S0, mu, sigma_bs, T, dt, n_paths, stochastic_vol=True,
                                        kappa=20.0, theta=0.04, xi=0.2, rho=-0.7)
    differences_stoch_vol = dynamic_hedging(paths_stoch_vol, S0, K, T, r, sigma_bs, option_type, dt, 
                                           rehedge_freq=1, half_spread=0.0)
    
    # 3. Transaction Costs (Half Spread = 0.005%)
    half_spread = 0.00005  # 0.005%
    print(&quot;Simulating With Transaction Costs (Half Spread = 0.005%)&quot;)
    paths_half_spread = simulate_gbm_paths(S0, mu, sigma_bs, T, dt, n_paths, stochastic_vol=False)
    differences_half_spread = dynamic_hedging(paths_half_spread, S0, K, T, r, sigma_bs, option_type, dt, 
                                             rehedge_freq=1, half_spread=half_spread)
    
    # Plot histograms in a 2x2 grid
    plt.figure(figsize=(18, 14))
    
    # Subplot 1: Effect of Re-Hedging Frequency on Hedging Residuals
    plt.subplot(2, 2, 1)
    colors = [&#x27;blue&#x27;, &#x27;green&#x27;, &#x27;red&#x27;, &#x27;purple&#x27;]
    labels = [f&#x27;Rebalance Every {freq} Steps&#x27; for freq in rehedge_freq_values]
    
    for i, freq in enumerate(rehedge_freq_values):
        plt.hist(differences_rehedge_freq[freq], bins=100, alpha=0.5, 
                 color=colors[i], label=labels[i], density=True)
    
    plt.title(&#x27;Effect of Re-Hedging Frequency on Hedging Residuals&#x27;)
    plt.xlabel(&#x27;Portfolio - Payoff&#x27;)
    plt.ylabel(&#x27;Density&#x27;)
    plt.legend()
    plt.grid(True)
    
    # Subplot 2: Different Volatility in Simulation
    plt.subplot(2, 2, 2)
    colors_sigma = [&#x27;orange&#x27;, &#x27;cyan&#x27;]
    labels_sigma = [f&#x27;sigma_sim = {sigma_sim:.2f}&#x27; for sigma_sim in sigma_sim_values]
    
    for i, sigma_sim in enumerate(sigma_sim_values):
        plt.hist(differences_sigma_sim[sigma_sim], bins=100, alpha=0.5, 
                 color=colors_sigma[i], label=labels_sigma[i], density=True)
    
    # Add baseline
    plt.hist(residuals_perfect, bins=100, alpha=0.3, color=&#x27;black&#x27;, label=&#x27;Perfect Replication&#x27;, density=True)
    
    plt.title(&#x27;Different Volatility in Simulation&#x27;)
    plt.xlabel(&#x27;Portfolio - Payoff&#x27;)
    plt.ylabel(&#x27;Density&#x27;)
    plt.legend()
    plt.grid(True)
    
    # Subplot 3: Stochastic Volatility (Heston Model)
    plt.subplot(2, 2, 3)
    plt.hist(differences_stoch_vol, bins=100, alpha=0.7, color=&#x27;purple&#x27;, edgecolor=&#x27;black&#x27;, density=True, label=&#x27;Stochastic Volatility&#x27;)
    
    # Add baseline
    plt.hist(residuals_perfect, bins=100, alpha=0.3, color=&#x27;black&#x27;, label=&#x27;Perfect Replication&#x27;, density=True)
    
    plt.title(&#x27;Stochastic Volatility (Heston Model)&#x27;)
    plt.xlabel(&#x27;Portfolio - Payoff&#x27;)
    plt.ylabel(&#x27;Density&#x27;)
    plt.legend()
    plt.grid(True)
    
    # Subplot 4: Transaction Costs (Half Spread)
    plt.subplot(2, 2, 4)
    plt.hist(differences_half_spread, bins=100, alpha=0.7, color=&#x27;green&#x27;, edgecolor=&#x27;black&#x27;, density=True, label=&#x27;Half Spread = 0.005%&#x27;)
    
    # Add baseline
    plt.hist(residuals_perfect, bins=100, alpha=0.3, color=&#x27;black&#x27;, label=&#x27;Perfect Replication&#x27;, density=True)
    
    plt.title(&#x27;Transaction Costs (Half Spread = 0.005%)&#x27;)
    plt.xlabel(&#x27;Portfolio - Payoff&#x27;)
    plt.ylabel(&#x27;Density&#x27;)
    plt.legend()
    plt.grid(True)
    
    plt.tight_layout()
    plt.show()
    
    # Summary statistics for Perfect Setup with varied rehedging frequency
    print(&quot;Summary Statistics for Perfect Setup with Varied Re-Hedging Frequency:&quot;)
    for freq, diff in differences_rehedge_freq.items():
        print(f&quot;Rebalance Every {freq} Steps: Mean = {np.mean(diff):.6f}, Std Dev = {np.std(diff):.6f}&quot;)
    print(&quot;-&quot;*60)
    
    # Summary statistics for Violations
    print(&quot;Summary Statistics for Violations:&quot;)
    
    # 1. Different Volatility in Simulation
    for sigma_sim, diff in differences_sigma_sim.items():
        print(f&quot;Different Volatility in Simulation (sigma_sim = {sigma_sim:.2f}):&quot;)
        print(f&quot;  Mean difference: {np.mean(diff):.6f}&quot;)
        print(f&quot;  Std Dev of difference: {np.std(diff):.6f}&quot;)
    
    # 2. Stochastic Volatility (Heston Model)
    print(&quot;Stochastic Volatility (Heston Model):&quot;)
    print(f&quot;  Mean difference: {np.mean(differences_stoch_vol):.6f}&quot;)
    print(f&quot;  Std Dev of difference: {np.std(differences_stoch_vol):.6f}&quot;)
    
    # 3. Transaction Costs (Half Spread)
    print(&quot;Transaction Costs (Half Spread = 0.005%):&quot;)
    print(f&quot;  Mean difference: {np.mean(differences_half_spread):.6f}&quot;)
    print(f&quot;  Std Dev of difference: {np.std(differences_half_spread):.6f}&quot;)
    print(&quot;-&quot;*40)

if __name__ == &quot;__main__&quot;:
    run_simulation()
</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 myst-code-copy-icon top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-name="outputs-container" data-mdast-node-id="G9tpLJ_B6i5igv2R73W_H" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>Simulating Perfect Setup with Rehedging Frequency: Every 1 steps
Simulating Perfect Setup with Rehedging Frequency: Every 10 steps
Simulating Perfect Setup with Rehedging Frequency: Every 100 steps
Simulating Different Volatility in Simulation: sigma_sim = 0.19
Simulating Different Volatility in Simulation: sigma_sim = 0.21
Simulating Stochastic Volatility (Heston Model)
Simulating With Transaction Costs (Half Spread = 0.005%)
</span></code></pre></div></div><div data-name="safe-output-image"><img src="/build/3148c4ba80ce7552ab79f8b940948ffa.png" alt="&lt;Figure size 1800x1400 with 4 Axes&gt;"/></div><div data-name="safe-output-stream"><div><pre class="myst-jp-stream-output text-sm font-thin font-system"><code><span>Summary Statistics for Perfect Setup with Varied Re-Hedging Frequency:
Rebalance Every 1 Steps: Mean = 0.000827, Std Dev = 0.068216
Rebalance Every 10 Steps: Mean = 0.003540, Std Dev = 0.214217
Rebalance Every 100 Steps: Mean = -0.011300, Std Dev = 0.690467
------------------------------------------------------------
Summary Statistics for Violations:
Different Volatility in Simulation (sigma_sim = 0.19):
  Mean difference: 0.381420
  Std Dev of difference: 0.164161
Different Volatility in Simulation (sigma_sim = 0.21):
  Mean difference: -0.381580
  Std Dev of difference: 0.172823
Stochastic Volatility (Heston Model):
  Mean difference: -0.032125
  Std Dev of difference: 0.193527
Transaction Costs (Half Spread = 0.005%):
  Mean difference: -0.152493
  Std Dev of difference: 0.092860
----------------------------------------
</span></code></pre></div></div></div></div><div class="myst-backmatter-parts"></div><div class="myst-footer-links flex pt-10 mb-10 space-x-4"><a class="myst-footer-link flex-1 block p-4 font-normal text-gray-600 no-underline border border-gray-200 rounded shadow-sm group hover:border-blue-600 dark:hover:border-blue-400 hover:text-blue-600 dark:hover:text-blue-400 dark:text-gray-100 dark:border-gray-500 hover:shadow-lg dark:shadow-neutral-700 myst-footer-link-prev" href="/notebooks/rfq-models"><div class="flex h-full align-middle"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="1.5rem" height="1.5rem" class="myst-footer-link-icon self-center transition-transform group-hover:-translate-x-1 shrink-0"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18"></path></svg><div class="flex-grow text-right"><div class="myst-footer-link-group text-xs text-gray-500 dark:text-gray-400">Notebooks</div>Modelling RfQs in Dealer to Client Markets</div></div></a></div></article></main><script>((a,l)=>{if(!window.history.state||!window.history.state.key){let u=Math.random().toString(32).slice(2);window.history.replaceState({key:u},"")}try{let d=JSON.parse(sessionStorage.getItem(a)||"{}")[l||window.history.state.key];typeof d=="number"&&window.scrollTo(0,d)}catch(u){console.error(u),sessionStorage.removeItem(a)}})("positions", null)</script><link rel="modulepreload" href="/build/entry.client-PCJPW7TK.js"/><link rel="modulepreload" href="/build/_shared/chunk-AQ2CODAG.js"/><link rel="modulepreload" href="/build/_shared/chunk-JJXTQVMA.js"/><link rel="modulepreload" href="/build/_shared/chunk-OZE3FFNP.js"/><link rel="modulepreload" href="/build/_shared/chunk-OYMW4E3D.js"/><link rel="modulepreload" href="/build/_shared/chunk-C4DFGG5C.js"/><link rel="modulepreload" href="/build/_shared/chunk-J7TUH54J.js"/><link rel="modulepreload" href="/build/_shared/chunk-FZ2S7OYD.js"/><link rel="modulepreload" href="/build/_shared/chunk-JEM6JXYA.js"/><link rel="modulepreload" href="/build/_shared/chunk-34XIY2DH.js"/><link rel="modulepreload" href="/build/_shared/chunk-KQM5FBHR.js"/><link rel="modulepreload" href="/build/_shared/chunk-OCWQY3HK.js"/><link rel="modulepreload" href="/build/_shared/chunk-7HNKBP4B.js"/><link rel="modulepreload" href="/build/_shared/chunk-CUKUDK3R.js"/><link rel="modulepreload" href="/build/_shared/chunk-3EBOCCHJ.js"/><link rel="modulepreload" href="/build/_shared/chunk-O4VQNZ62.js"/><link rel="modulepreload" href="/build/_shared/chunk-4OEDG4JQ.js"/><link rel="modulepreload" href="/build/_shared/chunk-GUCIBHGO.js"/><link rel="modulepreload" href="/build/root-CXYA7X5D.js"/><link rel="modulepreload" href="/build/_shared/chunk-DATP5P2X.js"/><link rel="modulepreload" href="/build/routes/$-JRBPULBO.js"/><script>window.__remixContext = {"url":"/notebooks/fair-price-estimation","state":{"loaderData":{"root":{"config":{"version":3,"myst":"1.7.0","options":{"folders":true},"nav":[],"actions":[{"title":"Data Science Algo Trading","url":"https://www.datasciencealgotrading.com","internal":false,"static":false}],"projects":[{"bibliography":["/Users/javier/Documents/aaat/references.bib"],"exports":[],"title":"Advanced Analytics and Algorithmic Trading","authors":[{"nameParsed":{"literal":"Javier Sabio González","given":"Javier Sabio","family":"González"},"name":"Javier Sabio González","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/xaviweise/aaat","toc":[{"file":"welcome.md"},{"children":[{"file":"markdown/releases.md"},{"file":"markdown/dedication.md"},{"file":"markdown/preface.md"},{"file":"markdown/symbollist.md"}],"title":"Introduction"},{"children":[{"file":"markdown/intro_financial_markets.md"},{"file":"markdown/intro_financial_instruments.md"},{"file":"markdown/market_microstructure.md"},{"file":"markdown/algorithmic_trading.md"}],"title":"Financial Markets Fundamentals"},{"children":[{"file":"markdown/intro_bayesian.md"},{"file":"markdown/intro_causal.md"},{"file":"markdown/stochastic_calculus.md"},{"file":"markdown/stochastic_optimal_control.md"},{"file":"markdown/data_driven_methods.md"},{"file":"markdown/generative_ai.md"}],"title":"Financial Modelling Fundamentals"},{"children":[{"file":"markdown/execution_fundamentals.md"},{"file":"markdown/lob_models.md"},{"file":"markdown/almgren_chriss.md"},{"file":"markdown/execution_tactics.md"}],"title":"Execution Algorithms"},{"children":[{"file":"markdown/market_making_fundamentals.md"},{"file":"markdown/fair_price_estimation.md"},{"file":"markdown/liquidity_modelling.md"},{"file":"markdown/rfq_models.md"},{"file":"markdown/avellaneda_stoikov.md"},{"file":"markdown/enriching_avellaneda.md"},{"file":"markdown/hedging.md"},{"file":"markdown/market_making_rl.md"}],"title":"Market Making Algorithms"},{"children":[{"file":"markdown/quant_investment_fundamentals.md"},{"file":"markdown/mean_reversion_strategies.md"},{"file":"markdown/trend_following.md"},{"file":"markdown/arbitrage.md"},{"file":"markdown/factor_investing.md"},{"file":"markdown/optimal_portfolios.md"}],"title":"Investment Algorithms"},{"children":[{"file":"markdown/glossary.md"},{"file":"markdown/references.md"}],"title":"Glossary and References"},{"children":[{"file":"notebooks/stochastic_calculus.ipynb"},{"file":"notebooks/bayesian_theory.ipynb"},{"file":"notebooks/market_microstructure.ipynb"},{"file":"notebooks/rfq_models.ipynb"},{"file":"notebooks/fair_price_estimation.ipynb"}],"title":"Notebooks"}],"thumbnail":"/build/cover-09caa9dd03fd74a2e96de11fa5332265.jpg","index":"index","pages":[{"level":1,"title":"Introduction"},{"slug":"markdown.releases","title":"Release Notes","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.dedication","title":"Dedication","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.preface","title":"Preface","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.symbollist","title":"Symbols","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Financial Markets Fundamentals"},{"slug":"markdown.intro-financial-markets","title":"Financial Markets","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.intro-financial-instruments","title":"Mechanics of Financial Instruments","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.market-microstructure","title":"Market microstructure","description":"","date":"","thumbnail":"/build/market_depth_clob-8d7158d59689e10c78a15c00090f3dc4.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.algorithmic-trading","title":"Algorithmic Trading","description":"","date":"","thumbnail":"/build/limit_vs_market-0a6d7ce61f57effed138b6bb69160517.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Financial Modelling Fundamentals"},{"slug":"markdown.intro-bayesian","title":"Bayesian Modelling","description":"","date":"","thumbnail":"/build/BernoulliUniformPrio-612a838836d4fde1c1b34df2b9eb9c9d.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.intro-causal","title":"Causal inference","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.stochastic-calculus","title":"Stochastic Calculus","description":"","date":"","thumbnail":"/build/num_inflation_target-584cfec49aaf388290dcb09ab4055202.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.stochastic-optimal-control","title":"Stochastic optimal control","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.data-driven-methods","title":"Data-driven methods","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.generative-ai","title":"Generative Artificial Intelligence","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Execution Algorithms"},{"slug":"markdown.execution-fundamentals","title":"Execution fundamentals","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.lob-models","title":"Modelling the Limit Order Book","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.almgren-chriss","title":"The Almgren - Chriss Framework","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.execution-tactics","title":"Execution tactics","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Market Making Algorithms"},{"slug":"markdown.market-making-fundamentals","title":"Market Making fundamentals","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.fair-price-estimation","title":"Fair value estimation","description":"","date":"","thumbnail":"/build/kalman_correlated-8857bc936e112d039ba99093affb1fea.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.liquidity-modelling","title":"Liquidity modelling","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.rfq-models","title":"Modelling RfQs in Dealer to Client Markets","description":"","date":"","thumbnail":"/build/pgm_rfq-e1698d70d99c736157fd61e8c19c7918.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.avellaneda-stoikov","title":"The Avellaneda and Stoikov Framework","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.enriching-avellaneda","title":"Enriching the Avellaneda and Stoikov Model","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.hedging","title":"Hedging strategies","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.market-making-rl","title":"Reinforcement Learning and Market Making","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Investment Algorithms"},{"slug":"markdown.quant-investment-fundamentals","title":"Quantitative investment fundamentals","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.mean-reversion-strategies","title":"Mean reversion strategies","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.trend-following","title":"Trend following strategies","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.arbitrage","title":"Arbitrage Strategies","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.factor-investing","title":"Factor Investing","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.optimal-portfolios","title":"Optimal portfolios","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Glossary and References"},{"slug":"markdown.glossary","title":"Glossary","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.references","title":"References","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Notebooks"},{"slug":"notebooks.stochastic-calculus","title":"Stochastic Calculus","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.bayesian-theory","title":"Bayesian Modelling","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.market-microstructure","title":"Market Microstructure","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.rfq-models","title":"Modelling RfQs in Dealer to Client Markets","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.fair-price-estimation","title":"Fair Price Estimation","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2}]}]},"CONTENT_CDN_PORT":"3102","MODE":"static"},"routes/$":{"config":{"version":3,"myst":"1.7.0","options":{"folders":true},"nav":[],"actions":[{"title":"Data Science Algo Trading","url":"https://www.datasciencealgotrading.com","internal":false,"static":false}],"projects":[{"bibliography":["/Users/javier/Documents/aaat/references.bib"],"exports":[],"title":"Advanced Analytics and Algorithmic Trading","authors":[{"nameParsed":{"literal":"Javier Sabio González","given":"Javier Sabio","family":"González"},"name":"Javier Sabio González","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/xaviweise/aaat","toc":[{"file":"welcome.md"},{"children":[{"file":"markdown/releases.md"},{"file":"markdown/dedication.md"},{"file":"markdown/preface.md"},{"file":"markdown/symbollist.md"}],"title":"Introduction"},{"children":[{"file":"markdown/intro_financial_markets.md"},{"file":"markdown/intro_financial_instruments.md"},{"file":"markdown/market_microstructure.md"},{"file":"markdown/algorithmic_trading.md"}],"title":"Financial Markets Fundamentals"},{"children":[{"file":"markdown/intro_bayesian.md"},{"file":"markdown/intro_causal.md"},{"file":"markdown/stochastic_calculus.md"},{"file":"markdown/stochastic_optimal_control.md"},{"file":"markdown/data_driven_methods.md"},{"file":"markdown/generative_ai.md"}],"title":"Financial Modelling Fundamentals"},{"children":[{"file":"markdown/execution_fundamentals.md"},{"file":"markdown/lob_models.md"},{"file":"markdown/almgren_chriss.md"},{"file":"markdown/execution_tactics.md"}],"title":"Execution Algorithms"},{"children":[{"file":"markdown/market_making_fundamentals.md"},{"file":"markdown/fair_price_estimation.md"},{"file":"markdown/liquidity_modelling.md"},{"file":"markdown/rfq_models.md"},{"file":"markdown/avellaneda_stoikov.md"},{"file":"markdown/enriching_avellaneda.md"},{"file":"markdown/hedging.md"},{"file":"markdown/market_making_rl.md"}],"title":"Market Making Algorithms"},{"children":[{"file":"markdown/quant_investment_fundamentals.md"},{"file":"markdown/mean_reversion_strategies.md"},{"file":"markdown/trend_following.md"},{"file":"markdown/arbitrage.md"},{"file":"markdown/factor_investing.md"},{"file":"markdown/optimal_portfolios.md"}],"title":"Investment Algorithms"},{"children":[{"file":"markdown/glossary.md"},{"file":"markdown/references.md"}],"title":"Glossary and References"},{"children":[{"file":"notebooks/stochastic_calculus.ipynb"},{"file":"notebooks/bayesian_theory.ipynb"},{"file":"notebooks/market_microstructure.ipynb"},{"file":"notebooks/rfq_models.ipynb"},{"file":"notebooks/fair_price_estimation.ipynb"}],"title":"Notebooks"}],"thumbnail":"/build/cover-09caa9dd03fd74a2e96de11fa5332265.jpg","index":"index","pages":[{"level":1,"title":"Introduction"},{"slug":"markdown.releases","title":"Release Notes","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.dedication","title":"Dedication","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.preface","title":"Preface","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.symbollist","title":"Symbols","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Financial Markets Fundamentals"},{"slug":"markdown.intro-financial-markets","title":"Financial Markets","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.intro-financial-instruments","title":"Mechanics of Financial Instruments","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.market-microstructure","title":"Market microstructure","description":"","date":"","thumbnail":"/build/market_depth_clob-8d7158d59689e10c78a15c00090f3dc4.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.algorithmic-trading","title":"Algorithmic Trading","description":"","date":"","thumbnail":"/build/limit_vs_market-0a6d7ce61f57effed138b6bb69160517.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Financial Modelling Fundamentals"},{"slug":"markdown.intro-bayesian","title":"Bayesian Modelling","description":"","date":"","thumbnail":"/build/BernoulliUniformPrio-612a838836d4fde1c1b34df2b9eb9c9d.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.intro-causal","title":"Causal inference","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.stochastic-calculus","title":"Stochastic Calculus","description":"","date":"","thumbnail":"/build/num_inflation_target-584cfec49aaf388290dcb09ab4055202.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.stochastic-optimal-control","title":"Stochastic optimal control","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.data-driven-methods","title":"Data-driven methods","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.generative-ai","title":"Generative Artificial Intelligence","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Execution Algorithms"},{"slug":"markdown.execution-fundamentals","title":"Execution fundamentals","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.lob-models","title":"Modelling the Limit Order Book","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.almgren-chriss","title":"The Almgren - Chriss Framework","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.execution-tactics","title":"Execution tactics","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Market Making Algorithms"},{"slug":"markdown.market-making-fundamentals","title":"Market Making fundamentals","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.fair-price-estimation","title":"Fair value estimation","description":"","date":"","thumbnail":"/build/kalman_correlated-8857bc936e112d039ba99093affb1fea.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.liquidity-modelling","title":"Liquidity modelling","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.rfq-models","title":"Modelling RfQs in Dealer to Client Markets","description":"","date":"","thumbnail":"/build/pgm_rfq-e1698d70d99c736157fd61e8c19c7918.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.avellaneda-stoikov","title":"The Avellaneda and Stoikov Framework","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.enriching-avellaneda","title":"Enriching the Avellaneda and Stoikov Model","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.hedging","title":"Hedging strategies","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.market-making-rl","title":"Reinforcement Learning and Market Making","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Investment Algorithms"},{"slug":"markdown.quant-investment-fundamentals","title":"Quantitative investment fundamentals","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.mean-reversion-strategies","title":"Mean reversion strategies","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.trend-following","title":"Trend following strategies","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.arbitrage","title":"Arbitrage Strategies","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.factor-investing","title":"Factor Investing","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.optimal-portfolios","title":"Optimal portfolios","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Glossary and References"},{"slug":"markdown.glossary","title":"Glossary","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.references","title":"References","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Notebooks"},{"slug":"notebooks.stochastic-calculus","title":"Stochastic Calculus","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.bayesian-theory","title":"Bayesian Modelling","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.market-microstructure","title":"Market Microstructure","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.rfq-models","title":"Modelling RfQs in Dealer to Client Markets","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.fair-price-estimation","title":"Fair Price Estimation","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2}]}]},"page":{"version":3,"kind":"Notebook","sha256":"0877ea6b5615327e20517a91620ce0ca26c0164c1a3edf54fc2c160d56f721a7","slug":"notebooks.fair-price-estimation","location":"/notebooks/fair_price_estimation.ipynb","dependencies":[],"frontmatter":{"title":"Fair Price Estimation","content_includes_title":true,"kernelspec":{"name":"python3","display_name":"base","language":"python"},"authors":[{"nameParsed":{"literal":"Javier Sabio González","given":"Javier Sabio","family":"González"},"name":"Javier Sabio González","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/xaviweise/aaat","numbering":{"title":{"offset":1}},"source_url":"https://github.com/xaviweise/aaat/blob/main/notebooks/fair_price_estimation.ipynb","edit_url":"https://github.com/xaviweise/aaat/edit/main/notebooks/fair_price_estimation.ipynb","exports":[{"format":"ipynb","filename":"fair_price_estimation.ipynb","url":"/build/fair_price_estimatio-ac91252b8780d4a3bd9282a46404873e.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[],"key":"rM7OUsgfEY"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Fair Price Estimation","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DZRs2c31Le"}],"identifier":"fair-price-estimation","label":"Fair Price Estimation","html_id":"fair-price-estimation","implicit":true,"key":"MwEuwzd7lx"}],"key":"Gi4omT66bB"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Pricing of flow products","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pJb0kXy4Rm"}],"identifier":"pricing-of-flow-products","label":"Pricing of flow products","html_id":"pricing-of-flow-products","implicit":true,"key":"NVyegf7JZI"},{"type":"heading","depth":3,"position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"The Kalman Filter model for pricing","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"LQx38XKwE6"}],"identifier":"the-kalman-filter-model-for-pricing","label":"The Kalman Filter model for pricing","html_id":"the-kalman-filter-model-for-pricing","implicit":true,"key":"dK5XA7zAxS"}],"key":"TvhiapiA2z"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Compromise execution: run full algorithm but with fewer timesteps/day so it completes here.\n# Use 22 days × 60 steps/day = 1320 timesteps (faster but pattern preserved).\nimport numpy as np\nimport matplotlib.pyplot as plt\nnp.random.seed(100)\n\ndef make_obs_pattern(days=22, steps_per_day=60):\n    pattern = []\n    for _ in range(days):\n        base = steps_per_day // 3\n        rem = steps_per_day - 3 * base\n        for _ in range(base): pattern.append(np.array([1, 0], dtype=bool))\n        for _ in range(base): pattern.append(np.array([1, 1], dtype=bool))\n        for _ in range(base + rem): pattern.append(np.array([0, 1], dtype=bool))\n    return np.array(pattern)\n\ndef simulate_continuous_trades(Q, R, obs_pattern):\n    # Q is the covariance matrix of the mid-price process\n    # R is the covariance matrix of the observation process\n    T = len(obs_pattern); n = Q.shape[0]\n    mids = np.zeros((T, n)); trades = np.zeros((T,n))\n    for t in range(1, T):\n        mids[t] = mids[t-1] + np.random.multivariate_normal(np.zeros(n), Q)\n    for t in range(T):\n        trades[t] = mids[t] + np.random.multivariate_normal(np.zeros(n), R)\n    return mids, trades\n\ndef kalman_filter_timevarying(y, R_time, A, Q, x0=None, P0=None):\n    T = y.shape[0]; n = A.shape[0]\n    xs = np.zeros((T, n)); Ps = np.zeros((T, n, n))\n    if x0 is None: x0 = np.zeros(n)\n    if P0 is None: P0 = np.eye(n)\n    x_pred = x0.copy(); P_pred = P0.copy()\n    for t in range(T):\n        R_t = R_time[t]\n        S = P_pred + R_t + np.eye(n)*1e-12\n        K = P_pred @ np.linalg.inv(S)\n        innov = y[t] - x_pred\n        x_upd = x_pred + K @ innov\n        P_upd = (np.eye(n) - K) @ P_pred\n        xs[t] = x_upd; Ps[t] = P_upd\n        x_pred = A @ x_upd\n        P_pred = A @ P_upd @ A.T + Q\n    return xs, Ps\n\ndef rts_smoother(xs, Ps, A, Q):\n    T, n = xs.shape\n    x_s = np.zeros_like(xs); P_s = np.zeros_like(Ps)\n    x_s[-1] = xs[-1].copy(); P_s[-1] = Ps[-1].copy()\n    for t in range(T-2, -1, -1):\n        P_pred = A @ Ps[t] @ A.T + Q + np.eye(n)*1e-12\n        J = Ps[t] @ A.T @ np.linalg.inv(P_pred)\n        x_s[t] = xs[t] + J @ (x_s[t+1] - A @ xs[t])\n        P_s[t] = Ps[t] + J @ (P_s[t+1] - P_pred) @ J.T\n    return x_s, P_s\n\ndef em_timevaryingR(y, obs_pattern, A, large_R=1e8, max_iter=25, tol=1e-6):\n    T, n = y.shape\n    Q = np.eye(n) * 1e-4\n    R_diag = np.array([1e-3, 2e-3])\n    prev_ll = -np.inf; history = []\n    for it in range(max_iter):\n        R_time = np.zeros((T,n,n))\n        for t in range(T):\n            diag = np.array([R_diag[i] if obs_pattern[t,i] else large_R for i in range(n)])\n            R_time[t] = np.diag(diag)\n        xs_filt, Ps_filt = kalman_filter_timevarying(y, R_time, A, Q)\n        xs_smooth, Ps_smooth = rts_smoother(xs_filt, Ps_filt, A, Q)\n        Exx = Ps_smooth + np.einsum('ti,tj-\u003etij', xs_smooth, xs_smooth)\n        Exx_lag = np.zeros((T-1,n,n))\n        for t in range(1,T):\n            P_pred = A @ Ps_filt[t-1] @ A.T + Q\n            J = Ps_filt[t-1] @ A.T @ np.linalg.inv(P_pred + np.eye(n)*1e-12)\n            P_t_t1 = J @ Ps_smooth[t]\n            Exx_lag[t-1] = P_t_t1 + np.outer(xs_smooth[t], xs_smooth[t-1])\n        sumQ = np.zeros((n,n))\n        for t in range(1,T):\n            sumQ += Exx[t] - Exx_lag[t-1] - Exx_lag[t-1].T + Exx[t-1]\n        Q_new = (sumQ / (T-1) + sumQ.T / (T-1)) / 2\n        R_new = np.zeros(n); counts = np.zeros(n,dtype=int)\n        for t in range(T):\n            for i in range(n):\n                if obs_pattern[t,i]:\n                    y_i = y[t,i]; Ex_i = xs_smooth[t,i]; Exx_ii = Exx[t,i,i]\n                    R_new[i] += (y_i*y_i - 2*y_i*Ex_i + Exx_ii)\n                    counts[i] += 1\n        for i in range(n):\n            if counts[i]\u003e0:\n                R_new[i] = R_new[i] / counts[i]\n            else:\n                R_new[i] = R_diag[i]\n        Q_new += np.eye(n)*1e-12\n        R_new = np.maximum(R_new, 1e-12)\n        Q = 0.7*Q + 0.3*Q_new\n        R_diag = 0.7*R_diag + 0.3*R_new\n        history.append((Q.copy(), R_diag.copy()))\n        # approx ll\n        ll = 0.0; x_pred = np.zeros(n); P_pred = np.eye(n)\n        for t in range(T):\n            R_t = np.diag([R_diag[i] if obs_pattern[t,i] else large_R for i in range(n)])\n            S = P_pred + R_t + np.eye(n)*1e-12\n            innov = y[t] - x_pred\n            invS = np.linalg.inv(S)\n            ll += -0.5*(np.log(np.linalg.det(2*np.pi*S)) + innov.T @ invS @ innov)\n            K = P_pred @ invS\n            x_upd = x_pred + K @ innov\n            P_upd = (np.eye(n) - K) @ P_pred\n            x_pred = A @ x_upd\n            P_pred = A @ P_upd @ A.T + Q\n        if it\u003e0 and abs(ll - prev_ll) \u003c tol:\n            break\n        prev_ll = ll\n    return Q, np.diag(R_diag), history, ll\n\n# Run with 22 days x 60 steps/day\ndays = 22; steps_per_day = 60\nobs_pattern = make_obs_pattern(days, steps_per_day); T = len(obs_pattern)\n# Parameters\nrho = 0.9   # correlation\nsigma1 = np.sqrt(5e-4)   # std of instrument 1\nsigma2 = np.sqrt(4e-4)   # std of instrument 2\n# Construct covariance matrix\nQ_true = np.array([\n    [sigma1**2, rho * sigma1 * sigma2],\n    [rho * sigma1 * sigma2, sigma2**2]\n]) # We make transition covariance non-diagonal\nR_true = np.diag([1e-3,2e-3]) # We make observation covariance diagonal\nmids_true, trades = simulate_continuous_trades(Q_true, R_true, obs_pattern)\nT_half = T//2; y_train = trades[:T_half]; y_test = trades[T_half:]\nobs_train = obs_pattern[:T_half]; obs_test = obs_pattern[T_half:]\nmids_test = mids_true[T_half:]; A = np.eye(2)\n\nQ_est, R_est, history, ll_final = em_timevaryingR(y_train, obs_train, A, large_R=1e8, max_iter=25, tol=1e-5)\ndef build_R_time_from_diag(R_diag, obs_pattern, large_R=1e8):\n    T = len(obs_pattern); n = len(R_diag); R_time = np.zeros((T,n,n))\n    for t in range(T):\n        diag = np.array([R_diag[i] if obs_pattern[t,i] else large_R for i in range(n)])\n        R_time[t] = np.diag(diag)\n    return R_time\nR_time_test = build_R_time_from_diag(np.diag(R_est), obs_test, large_R=1e8)\nmids_est, _ = kalman_filter_timevarying(y_test, R_time_test, A, Q_est)\nrmse = np.sqrt(np.mean((mids_est - mids_test)**2, axis=0))\n\nprint(\"T (timesteps):\", T)\nprint(\"True Q:\\n\", Q_true)\nprint(\"Estimated Q:\\n\", Q_est)\nprint(\"True R diag:\", np.diag(R_true))\nprint(\"Estimated R diag:\", np.diag(R_est))\nprint(\"Final approx loglik:\", ll_final)\nprint(\"RMSE on second half:\", rmse)\n\n# Plot window without showing trades when market closed\nplt.figure(figsize=(14, 8))\nw0 = 200\nw1 = min(w0 + 200, y_test.shape[0])\nt = np.arange(T_half + w0, T_half + w1)\n\n# Rerun filter on test to get covariance sequence for error bars\nmids_est, Ps_est = kalman_filter_timevarying(y_test, R_time_test, A, Q_est)\n\n# Extract ±1 std from diagonal of P (filter uncertainty)\nstds = np.sqrt(np.array([np.diag(P) for P in Ps_est]))\n\n# --- Instrument 1 ---\nplt.subplot(2, 1, 1)\nplt.plot(t, mids_test[w0:w1, 0], label='True mid 1', lw=2)\nplt.plot(t, mids_est[w0:w1, 0], label='Estimated mid 1', lw=1.5, ls='--')\nplt.fill_between(\n    t,\n    mids_est[w0:w1, 0] - stds[w0:w1, 0],\n    mids_est[w0:w1, 0] + stds[w0:w1, 0],\n    color='gray', alpha=0.2, label='±1 std (KF)'\n)\nmask_plot = obs_test[w0:w1, 0]\nplt.scatter(t[mask_plot], y_test[w0:w1, 0][mask_plot],\n            s=8, label='Trades 1 (open)', alpha=0.6)\nplt.title('Instrument 1')\nplt.legend()\n\n# --- Instrument 2 ---\nplt.subplot(2, 1, 2)\nplt.plot(t, mids_test[w0:w1, 1], label='True mid 2', lw=2)\nplt.plot(t, mids_est[w0:w1, 1], label='Estimated mid 2', lw=1.5, ls='--')\nplt.fill_between(\n    t,\n    mids_est[w0:w1, 1] - stds[w0:w1, 1],\n    mids_est[w0:w1, 1] + stds[w0:w1, 1],\n    color='gray', alpha=0.2, label='±1 std (KF)'\n)\nmask_plot1 = obs_test[w0:w1, 1]\nplt.scatter(t[mask_plot1], y_test[w0:w1, 1][mask_plot1],\n            s=8, label='Trades 2 (open)', alpha=0.6)\nplt.title('Instrument 2')\nplt.legend()\n\nplt.tight_layout()\nplt.show()\n\n","key":"hFWdLbZ9QR"},{"type":"outputs","id":"X6NkR1XNFCTOO2Z8Gnsxc","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"T (timesteps): 1320\nTrue Q:\n [[0.0005     0.00040249]\n [0.00040249 0.0004    ]]\nEstimated Q:\n [[0.00031037 0.0001628 ]\n [0.0001628  0.00022782]]\nTrue R diag: [0.001 0.002]\nEstimated R diag: [0.00117355 0.00253554]\nFinal approx loglik: -3121.7461477103247\nRMSE on second half: [0.03244913 0.09017213]\n"},"children":[],"key":"aNfcdoIeqz"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"98bd8bd742243ae50dd6f3cfb65dd6de","path":"/build/98bd8bd742243ae50dd6f3cfb65dd6de.png"},"text/plain":{"content":"\u003cFigure size 1400x800 with 2 Axes\u003e","content_type":"text/plain"}}},"children":[],"key":"fUDw4LrYid"}],"key":"Od7nKgxwS8"}],"key":"gsx93G9OKu"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The utility indifference theory for derivatives pricing","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KR9nsIboxF"}],"identifier":"the-utility-indifference-theory-for-derivatives-pricing","label":"The utility indifference theory for derivatives pricing","html_id":"the-utility-indifference-theory-for-derivatives-pricing","implicit":true,"key":"pKsbVW8u1x"}],"key":"HPSFBIz54k"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Call option premium using the utility indifference principle","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ytNmRFHqSL"}],"identifier":"call-option-premium-using-the-utility-indifference-principle","label":"Call option premium using the utility indifference principle","html_id":"call-option-premium-using-the-utility-indifference-principle","implicit":true,"key":"MmwmAqDHxK"}],"key":"tx9JuaXlYm"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import numpy as np\nimport matplotlib.pyplot as plt\nfrom scipy.stats import norm\n\n# Black-Scholes formula with drift implementation\ndef black_scholes_with_drift(S, K, T, t, r, mu, sigma):\n    d1_mu = (np.log(S / K) + (mu + 0.5 * sigma**2) * (T - t)) / (sigma * np.sqrt(T - t))\n    d2_mu = d1_mu - sigma * np.sqrt(T - t)\n    call_price_with_drift = S * np.exp((mu - r) * (T - t)) * norm.cdf(d1_mu) - K * np.exp(-r * (T - t)) * norm.cdf(d2_mu)\n    return call_price_with_drift\n\n# Parameters for the plots\nS_t = 100   # Current stock price\nK = 100     # Strike price\nT = 1       # Time to maturity (1 year)\nt = 0       # Current time (now)\nr = 0.05    # Risk-free interest rate (5%)\nmu = 0.1    # Drift rate (10%)\nsigma = 0.2 # Volatility (20%)\n\n# Generate data for each dependency plot\nS_values = np.linspace(50, 150, 400)\nK_values = np.linspace(50, 150, 400)\nT_values = np.linspace(0.01, 2, 400)\nr_values = np.linspace(0, 0.2, 400)\nsigma_values = np.linspace(0.01, 1, 400)\nmu_values = np.linspace(-0.1, 0.3, 400)\n\n# Calculate call prices with drift\nC_S_drift = [black_scholes_with_drift(S, K, T, t, r, mu, sigma) for S in S_values]\nC_K_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for K in K_values]\nC_T_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for T in T_values]\nC_r_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for r in r_values]\nC_sigma_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for sigma in sigma_values]\nC_mu_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for mu in mu_values]\n\n# Plotting all dependencies in a single figure for export\n\nfig, axs = plt.subplots(3, 2, figsize=(15, 18))\n\n# Current Stock Price (S) with Drift\naxs[0, 0].plot(S_values, C_S_drift)\naxs[0, 0].set_title('Call Option Price vs Current Stock Price (S) with Drift')\naxs[0, 0].set_xlabel('Current Stock Price (S)')\naxs[0, 0].set_ylabel('Call Option Price (P)')\naxs[0, 0].grid(True)\n\n# Strike Price (K) with Drift\naxs[0, 1].plot(K_values, C_K_drift)\naxs[0, 1].set_title('Call Option Price vs Strike Price (K) with Drift')\naxs[0, 1].set_xlabel('Strike Price (K)')\naxs[0, 1].set_ylabel('Call Option Price (P)')\naxs[0, 1].grid(True)\n\n# Time to Maturity (T) with Drift\naxs[1, 0].plot(T_values, C_T_drift)\naxs[1, 0].set_title('Call Option Price vs Time to Maturity (T) with Drift')\naxs[1, 0].set_xlabel('Time to Maturity (T)')\naxs[1, 0].set_ylabel('Call Option Price (P)')\naxs[1, 0].grid(True)\n\n# Risk-Free Interest Rate (r) with Drift\naxs[1, 1].plot(r_values, C_r_drift)\naxs[1, 1].set_title('Call Option Price vs Risk-Free Interest Rate (r) with Drift')\naxs[1, 1].set_xlabel('Risk-Free Interest Rate (r)')\naxs[1, 1].set_ylabel('Call Option Price (P)')\naxs[1, 1].grid(True)\n\n# Volatility (σ) with Drift\naxs[2, 0].plot(sigma_values, C_sigma_drift)\naxs[2, 0].set_title('Call Option Price vs Volatility (σ) with Drift')\naxs[2, 0].set_xlabel('Volatility (σ)')\naxs[2, 0].set_ylabel('Call Option Price (P)')\naxs[2, 0].grid(True)\n\n# Drift (μ)\naxs[2, 1].plot(mu_values, C_mu_drift)\naxs[2, 1].set_title('Call Option Price vs Drift (μ)')\naxs[2, 1].set_xlabel('Drift (μ)')\naxs[2, 1].set_ylabel('Call Option Price (P)')\naxs[2, 1].grid(True)","key":"IfOOhUVh3J"},{"type":"outputs","id":"Zk2Z4VWaf_C_o_HCbhEmN","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"0357c4253a819a842cf3941221e4e212","path":"/build/0357c4253a819a842cf3941221e4e212.png"},"text/plain":{"content":"\u003cFigure size 1500x1800 with 6 Axes\u003e","content_type":"text/plain"}}},"children":[],"key":"OyBzqTks3p"}],"key":"tid11l5h6B"}],"key":"PL8bvemNO1"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The arbitrage-free theory of derivatives pricing","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"m7VJCnpYOu"}],"identifier":"the-arbitrage-free-theory-of-derivatives-pricing","label":"The arbitrage-free theory of derivatives pricing","html_id":"the-arbitrage-free-theory-of-derivatives-pricing","implicit":true,"key":"O2shdNaOtM"}],"key":"PYDSOvHTTC"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Call option premium using arbitrage-free theory","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IdGT5lfykI"}],"identifier":"call-option-premium-using-arbitrage-free-theory","label":"Call option premium using arbitrage-free theory","html_id":"call-option-premium-using-arbitrage-free-theory","implicit":true,"key":"c9sgwaSk40"}],"key":"SYxKzFR4H7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import numpy as np\nimport matplotlib.pyplot as plt\nfrom scipy.stats import norm\n\n# Black-Scholes formula with drift implementation\ndef black_scholes_with_drift(S, K, T, t, r, mu, sigma):\n    d1_mu = (np.log(S / K) + (mu + 0.5 * sigma**2) * (T - t)) / (sigma * np.sqrt(T - t))\n    d2_mu = d1_mu - sigma * np.sqrt(T - t)\n    call_price_with_drift = S * np.exp((mu - r) * (T - t)) * norm.cdf(d1_mu) - K * np.exp(-r * (T - t)) * norm.cdf(d2_mu)\n    return call_price_with_drift\n\n# Standard Black-Scholes formula (mu = r)\ndef black_scholes_standard(S, K, T, t, r, sigma):\n    return black_scholes_with_drift(S, K, T, t, r, r, sigma)\n\n# Parameters for the plots\nS_t = 100   # Current stock price\nK = 100     # Strike price\nT = 1       # Time to maturity (1 year)\nt = 0       # Current time (now)\nr = 0.05    # Risk-free interest rate (5%)\nmu = 0.1    # Drift rate (10%)\nsigma = 0.2 # Volatility (20%)\n\n# Generate data for each dependency plot\nS_values = np.linspace(50, 150, 400)\nK_values = np.linspace(50, 150, 400)\nT_values = np.linspace(0.01, 2, 400)\nr_values = np.linspace(0, 0.2, 400)\nsigma_values = np.linspace(0.01, 1, 400)\nmu_values = np.linspace(-0.1, 0.3, 400)\n\n# Calculate call prices with drift\nC_S_drift = [black_scholes_with_drift(S, K, T, t, r, mu, sigma) for S in S_values]\nC_K_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for K in K_values]\nC_T_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for T in T_values]\nC_r_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for r in r_values]\nC_sigma_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for sigma in sigma_values]\nC_mu_drift = [black_scholes_with_drift(S_t, K, T, t, r, mu, sigma) for mu in mu_values]\n\n# Calculate call prices using standard Black-Scholes formula (mu = r)\nC_S_standard = [black_scholes_standard(S, K, T, t, r, sigma) for S in S_values]\nC_K_standard = [black_scholes_standard(S_t, K, T, t, r, sigma) for K in K_values]\nC_T_standard = [black_scholes_standard(S_t, K, T, t, r, sigma) for T in T_values]\nC_r_standard = [black_scholes_standard(S_t, K, T, t, r, sigma) for r in r_values]\nC_sigma_standard = [black_scholes_standard(S_t, K, T, t, r, sigma) for sigma in sigma_values]\nC_mu_standard = [black_scholes_standard(S_t, K, T, t, r, sigma) for mu in mu_values]\n\n# Plotting all dependencies in a single figure for comparison\nfig, axs = plt.subplots(3, 2, figsize=(15, 18))\n\n# Current Stock Price (S) comparison\naxs[0, 0].plot(S_values, C_S_drift, label=\"With Drift (mu = 0.1)\")\naxs[0, 0].plot(S_values, C_S_standard, label=\"Standard (mu = r)\", linestyle=\"--\")\naxs[0, 0].set_title('Call Option Price vs Current Stock Price (S)')\naxs[0, 0].set_xlabel('Current Stock Price (S)')\naxs[0, 0].set_ylabel('Call Option Price (P)')\naxs[0, 0].legend()\naxs[0, 0].grid(True)\n\n# Strike Price (K) comparison\naxs[0, 1].plot(K_values, C_K_drift, label=\"With Drift (mu = 0.1)\")\naxs[0, 1].plot(K_values, C_K_standard, label=\"Standard (mu = r)\", linestyle=\"--\")\naxs[0, 1].set_title('Call Option Price vs Strike Price (K)')\naxs[0, 1].set_xlabel('Strike Price (K)')\naxs[0, 1].set_ylabel('Call Option Price (P)')\naxs[0, 1].legend()\naxs[0, 1].grid(True)\n\n# Time to Maturity (T) comparison\naxs[1, 0].plot(T_values, C_T_drift, label=\"With Drift (mu = 0.1)\")\naxs[1, 0].plot(T_values, C_T_standard, label=\"Standard (mu = r)\", linestyle=\"--\")\naxs[1, 0].set_title('Call Option Price vs Time to Maturity (T)')\naxs[1, 0].set_xlabel('Time to Maturity (T)')\naxs[1, 0].set_ylabel('Call Option Price (P)')\naxs[1, 0].legend()\naxs[1, 0].grid(True)\n\n# Risk-Free Interest Rate (r) comparison\naxs[1, 1].plot(r_values, C_r_drift, label=\"With Drift (mu = 0.1)\")\naxs[1, 1].plot(r_values, C_r_standard, label=\"Standard (mu = r)\", linestyle=\"--\")\naxs[1, 1].set_title('Call Option Price vs Risk-Free Interest Rate (r)')\naxs[1, 1].set_xlabel('Risk-Free Interest Rate (r)')\naxs[1, 1].set_ylabel('Call Option Price (P)')\naxs[1, 1].legend()\naxs[1, 1].grid(True)\n\n# Volatility (σ) comparison\naxs[2, 0].plot(sigma_values, C_sigma_drift, label=\"With Drift (mu = 0.1)\")\naxs[2, 0].plot(sigma_values, C_sigma_standard, label=\"Standard (mu = r)\", linestyle=\"--\")\naxs[2, 0].set_title('Call Option Price vs Volatility (σ)')\naxs[2, 0].set_xlabel('Volatility (σ)')\naxs[2, 0].set_ylabel('Call Option Price (P)')\naxs[2, 0].legend()\naxs[2, 0].grid(True)\n\n# Drift (μ) comparison\naxs[2, 1].plot(mu_values, C_mu_drift, label=\"With Drift (mu = varying)\")\naxs[2, 1].plot(mu_values, C_mu_standard, label=\"Standard (mu = r)\", linestyle=\"--\")\naxs[2, 1].set_title('Call Option Price vs Drift (μ)')\naxs[2, 1].set_xlabel('Drift (μ)')\naxs[2, 1].set_ylabel('Call Option Price (P)')\naxs[2, 1].legend()\naxs[2, 1].grid(True)\n\nplt.tight_layout()\nplt.show()\n","key":"J06nLkEfsN"},{"type":"outputs","id":"WNt7qOFF5eGoOzMgMLNHC","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"b943001b0796b61535a083e024d7fe00","path":"/build/b943001b0796b61535a083e024d7fe00.png"},"text/plain":{"content":"\u003cFigure size 1500x1800 with 6 Axes\u003e","content_type":"text/plain"}}},"children":[],"key":"DxN8abB0An"}],"key":"sG6WZS4p4L"}],"key":"THUeGsKssb"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Using the BSM framework in practice","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Zas87q47e4"}],"identifier":"using-the-bsm-framework-in-practice","label":"Using the BSM framework in practice","html_id":"using-the-bsm-framework-in-practice","implicit":true,"key":"noLa0kGcXP"}],"key":"Mj7lL6kZXK"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import numpy as np\nimport matplotlib.pyplot as plt\nfrom scipy.stats import norm\nimport pandas as pd\n\ndef black_scholes_price(S, K, T, r, sigma, option_type='call'):\n    \"\"\"\n    Calculate Black-Scholes option price.\n    \"\"\"\n    d1 = (np.log(S / K) + (r + 0.5 * sigma **2 ) * T ) / (sigma * np.sqrt(T))\n    d2 = d1 - sigma * np.sqrt(T)\n    \n    if option_type == 'call':\n        price = S * norm.cdf(d1) - K * np.exp(-r * T) * norm.cdf(d2)\n    elif option_type == 'put':\n        price = K * np.exp(-r * T) * norm.cdf(-d2) - S * norm.cdf(-d1)\n    else:\n        raise ValueError(\"option_type must be 'call' or 'put'\")\n    return price\n\ndef black_scholes_delta(S, K, T, r, sigma, option_type='call'):\n    \"\"\"\n    Calculate Black-Scholes option delta.\n    \"\"\"\n    d1 = (np.log(S / K) + (r + 0.5 * sigma **2 ) * T ) / (sigma * np.sqrt(T))\n    \n    if option_type == 'call':\n        delta = norm.cdf(d1)\n    elif option_type == 'put':\n        delta = norm.cdf(d1) - 1\n    else:\n        raise ValueError(\"option_type must be 'call' or 'put'\")\n    return delta\n\ndef simulate_gbm_paths(S0, mu, sigma, T, dt, n_paths, \n                      stochastic_vol=False, kappa=2.0, theta=0.04, xi=0.2, rho=-0.7):\n    \"\"\"\n    Simulate GBM paths with optional stochastic volatility based on the Heston model.\n    \n    Parameters:\n    - S0: initial stock price\n    - mu: drift\n    - sigma: initial volatility\n    - T: maturity\n    - dt: time step\n    - n_paths: number of simulation paths\n    - stochastic_vol: if True, use the Heston stochastic volatility model\n    - kappa: rate of mean reversion of variance (only if stochastic_vol=True)\n    - theta: long-term variance mean (only if stochastic_vol=True)\n    - xi: volatility of variance (only if stochastic_vol=True)\n    - rho: correlation between stock and variance (only if stochastic_vol=True)\n    \n    Returns:\n    - paths: array of shape (n_steps +1, n_paths)\n    \"\"\"\n    n_steps = int(T / dt)\n    paths = np.zeros((n_steps +1, n_paths))\n    paths[0] = S0\n    \n    if stochastic_vol:\n        # Initialize variance\n        V0 = sigma ** 2\n        variances = np.zeros((n_steps +1, n_paths))\n        variances[0] = V0\n        \n        # Precompute correlation matrix and Cholesky decomposition\n        cov_matrix = np.array([[1.0, rho],\n                               [rho, 1.0]])\n        L = np.linalg.cholesky(cov_matrix)\n        \n        for t in range(1, n_steps +1):\n            # Simulate two correlated random variables\n            Z = np.random.standard_normal((2, n_paths))\n            correlated_Z = L @ Z\n            Z_S = correlated_Z[0]\n            Z_V = correlated_Z[1]\n            \n            # Update variance using CIR process\n            V_prev = variances[t-1]\n            V = V_prev + kappa * (theta - V_prev) * dt + xi * np.sqrt(np.maximum(V_prev, 0)) * np.sqrt(dt) * Z_V\n            V = np.maximum(V, 0)  # Ensure variance is non-negative\n            variances[t] = V\n            \n            # Update stock price\n            S_prev = paths[t-1]\n            S = S_prev * np.exp( (mu - 0.5 * V_prev) * dt + np.sqrt(V_prev) * np.sqrt(dt) * Z_S )\n            paths[t] = S\n    else:\n        for t in range(1, n_steps +1):\n            Z = np.random.standard_normal(n_paths)\n            paths[t] = paths[t-1] * np.exp( (mu - 0.5 * sigma **2 ) * dt + sigma * np.sqrt(dt) * Z )\n    \n    return paths\n\ndef dynamic_hedging(paths, S0, K, T, r, sigma_bs, option_type='call', dt=1/252,\n                   rehedge_freq=1, half_spread=0.0, sigma_sim=None):\n    \"\"\"\n    Implement dynamic hedging strategy.\n    \n    Parameters:\n    - paths: simulated stock price paths (array of shape (n_steps+1, n_paths))\n    - S0: initial stock price\n    - K: strike price\n    - T: maturity\n    - r: risk-free rate\n    - sigma_bs: volatility used in BS model\n    - option_type: 'call' or 'put'\n    - dt: time step size\n    - rehedge_freq: frequency of rehedging in terms of number of steps. If 1, rebalance every step.\n    - half_spread: transaction cost as a fraction of price (half spread for buying and selling)\n    - sigma_sim: volatility used in simulation (if different from sigma_bs)\n    \n    Returns:\n    - differences: array of portfolio - payoff for each path\n    \"\"\"\n    n_steps, n_paths = paths.shape[0]-1, paths.shape[1]\n    # Calculate option price and initial delta\n    option_price = black_scholes_price(S0, K, T, r, sigma_bs, option_type)\n    option_delta = black_scholes_delta(S0, K, T, r, sigma_bs, option_type)\n    \n    # Initialize portfolio\n    portfolio = np.full(n_paths, option_price)\n    stock_position = np.full(n_paths, option_delta)\n    cash_position = portfolio - stock_position * S0\n    \n    # Time steps\n    times = np.linspace(0, T, n_steps +1)\n    \n    # Rehedge steps\n    rehedge_steps = rehedge_freq\n    \n    for t in range(1, n_steps +1):\n        tau = T - times[t]\n        if tau \u003c= 0:\n            tau = 1e-10  # Avoid division by zero\n        \n        # Determine if rebalancing is needed\n        if t % rehedge_steps == 0:\n            # Compute delta using BS formula\n            current_S = paths[t]\n            current_delta = black_scholes_delta(current_S, K, tau, r, sigma_bs, option_type)\n            \n            # Calculate change in delta\n            delta_change = current_delta - stock_position\n            # Calculate transaction cost\n            transaction_cost = half_spread * np.abs(delta_change * current_S)\n            \n            # Update cash position\n            cash_position = cash_position * np.exp(r * dt) - delta_change * current_S - transaction_cost\n            \n            # Update stock position\n            stock_position = current_delta\n        else:\n            # Just grow the cash position\n            cash_position = cash_position * np.exp(r * dt)\n        \n        # Update portfolio value\n        portfolio = cash_position + stock_position * paths[t]\n    \n    # Option payoff\n    if option_type == 'call':\n        payoff = np.maximum(paths[-1] - K, 0)\n    elif option_type == 'put':\n        payoff = np.maximum(K - paths[-1], 0)\n    else:\n        raise ValueError(\"option_type must be 'call' or 'put'\")\n    \n    differences = portfolio - payoff\n    return differences\n\ndef run_simulation():\n    # Parameters\n    S0 = 100          # Initial stock price\n    K = 100           # Strike price\n    T = 1.0           # 1 year\n    r = 0.05          # 5% risk-free rate\n    sigma_bs = 0.20   # 20% volatility used in Black-Scholes model\n    mu = 0.1          # 10% drift\n    option_type = 'call'\n    n_paths = 10000   # Number of simulation paths\n    dt = 1/10000      # Fixed small time step for accurate approximation\n    \n    # Perfect setup with varying rehedging frequency\n    rehedge_freq_values = [1, 10, 100]  # Rebalance every 1, 10, 100 steps\n    differences_rehedge_freq = {}\n    \n    # Simulate perfect hedging with varying rehedging frequencies\n    for freq in rehedge_freq_values:\n        print(f\"Simulating Perfect Setup with Rehedging Frequency: Every {freq} steps\")\n        paths_perfect = simulate_gbm_paths(S0, mu, sigma_bs, T, dt, n_paths, stochastic_vol=False)\n        differences = dynamic_hedging(paths_perfect, S0, K, T, r, sigma_bs, option_type, dt, \n                                     rehedge_freq=freq, half_spread=0.0)\n        differences_rehedge_freq[freq] = differences\n    \n    # Baseline residuals (Rebalance every step)\n    residuals_perfect = differences_rehedge_freq[1]\n    \n    # Violations\n    # 1. Different volatility for simulation (sigma_sim = 0.19 and 0.21)\n    sigma_sim_values = [0.19, 0.21]\n    differences_sigma_sim = {}\n    for sigma_sim in sigma_sim_values:\n        print(f\"Simulating Different Volatility in Simulation: sigma_sim = {sigma_sim}\")\n        paths_diff_vol = simulate_gbm_paths(S0, mu, sigma_sim, T, dt, n_paths, stochastic_vol=False)\n        differences = dynamic_hedging(paths_diff_vol, S0, K, T, r, sigma_bs, option_type, dt, \n                                     rehedge_freq=1, half_spread=0.0)\n        differences_sigma_sim[sigma_sim] = differences\n    \n    # 2. Stochastic Volatility (Heston Model)\n    print(\"Simulating Stochastic Volatility (Heston Model)\")\n    paths_stoch_vol = simulate_gbm_paths(S0, mu, sigma_bs, T, dt, n_paths, stochastic_vol=True,\n                                        kappa=20.0, theta=0.04, xi=0.2, rho=-0.7)\n    differences_stoch_vol = dynamic_hedging(paths_stoch_vol, S0, K, T, r, sigma_bs, option_type, dt, \n                                           rehedge_freq=1, half_spread=0.0)\n    \n    # 3. Transaction Costs (Half Spread = 0.005%)\n    half_spread = 0.00005  # 0.005%\n    print(\"Simulating With Transaction Costs (Half Spread = 0.005%)\")\n    paths_half_spread = simulate_gbm_paths(S0, mu, sigma_bs, T, dt, n_paths, stochastic_vol=False)\n    differences_half_spread = dynamic_hedging(paths_half_spread, S0, K, T, r, sigma_bs, option_type, dt, \n                                             rehedge_freq=1, half_spread=half_spread)\n    \n    # Plot histograms in a 2x2 grid\n    plt.figure(figsize=(18, 14))\n    \n    # Subplot 1: Effect of Re-Hedging Frequency on Hedging Residuals\n    plt.subplot(2, 2, 1)\n    colors = ['blue', 'green', 'red', 'purple']\n    labels = [f'Rebalance Every {freq} Steps' for freq in rehedge_freq_values]\n    \n    for i, freq in enumerate(rehedge_freq_values):\n        plt.hist(differences_rehedge_freq[freq], bins=100, alpha=0.5, \n                 color=colors[i], label=labels[i], density=True)\n    \n    plt.title('Effect of Re-Hedging Frequency on Hedging Residuals')\n    plt.xlabel('Portfolio - Payoff')\n    plt.ylabel('Density')\n    plt.legend()\n    plt.grid(True)\n    \n    # Subplot 2: Different Volatility in Simulation\n    plt.subplot(2, 2, 2)\n    colors_sigma = ['orange', 'cyan']\n    labels_sigma = [f'sigma_sim = {sigma_sim:.2f}' for sigma_sim in sigma_sim_values]\n    \n    for i, sigma_sim in enumerate(sigma_sim_values):\n        plt.hist(differences_sigma_sim[sigma_sim], bins=100, alpha=0.5, \n                 color=colors_sigma[i], label=labels_sigma[i], density=True)\n    \n    # Add baseline\n    plt.hist(residuals_perfect, bins=100, alpha=0.3, color='black', label='Perfect Replication', density=True)\n    \n    plt.title('Different Volatility in Simulation')\n    plt.xlabel('Portfolio - Payoff')\n    plt.ylabel('Density')\n    plt.legend()\n    plt.grid(True)\n    \n    # Subplot 3: Stochastic Volatility (Heston Model)\n    plt.subplot(2, 2, 3)\n    plt.hist(differences_stoch_vol, bins=100, alpha=0.7, color='purple', edgecolor='black', density=True, label='Stochastic Volatility')\n    \n    # Add baseline\n    plt.hist(residuals_perfect, bins=100, alpha=0.3, color='black', label='Perfect Replication', density=True)\n    \n    plt.title('Stochastic Volatility (Heston Model)')\n    plt.xlabel('Portfolio - Payoff')\n    plt.ylabel('Density')\n    plt.legend()\n    plt.grid(True)\n    \n    # Subplot 4: Transaction Costs (Half Spread)\n    plt.subplot(2, 2, 4)\n    plt.hist(differences_half_spread, bins=100, alpha=0.7, color='green', edgecolor='black', density=True, label='Half Spread = 0.005%')\n    \n    # Add baseline\n    plt.hist(residuals_perfect, bins=100, alpha=0.3, color='black', label='Perfect Replication', density=True)\n    \n    plt.title('Transaction Costs (Half Spread = 0.005%)')\n    plt.xlabel('Portfolio - Payoff')\n    plt.ylabel('Density')\n    plt.legend()\n    plt.grid(True)\n    \n    plt.tight_layout()\n    plt.show()\n    \n    # Summary statistics for Perfect Setup with varied rehedging frequency\n    print(\"Summary Statistics for Perfect Setup with Varied Re-Hedging Frequency:\")\n    for freq, diff in differences_rehedge_freq.items():\n        print(f\"Rebalance Every {freq} Steps: Mean = {np.mean(diff):.6f}, Std Dev = {np.std(diff):.6f}\")\n    print(\"-\"*60)\n    \n    # Summary statistics for Violations\n    print(\"Summary Statistics for Violations:\")\n    \n    # 1. Different Volatility in Simulation\n    for sigma_sim, diff in differences_sigma_sim.items():\n        print(f\"Different Volatility in Simulation (sigma_sim = {sigma_sim:.2f}):\")\n        print(f\"  Mean difference: {np.mean(diff):.6f}\")\n        print(f\"  Std Dev of difference: {np.std(diff):.6f}\")\n    \n    # 2. Stochastic Volatility (Heston Model)\n    print(\"Stochastic Volatility (Heston Model):\")\n    print(f\"  Mean difference: {np.mean(differences_stoch_vol):.6f}\")\n    print(f\"  Std Dev of difference: {np.std(differences_stoch_vol):.6f}\")\n    \n    # 3. Transaction Costs (Half Spread)\n    print(\"Transaction Costs (Half Spread = 0.005%):\")\n    print(f\"  Mean difference: {np.mean(differences_half_spread):.6f}\")\n    print(f\"  Std Dev of difference: {np.std(differences_half_spread):.6f}\")\n    print(\"-\"*40)\n\nif __name__ == \"__main__\":\n    run_simulation()\n","key":"wnCQPMTrPW"},{"type":"outputs","id":"G9tpLJ_B6i5igv2R73W_H","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Simulating Perfect Setup with Rehedging Frequency: Every 1 steps\nSimulating Perfect Setup with Rehedging Frequency: Every 10 steps\nSimulating Perfect Setup with Rehedging Frequency: Every 100 steps\nSimulating Different Volatility in Simulation: sigma_sim = 0.19\nSimulating Different Volatility in Simulation: sigma_sim = 0.21\nSimulating Stochastic Volatility (Heston Model)\nSimulating With Transaction Costs (Half Spread = 0.005%)\n"},"children":[],"key":"z7kXlO33L7"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"3148c4ba80ce7552ab79f8b940948ffa","path":"/build/3148c4ba80ce7552ab79f8b940948ffa.png"},"text/plain":{"content":"\u003cFigure size 1800x1400 with 4 Axes\u003e","content_type":"text/plain"}}},"children":[],"key":"VfVT35ILew"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Summary Statistics for Perfect Setup with Varied Re-Hedging Frequency:\nRebalance Every 1 Steps: Mean = 0.000827, Std Dev = 0.068216\nRebalance Every 10 Steps: Mean = 0.003540, Std Dev = 0.214217\nRebalance Every 100 Steps: Mean = -0.011300, Std Dev = 0.690467\n------------------------------------------------------------\nSummary Statistics for Violations:\nDifferent Volatility in Simulation (sigma_sim = 0.19):\n  Mean difference: 0.381420\n  Std Dev of difference: 0.164161\nDifferent Volatility in Simulation (sigma_sim = 0.21):\n  Mean difference: -0.381580\n  Std Dev of difference: 0.172823\nStochastic Volatility (Heston Model):\n  Mean difference: -0.032125\n  Std Dev of difference: 0.193527\nTransaction Costs (Half Spread = 0.005%):\n  Mean difference: -0.152493\n  Std Dev of difference: 0.092860\n----------------------------------------\n"},"children":[],"key":"MIt05keY80"}],"key":"z1jDnvwoAv"}],"key":"b116YBkKQN"}],"key":"C3C3MBzchJ"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Modelling RfQs in Dealer to Client Markets","url":"/notebooks/rfq-models","group":"Notebooks"}}},"domain":"http://localhost:3002"},"project":{"bibliography":["/Users/javier/Documents/aaat/references.bib"],"exports":[],"title":"Advanced Analytics and Algorithmic Trading","authors":[{"nameParsed":{"literal":"Javier Sabio González","given":"Javier Sabio","family":"González"},"name":"Javier Sabio González","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/xaviweise/aaat","toc":[{"file":"welcome.md"},{"children":[{"file":"markdown/releases.md"},{"file":"markdown/dedication.md"},{"file":"markdown/preface.md"},{"file":"markdown/symbollist.md"}],"title":"Introduction"},{"children":[{"file":"markdown/intro_financial_markets.md"},{"file":"markdown/intro_financial_instruments.md"},{"file":"markdown/market_microstructure.md"},{"file":"markdown/algorithmic_trading.md"}],"title":"Financial Markets Fundamentals"},{"children":[{"file":"markdown/intro_bayesian.md"},{"file":"markdown/intro_causal.md"},{"file":"markdown/stochastic_calculus.md"},{"file":"markdown/stochastic_optimal_control.md"},{"file":"markdown/data_driven_methods.md"},{"file":"markdown/generative_ai.md"}],"title":"Financial Modelling Fundamentals"},{"children":[{"file":"markdown/execution_fundamentals.md"},{"file":"markdown/lob_models.md"},{"file":"markdown/almgren_chriss.md"},{"file":"markdown/execution_tactics.md"}],"title":"Execution Algorithms"},{"children":[{"file":"markdown/market_making_fundamentals.md"},{"file":"markdown/fair_price_estimation.md"},{"file":"markdown/liquidity_modelling.md"},{"file":"markdown/rfq_models.md"},{"file":"markdown/avellaneda_stoikov.md"},{"file":"markdown/enriching_avellaneda.md"},{"file":"markdown/hedging.md"},{"file":"markdown/market_making_rl.md"}],"title":"Market Making Algorithms"},{"children":[{"file":"markdown/quant_investment_fundamentals.md"},{"file":"markdown/mean_reversion_strategies.md"},{"file":"markdown/trend_following.md"},{"file":"markdown/arbitrage.md"},{"file":"markdown/factor_investing.md"},{"file":"markdown/optimal_portfolios.md"}],"title":"Investment Algorithms"},{"children":[{"file":"markdown/glossary.md"},{"file":"markdown/references.md"}],"title":"Glossary and References"},{"children":[{"file":"notebooks/stochastic_calculus.ipynb"},{"file":"notebooks/bayesian_theory.ipynb"},{"file":"notebooks/market_microstructure.ipynb"},{"file":"notebooks/rfq_models.ipynb"},{"file":"notebooks/fair_price_estimation.ipynb"}],"title":"Notebooks"}],"thumbnail":"/build/cover-09caa9dd03fd74a2e96de11fa5332265.jpg","index":"index","pages":[{"level":1,"title":"Introduction"},{"slug":"markdown.releases","title":"Release Notes","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.dedication","title":"Dedication","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.preface","title":"Preface","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.symbollist","title":"Symbols","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Financial Markets Fundamentals"},{"slug":"markdown.intro-financial-markets","title":"Financial Markets","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.intro-financial-instruments","title":"Mechanics of Financial Instruments","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.market-microstructure","title":"Market microstructure","description":"","date":"","thumbnail":"/build/market_depth_clob-8d7158d59689e10c78a15c00090f3dc4.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.algorithmic-trading","title":"Algorithmic Trading","description":"","date":"","thumbnail":"/build/limit_vs_market-0a6d7ce61f57effed138b6bb69160517.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Financial Modelling Fundamentals"},{"slug":"markdown.intro-bayesian","title":"Bayesian Modelling","description":"","date":"","thumbnail":"/build/BernoulliUniformPrio-612a838836d4fde1c1b34df2b9eb9c9d.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.intro-causal","title":"Causal inference","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.stochastic-calculus","title":"Stochastic Calculus","description":"","date":"","thumbnail":"/build/num_inflation_target-584cfec49aaf388290dcb09ab4055202.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.stochastic-optimal-control","title":"Stochastic optimal control","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.data-driven-methods","title":"Data-driven methods","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.generative-ai","title":"Generative Artificial Intelligence","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Execution Algorithms"},{"slug":"markdown.execution-fundamentals","title":"Execution fundamentals","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.lob-models","title":"Modelling the Limit Order Book","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.almgren-chriss","title":"The Almgren - Chriss Framework","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.execution-tactics","title":"Execution tactics","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Market Making Algorithms"},{"slug":"markdown.market-making-fundamentals","title":"Market Making fundamentals","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.fair-price-estimation","title":"Fair value estimation","description":"","date":"","thumbnail":"/build/kalman_correlated-8857bc936e112d039ba99093affb1fea.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.liquidity-modelling","title":"Liquidity modelling","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.rfq-models","title":"Modelling RfQs in Dealer to Client Markets","description":"","date":"","thumbnail":"/build/pgm_rfq-e1698d70d99c736157fd61e8c19c7918.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.avellaneda-stoikov","title":"The Avellaneda and Stoikov Framework","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.enriching-avellaneda","title":"Enriching the Avellaneda and Stoikov Model","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.hedging","title":"Hedging strategies","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.market-making-rl","title":"Reinforcement Learning and Market Making","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Investment Algorithms"},{"slug":"markdown.quant-investment-fundamentals","title":"Quantitative investment fundamentals","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.mean-reversion-strategies","title":"Mean reversion strategies","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.trend-following","title":"Trend following strategies","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.arbitrage","title":"Arbitrage Strategies","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.factor-investing","title":"Factor Investing","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.optimal-portfolios","title":"Optimal portfolios","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Glossary and References"},{"slug":"markdown.glossary","title":"Glossary","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"markdown.references","title":"References","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"level":1,"title":"Notebooks"},{"slug":"notebooks.stochastic-calculus","title":"Stochastic Calculus","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.bayesian-theory","title":"Bayesian Modelling","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.market-microstructure","title":"Market Microstructure","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.rfq-models","title":"Modelling RfQs in Dealer to Client Markets","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.fair-price-estimation","title":"Fair Price Estimation","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2}]}}},"actionData":null,"errors":null},"future":{"unstable_dev":false,"unstable_postcss":false,"unstable_tailwind":false,"v2_errorBoundary":true,"v2_headers":true,"v2_meta":true,"v2_normalizeFormMethod":true,"v2_routeConvention":true}};</script><script type="module" async="">import "/build/manifest-86A905A4.js";
import * as route0 from "/build/root-CXYA7X5D.js";
import * as route1 from "/build/routes/$-JRBPULBO.js";
window.__remixRouteModules = {"root":route0,"routes/$":route1};

import("/build/entry.client-PCJPW7TK.js");</script></body></html>