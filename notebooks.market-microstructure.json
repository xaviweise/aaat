{"version":3,"kind":"Notebook","sha256":"e99a98a2d5b84d2a46205a9be49597f6be8c3365fc2e99942585e534a207ed9b","slug":"notebooks.market-microstructure","location":"/notebooks/market_microstructure.ipynb","dependencies":[],"frontmatter":{"title":"Market Microstructure","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"base","language":"python"},"authors":[{"nameParsed":{"literal":"Javier Sabio González","given":"Javier Sabio","family":"González"},"name":"Javier Sabio González","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/xaviweise/aaat","numbering":{"title":{"offset":1}},"source_url":"https://github.com/xaviweise/aaat/blob/main/notebooks/market_microstructure.ipynb","edit_url":"https://github.com/xaviweise/aaat/edit/main/notebooks/market_microstructure.ipynb","exports":[{"format":"ipynb","filename":"market_microstructure.ipynb","url":"/build/market_microstructur-3ccb014fb1af0fe107dbae889b2488f7.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The Central Limit Order Book","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"RjxUVbxcCC"}],"identifier":"the-central-limit-order-book","label":"The Central Limit Order Book","html_id":"the-central-limit-order-book","implicit":true,"key":"y4ZHyjGZ8q"},{"type":"heading","depth":3,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Visualization of the order book","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"pZ6Zr5LcSg"}],"identifier":"visualization-of-the-order-book","label":"Visualization of the order book","html_id":"visualization-of-the-order-book","implicit":true,"key":"qpdewYT6ha"}],"key":"LJ7YtAojZY"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import matplotlib.pyplot as plt\nimport numpy as np\n\n# Define bid and ask prices\nbid_prices = np.array([94, 95, 96, 97, 98, 99])  # Bid price levels\nask_prices = np.array([101, 102, 103, 104, 105, 106])  # Ask price levels\n\n# Randomize volumes for bids and asks\nnp.random.seed(45)  # For reproducibility\nbid_volumes = np.random.randint(50, 400, size=len(bid_prices))  # Random volumes for bids\nask_volumes = np.random.randint(50, 400, size=len(ask_prices))  # Random volumes for asks\n\n# Empty volumes for levels close to the mid-price (bid at 99 and ask at 101)\nbid_volumes[5] = 0  # Bid close to mid (price 99)\nask_volumes[0] = 0  # Ask close to mid (price 101)\n\n# Calculate the best bid and ask prices and their volumes\n# Best bid: highest bid price with non-zero volume\nnonzero_bid_indices = np.where(bid_volumes > 0)[0]\nif len(nonzero_bid_indices) > 0:\n    best_bid_price = bid_prices[nonzero_bid_indices].max()\n    best_bid_index = np.where(bid_prices == best_bid_price)[0][0]\n    best_bid_volume = bid_volumes[best_bid_index]\nelse:\n    best_bid_price = None\n    best_bid_volume = 0\n\n# Best ask: lowest ask price with non-zero volume\nnonzero_ask_indices = np.where(ask_volumes > 0)[0]\nif len(nonzero_ask_indices) > 0:\n    best_ask_price = ask_prices[nonzero_ask_indices].min()\n    best_ask_index = np.where(ask_prices == best_ask_price)[0][0]\n    best_ask_volume = ask_volumes[best_ask_index]\nelse:\n    best_ask_price = None\n    best_ask_volume = 0\n\n# Calculate mid-price and spread\nif best_bid_price is not None and best_ask_price is not None:\n    mid_price = (best_bid_price + best_ask_price) / 2\n    spread = best_ask_price - best_bid_price\nelse:\n    mid_price = None\n    spread = None\n\n# Calculate imbalance between best bid and ask volumes\ntotal_volume = best_bid_volume + best_ask_volume\nif total_volume > 0:\n    imbalance = (best_bid_volume - best_ask_volume) / total_volume\nelse:\n    imbalance = None\n\n# Create figure and axes\nfig, ax = plt.subplots(figsize=(10, 6))\n\n# Plot bid bars (leave a gap near the mid-price)\nax.bar(bid_prices, bid_volumes, color='green', align='center', label='Bid Orders')\n\n# Plot ask bars (leave a gap near the mid-price)\nax.bar(ask_prices, ask_volumes, color='red', align='center', label='Ask Orders')\n\n# Mid-price line\nif mid_price is not None:\n    ax.axvline(mid_price, color='black', linestyle='--', label=f'Mid Price')\nelse:\n    ax.axvline(100, color='black', linestyle='--', label='Mid Price')\n\n# Adding x-axis ticks for every integer price level from min to max price\nall_price_levels = np.arange(min(bid_prices.min(), ask_prices.min()), max(bid_prices.max(), ask_prices.max()) + 1)\nax.set_xticks(all_price_levels)\nax.set_xticklabels(all_price_levels)\n\n# Labels and title\nax.set_ylabel('Volume')\nax.set_xlabel('Price Levels')\nax.set_title('Central Limit Order Book (Market Depth)')\nax.legend()\n\n# Show the plot\nplt.show()\n\n# Print the calculated values\nprint(\"Calculated Market Metrics:\")\nif best_bid_price is not None:\n    print(f\"Best Bid Price: {best_bid_price}, Volume: {best_bid_volume}\")\nelse:\n    print(\"No bids available.\")\n\nif best_ask_price is not None:\n    print(f\"Best Ask Price: {best_ask_price}, Volume: {best_ask_volume}\")\nelse:\n    print(\"No asks available.\")\n\nif mid_price is not None and spread is not None:\n    print(f\"Mid-Price: {mid_price:.2f}\")\n    print(f\"Spread: {spread:.2f}\")\nelse:\n    print(\"Mid-Price and Spread are not available.\")\n\nif imbalance is not None:\n    print(f\"Imbalance between best bid and ask: {imbalance:.2f}\")\nelse:\n    print(\"Imbalance is not available due to zero total volume at best bid and ask.\")\n","key":"oI6qsCrI1V"},{"type":"outputs","id":"jI12LVLj6vWofeLSIXrjx","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"b3c608131bbf816449255a1770f121c6","path":"/build/b3c608131bbf816449255a1770f121c6.png"},"text/plain":{"content":"<Figure size 1000x600 with 1 Axes>","content_type":"text/plain"}}},"children":[],"key":"Mt4ibd7hle"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Calculated Market Metrics:\nBest Bid Price: 98, Volume: 213\nBest Ask Price: 102, Volume: 65\nMid-Price: 100.00\nSpread: 4.00\nImbalance between best bid and ask: 0.53\n"},"children":[],"key":"YaTp5Jk1Yf"}],"key":"xwF4ViExhF"}],"key":"ckYs67po3f"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Effect of a market order in the CLOB","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AhWaavnT1t"}],"identifier":"effect-of-a-market-order-in-the-clob","label":"Effect of a market order in the CLOB","html_id":"effect-of-a-market-order-in-the-clob","implicit":true,"key":"b61qlxutoQ"}],"key":"nb3AVXRFjQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import matplotlib.pyplot as plt\nimport numpy as np\n\n# Define bid and ask prices\nbid_prices = np.array([94, 95, 96, 97, 98, 99])  # Bid price levels\nask_prices = np.array([101, 102, 103, 104, 105, 106])  # Ask price levels\n\n# Randomize volumes for bids and asks\nnp.random.seed(45)  # For reproducibility\nbid_volumes = np.random.randint(50, 400, size=len(bid_prices))  # Random volumes for bids\nask_volumes = np.random.randint(50, 400, size=len(ask_prices))  # Random volumes for asks\n\n# Empty volumes for levels close to the mid-price (bid at 99 and ask at 101)\nbid_volumes[5] = 0  # Bid close to mid\nask_volumes[0] = 0  # Ask close to mid\n\n# Arrays to track consumed volumes (for visualization)\nconsumed_bid_volumes = np.zeros(len(bid_volumes))\nconsumed_ask_volumes = np.zeros(len(ask_volumes))\n\nmid_price = 100  # Initial mid-price before market order execution\n\n# Simulate market order input\nmarket_order_size = 500  # For example, 500\nmarket_order_side = \"buy\"  # For example, 'buy'\n\n# Function to simulate the market order\ndef execute_market_order(order_size, order_side):\n    global bid_volumes, ask_volumes, consumed_bid_volumes, consumed_ask_volumes\n    executed_volume = 0\n    executed_value = 0\n\n    if order_side == 'buy':  # Market order to buy shares\n        remaining_size = order_size\n        for i in range(len(ask_prices)):\n            if ask_volumes[i] > 0:\n                tradable_volume = min(ask_volumes[i], remaining_size)\n                executed_volume += tradable_volume\n                executed_value += tradable_volume * ask_prices[i]\n                consumed_ask_volumes[i] += tradable_volume  # Track consumed volume\n                ask_volumes[i] -= tradable_volume\n                remaining_size -= tradable_volume\n                if remaining_size <= 0:\n                    break\n    elif order_side == 'sell':  # Market order to sell shares\n        remaining_size = order_size\n        for i in range(len(bid_prices)-1, -1, -1):  # Start from highest bid\n            if bid_volumes[i] > 0:\n                tradable_volume = min(bid_volumes[i], remaining_size)\n                executed_volume += tradable_volume\n                executed_value += tradable_volume * bid_prices[i]\n                consumed_bid_volumes[i] += tradable_volume  # Track consumed volume\n                bid_volumes[i] -= tradable_volume\n                remaining_size -= tradable_volume\n                if remaining_size <= 0:\n                    break\n\n    # Calculate the average execution price\n    execution_price = executed_value / executed_volume if executed_volume > 0 else 0\n    return execution_price\n\n# Function to recalculate the mid-price based on the updated order book\ndef recalculate_mid_price():\n    global bid_prices, bid_volumes, ask_prices, ask_volumes\n    # Get the best bid price (highest bid price with non-zero volume)\n    if np.any(bid_volumes > 0):\n        best_bid = np.max(bid_prices[bid_volumes > 0])\n    else:\n        best_bid = np.nan  # No bids in the book\n\n    # Get the best ask price (lowest ask price with non-zero volume)\n    if np.any(ask_volumes > 0):\n        best_ask = np.min(ask_prices[ask_volumes > 0])\n    else:\n        best_ask = np.nan  # No asks in the book\n\n    # Recalculate mid-price\n    if not np.isnan(best_bid) and not np.isnan(best_ask):\n        new_mid_price = (best_bid + best_ask) / 2\n    elif not np.isnan(best_bid):\n        new_mid_price = best_bid  # Only bids are available\n    elif not np.isnan(best_ask):\n        new_mid_price = best_ask  # Only asks are available\n    else:\n        new_mid_price = np.nan  # No bids or asks in the book\n\n    return new_mid_price\n\n# Updated function to visualize the order book\ndef plot_order_book(order_side, mid_price):\n    fig, ax = plt.subplots(figsize=(10, 6))\n\n    # Plot remaining bid orders in green\n    ax.bar(bid_prices, bid_volumes, color='green', align='center', label='Remaining Bid Orders')\n\n    # Plot remaining ask orders in red\n    ax.bar(ask_prices, ask_volumes, color='red', align='center', label='Remaining Ask Orders')\n\n    # Plot consumed liquidity based on the order side\n    if order_side == 'buy':\n        # Plot consumed ask liquidity on top with a hatch pattern\n        if np.any(consumed_ask_volumes > 0):\n            ax.bar(ask_prices, consumed_ask_volumes, bottom=ask_volumes, color='red', align='center',\n                   label='Consumed Ask Liquidity', hatch='\\\\\\\\', edgecolor='red', alpha=0.7)\n    elif order_side == 'sell':\n        # Plot consumed bid liquidity on top with a hatch pattern\n        if np.any(consumed_bid_volumes > 0):\n            ax.bar(bid_prices, consumed_bid_volumes, bottom=bid_volumes, color='green', align='center',\n                   label='Consumed Bid Liquidity', hatch='//', edgecolor='green', alpha=0.7)\n\n    # Mid-price line\n    if not np.isnan(mid_price):\n        ax.axvline(mid_price, color='black', linestyle='--', label=f'Mid Price')\n    else:\n        ax.axvline(mid_price, color='black', linestyle='--', label='Mid Price Unavailable')\n\n    # Adding x-axis ticks for every integer price level from min to max price\n    all_price_levels = np.arange(min(bid_prices.min(), ask_prices.min()), max(bid_prices.max(), ask_prices.max()) + 1)\n    ax.set_xticks(all_price_levels)\n    ax.set_xticklabels(all_price_levels)\n\n    # Labels and title\n    ax.set_ylabel('Volume')\n    ax.set_xlabel('Price Levels')\n    ax.set_title('Effect of a Market Order in the CLOB')\n\n    # Custom legend to include only relevant labels\n    handles, labels = ax.get_legend_handles_labels()\n    by_label = dict(zip(labels, handles))\n\n    # Filter the legend labels based on the order side\n    if order_side == 'buy':\n        by_label.pop('Consumed Bid Liquidity', None)\n    elif order_side == 'sell':\n        by_label.pop('Consumed Ask Liquidity', None)\n\n    ax.legend(by_label.values(), by_label.keys())\n\n    plt.show()\n\n# Execute the market order and update the order book\nexecution_price = execute_market_order(market_order_size, market_order_side)\n\n# Recalculate the mid-price based on the updated order book\nnew_mid_price = recalculate_mid_price()\n\n# Plot the updated order book with the new mid-price\nplot_order_book(market_order_side, new_mid_price)\n\n# Output the execution price and the new mid-price\nprint(f\"The average execution price for the market order is: {execution_price:.2f}\")\nif not np.isnan(new_mid_price):\n    print(f\"The new mid-price after the market order execution is: {new_mid_price:.2f}\")\nelse:\n    print(\"The mid-price is unavailable due to no bids or asks in the book.\")\n","key":"tVWm0kY5TS"},{"type":"outputs","id":"koO8S5_bQo5gEozVUWmAk","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"aa56161046499d81cae58ec2da0f4e3f","path":"/build/aa56161046499d81cae58ec2da0f4e3f.png"},"text/plain":{"content":"<Figure size 1000x600 with 1 Axes>","content_type":"text/plain"}}},"children":[],"key":"IHPrCvofHN"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"The average execution price for the market order is: 103.51\nThe new mid-price after the market order execution is: 101.00\n"},"children":[],"key":"brfkJWd44z"}],"key":"eHhhSSoX6k"}],"key":"NqznFrWHXR"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Effect of a limit order in the CLOB","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Stw5GveCqS"}],"identifier":"effect-of-a-limit-order-in-the-clob","label":"Effect of a limit order in the CLOB","html_id":"effect-of-a-limit-order-in-the-clob","implicit":true,"key":"rKHw24VGbM"}],"key":"f8k2HYKaX2"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import matplotlib.pyplot as plt\nimport numpy as np\n\n# Define bid and ask prices\nbid_prices = np.array([94, 95, 96, 97, 98, 99])  # Bid price levels\nask_prices = np.array([101, 102, 103, 104, 105, 106])  # Ask price levels\n\n# Randomize volumes for bids and asks\nnp.random.seed(45)  # For reproducibility\nbid_volumes = np.random.randint(50, 400, size=len(bid_prices))  # Random volumes for bids\nask_volumes = np.random.randint(50, 400, size=len(ask_prices))  # Random volumes for asks\n\n# Empty volumes for levels close to the mid-price (bid at 99 and ask at 101)\nbid_volumes[5] = 0  # Bid close to mid\nask_volumes[0] = 0  # Ask close to mid\n\n# Arrays to track consumed volumes and new limit orders for visualization\nconsumed_bid_volumes = np.zeros(len(bid_volumes))\nconsumed_ask_volumes = np.zeros(len(ask_volumes))\nnew_bid_volumes = np.zeros(len(bid_volumes))\nnew_ask_volumes = np.zeros(len(ask_volumes))\n\nmid_price = 100  # Initial mid-price before limit order execution\n\n# Function to simulate an aggressive limit order\ndef execute_limit_order(order_price, order_volume, order_side):\n    global bid_volumes, ask_volumes, consumed_bid_volumes, consumed_ask_volumes, new_bid_volumes, new_ask_volumes\n\n    executed_volume = 0\n    executed_value = 0\n    remaining_volume = order_volume\n\n    if order_side == 'buy':\n        best_ask = min(ask_prices[ask_volumes > 0]) if np.any(ask_volumes > 0) else np.inf\n        if order_price < best_ask:\n            # The buy limit order remains unexecuted and gets added to the book below existing orders\n            insert_order_into_book(order_price, remaining_volume, 'buy', priority='low')\n            return 0, remaining_volume  # No execution, entire order sits in the book\n        else:\n            # The buy limit order consumes liquidity like a market order up to the limit price\n            for i in range(len(ask_prices)):\n                if ask_prices[i] <= order_price and ask_volumes[i] > 0:\n                    if ask_volumes[i] >= remaining_volume:\n                        executed_volume += remaining_volume\n                        executed_value += remaining_volume * ask_prices[i]\n                        consumed_ask_volumes[i] += remaining_volume  # Track consumed volume\n                        ask_volumes[i] -= remaining_volume\n                        remaining_volume = 0\n                        break\n                    else:\n                        executed_volume += ask_volumes[i]\n                        executed_value += ask_volumes[i] * ask_prices[i]\n                        consumed_ask_volumes[i] += ask_volumes[i]  # Track consumed volume\n                        remaining_volume -= ask_volumes[i]\n                        ask_volumes[i] = 0\n            # Any remaining volume sits in the book at the limit price\n            if remaining_volume > 0:\n                insert_order_into_book(order_price, remaining_volume, 'buy', priority='low')\n\n    elif order_side == 'sell':\n        best_bid = max(bid_prices[bid_volumes > 0]) if np.any(bid_volumes > 0) else -np.inf\n        if order_price > best_bid:\n            # The sell limit order remains unexecuted and gets added to the book above existing orders\n            insert_order_into_book(order_price, remaining_volume, 'sell', priority='low')\n            return 0, remaining_volume  # No execution, entire order sits in the book\n        else:\n            # The sell limit order consumes liquidity like a market order up to the limit price\n            for i in range(len(bid_prices)-1, -1, -1):  # Start from highest bid\n                if bid_prices[i] >= order_price and bid_volumes[i] > 0:\n                    if bid_volumes[i] >= remaining_volume:\n                        executed_volume += remaining_volume\n                        executed_value += remaining_volume * bid_prices[i]\n                        consumed_bid_volumes[i] += remaining_volume  # Track consumed volume\n                        bid_volumes[i] -= remaining_volume\n                        remaining_volume = 0\n                        break\n                    else:\n                        executed_volume += bid_volumes[i]\n                        executed_value += bid_volumes[i] * bid_prices[i]\n                        consumed_bid_volumes[i] += bid_volumes[i]  # Track consumed volume\n                        remaining_volume -= bid_volumes[i]\n                        bid_volumes[i] = 0\n            # Any remaining volume sits in the book at the limit price\n            if remaining_volume > 0:\n                insert_order_into_book(order_price, remaining_volume, 'sell', priority='low')\n\n    # Calculate the average execution price\n    execution_price = executed_value / executed_volume if executed_volume > 0 else 0\n    return execution_price, remaining_volume\n\n# Function to insert the remaining limit order into the order book\ndef insert_order_into_book(order_price, remaining_volume, order_side, priority):\n    global bid_prices, ask_prices, bid_volumes, ask_volumes, new_bid_volumes, new_ask_volumes, consumed_bid_volumes, consumed_ask_volumes\n\n    if order_side == 'buy':  # Remaining buy order stays as a bid\n        # Check if the price level exists\n        if order_price in bid_prices:\n            index = np.where(bid_prices == order_price)[0][0]\n            if priority == 'low':\n                new_bid_volumes[index] += remaining_volume  # Lower priority new limit order\n            else:\n                bid_volumes[index] += remaining_volume  # Higher priority remaining volume\n        else:\n            # Insert a new price level\n            bid_prices = np.append(bid_prices, order_price)\n            bid_volumes = np.append(bid_volumes, 0 if priority == 'low' else remaining_volume)\n            new_bid_volumes = np.append(new_bid_volumes, remaining_volume if priority == 'low' else 0)\n            consumed_bid_volumes = np.append(consumed_bid_volumes, 0)\n            # Sort by price\n            sort_indices = np.argsort(bid_prices)\n            bid_prices = bid_prices[sort_indices]\n            bid_volumes = bid_volumes[sort_indices]\n            new_bid_volumes = new_bid_volumes[sort_indices]\n            consumed_bid_volumes = consumed_bid_volumes[sort_indices]\n\n    elif order_side == 'sell':  # Remaining sell order stays as an ask\n        # Check if the price level exists\n        if order_price in ask_prices:\n            index = np.where(ask_prices == order_price)[0][0]\n            if priority == 'low':\n                new_ask_volumes[index] += remaining_volume  # Lower priority new limit order\n            else:\n                ask_volumes[index] += remaining_volume  # Higher priority remaining volume\n        else:\n            # Insert a new price level\n            ask_prices = np.append(ask_prices, order_price)\n            ask_volumes = np.append(ask_volumes, 0 if priority == 'low' else remaining_volume)\n            new_ask_volumes = np.append(new_ask_volumes, remaining_volume if priority == 'low' else 0)\n            consumed_ask_volumes = np.append(consumed_ask_volumes, 0)\n            # Sort by price\n            sort_indices = np.argsort(ask_prices)\n            ask_prices = ask_prices[sort_indices]\n            ask_volumes = ask_volumes[sort_indices]\n            new_ask_volumes = new_ask_volumes[sort_indices]\n            consumed_ask_volumes = consumed_ask_volumes[sort_indices]\n\n# Function to recalculate the mid-price based on the updated order book\ndef recalculate_mid_price():\n    global bid_prices, bid_volumes, ask_prices, ask_volumes, new_bid_volumes, new_ask_volumes\n    # Calculate total bid volumes at each price level\n    total_bid_volumes = bid_volumes + new_bid_volumes\n    # Get the best bid price (highest bid price with non-zero volume)\n    if np.any(total_bid_volumes > 0):\n        best_bid = np.max(bid_prices[total_bid_volumes > 0])\n    else:\n        best_bid = np.nan  # No bids in the book\n\n    # Calculate total ask volumes at each price level\n    total_ask_volumes = ask_volumes + new_ask_volumes\n    # Get the best ask price (lowest ask price with non-zero volume)\n    if np.any(total_ask_volumes > 0):\n        best_ask = np.min(ask_prices[total_ask_volumes > 0])\n    else:\n        best_ask = np.nan  # No asks in the book\n\n    # Recalculate mid-price\n    if not np.isnan(best_bid) and not np.isnan(best_ask):\n        new_mid_price = (best_bid + best_ask) / 2\n    elif not np.isnan(best_bid):\n        new_mid_price = best_bid  # Only bids are available\n    elif not np.isnan(best_ask):\n        new_mid_price = best_ask  # Only asks are available\n    else:\n        new_mid_price = np.nan  # No bids or asks in the book\n\n    return new_mid_price\n\n# Updated function to visualize the order book\ndef plot_order_book(order_side, mid_price):\n    fig, ax = plt.subplots(figsize=(10, 6))\n\n    # For bids\n    # Total volumes for stacking\n    bid_total_volumes = new_bid_volumes + bid_volumes + consumed_bid_volumes\n\n    # Plot new bid limit orders at the bottom\n    ax.bar(bid_prices, new_bid_volumes, color='darkgreen', align='center',\n           label='New Bid Limit Orders')\n\n    # Plot existing bid orders on top of new limit orders\n    bid_existing_bottom = new_bid_volumes\n    ax.bar(bid_prices, bid_volumes, bottom=bid_existing_bottom, color='green', align='center',\n           label='Remaining Bid Orders')\n\n    # Plot consumed bid liquidity on top of existing orders\n    bid_consumed_bottom = bid_existing_bottom + bid_volumes\n    if np.any(consumed_bid_volumes > 0):\n        ax.bar(bid_prices, consumed_bid_volumes, bottom=bid_consumed_bottom, color='green', align='center',\n               label='Consumed Liquidity', hatch='//', edgecolor='green', alpha=0.7)\n\n    # For asks\n    # Total volumes for stacking\n    ask_total_volumes = new_ask_volumes + ask_volumes + consumed_ask_volumes\n\n    # Plot new ask limit orders at the bottom\n    ax.bar(ask_prices, new_ask_volumes, color='darkred', align='center',\n           label='New Ask Limit Orders')\n\n    # Plot existing ask orders on top of new limit orders\n    ask_existing_bottom = new_ask_volumes\n    ax.bar(ask_prices, ask_volumes, bottom=ask_existing_bottom, color='red', align='center',\n           label='Remaining Ask Orders')\n\n    # Plot consumed ask liquidity on top of existing orders\n    ask_consumed_bottom = ask_existing_bottom + ask_volumes\n    if np.any(consumed_ask_volumes > 0):\n        ax.bar(ask_prices, consumed_ask_volumes, bottom=ask_consumed_bottom, color='red', align='center',\n               label='Consumed Liquidity', hatch='\\\\\\\\', edgecolor='red', alpha=0.7)\n\n    # Mid-price line\n    if not np.isnan(mid_price):\n        ax.axvline(mid_price, color='black', linestyle='--', label=f'Mid Price')\n    else:\n        ax.axvline(mid_price, color='black', linestyle='--', label='Mid Price Unavailable')\n\n    # Adding x-axis ticks\n    all_price_levels = np.arange(min(bid_prices.min(), ask_prices.min()), max(bid_prices.max(), ask_prices.max()) + 1)\n    ax.set_xticks(all_price_levels)\n    ax.set_xticklabels(all_price_levels)\n\n    # Labels and title\n    ax.set_ylabel('Volume')\n    ax.set_xlabel('Price Levels')\n    ax.set_title('Effect of a limit order in the CLOB')\n\n    # Custom legend\n    handles, labels = ax.get_legend_handles_labels()\n    by_label = dict(zip(labels, handles))\n    ax.legend(by_label.values(), by_label.keys())\n\n    plt.show()\n\n# Example of a buy limit order at price 102 for 700 shares\nlimit_order_price = 98\nlimit_order_volume = 500\nlimit_order_side = 'buy'\n\n# Execute the limit order\nexecution_price, remaining_volume = execute_limit_order(limit_order_price, limit_order_volume, limit_order_side)\n\n# Recalculate the mid-price based on the updated order book\nnew_mid_price = recalculate_mid_price()\n\n# Plot the updated order book with the new mid-price\nplot_order_book(limit_order_side, new_mid_price)\n\n# Output the execution price and remaining order details\nprint(f\"The average execution price for the limit order is: {execution_price:.2f}\")\nif remaining_volume > 0:\n    print(f\"Remaining order of {remaining_volume} shares sits in the book at the limit price of {limit_order_price}.\")\nif not np.isnan(new_mid_price):\n    print(f\"The new mid-price after the limit order execution is: {new_mid_price:.2f}\")\nelse:\n    print(\"The mid-price is unavailable due to no bids or asks in the book.\")\n","key":"QwLfkiH4LC"},{"type":"outputs","id":"M_0EwscX56mXZvwdZ1ulZ","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"35c62b7c186dc7d9deaf54963ae515ee","path":"/build/35c62b7c186dc7d9deaf54963ae515ee.png"},"text/plain":{"content":"<Figure size 1000x600 with 1 Axes>","content_type":"text/plain"}}},"children":[],"key":"zxwMCEpDeJ"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"The average execution price for the limit order is: 0.00\nRemaining order of 500 shares sits in the book at the limit price of 98.\nThe new mid-price after the limit order execution is: 100.00\n"},"children":[],"key":"kpc6aUzZI5"}],"key":"bkacV9GFrL"}],"key":"op7V9pfd3I"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The RfQ process in MD2C platforms","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"at2gdtd03E"}],"identifier":"the-rfq-process-in-md2c-platforms","label":"The RfQ process in MD2C platforms","html_id":"the-rfq-process-in-md2c-platforms","implicit":true,"key":"zKQXMfzWLH"},{"type":"heading","depth":3,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Visualization of RfQ process","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"rP0bIuxm4H"}],"identifier":"visualization-of-rfq-process","label":"Visualization of RfQ process","html_id":"visualization-of-rfq-process","implicit":true,"key":"uWUhE5LxPz"}],"key":"EPOZdY4WiV"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from graphviz import Digraph\n\n# Create a new directed graph\ndot = Digraph(comment='RfQ Protocol')\n\n# Graph-level attributes for font\ndot.attr(fontname='Helvetica', fontsize='12')\n\n# Add nodes with custom fonts\ndot.node('Client', 'Client', shape='ellipse', style='filled', color='lightblue', fontname='Helvetica', fontsize='12')\ndot.node('Platform', 'Platform', shape='box', style='filled', color='lightgrey', fontname='Helvetica', fontsize='12')\n\n# Add dealers with custom fonts\nfor i in range(1, 5):  # Adjust the number of dealers as needed\n    dot.node(f'Dealer{i}', f'Dealer {i}', shape='ellipse', style='filled', color='lightcoral', fontname='Helvetica-Italic', fontsize='12')\n\n# Add edges with custom fonts\ndot.edge('Client', 'Platform', label='RfQ', fontname='Courier', fontsize='10', fontcolor='darkblue')\nfor i in range(1, 5):\n    dot.edge('Platform', f'Dealer{i}', label=f'RfQ', fontname='Courier', fontsize='10', fontcolor='darkblue')\n    dot.edge(f'Dealer{i}', 'Platform', label=f'Quote{i}', fontname='Courier', fontsize='10', fontcolor='darkred')\ndot.edge('Platform', 'Client', label='Quotes', fontname='Courier', fontsize='10', fontcolor='darkred')\n\n# Render and display the graph\n# dot.render(\"/Users/javier/Documents/aaat/markdown/rfq\", format='png', cleanup=True)\ndot","key":"xuY9W3JXmL"},{"type":"outputs","id":"80b3gOrI9tSPYuxEdbYlL","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":45,"metadata":{},"data":{"image/svg+xml":{"content":"<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (0)\n -->\n<!-- Pages: 1 -->\n<svg width=\"387pt\" height=\"210pt\"\n viewBox=\"0.00 0.00 387.33 210.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 206)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-206 383.33,-206 383.33,4 -4,4\"/>\n<!-- Client -->\n<g id=\"node1\" class=\"node\">\n<title>Client</title>\n<ellipse fill=\"lightblue\" stroke=\"lightblue\" cx=\"192.17\" cy=\"-184\" rx=\"29.6\" ry=\"18\"/>\n<text text-anchor=\"middle\" x=\"192.17\" y=\"-180.9\" font-family=\"Helvetica,sans-Serif\" font-size=\"12.00\">Client</text>\n</g>\n<!-- Platform -->\n<g id=\"node2\" class=\"node\">\n<title>Platform</title>\n<polygon fill=\"lightgrey\" stroke=\"lightgrey\" points=\"222.67,-119 161.67,-119 161.67,-83 222.67,-83 222.67,-119\"/>\n<text text-anchor=\"middle\" x=\"192.17\" y=\"-97.9\" font-family=\"Helvetica,sans-Serif\" font-size=\"12.00\">Platform</text>\n</g>\n<!-- Client&#45;&gt;Platform -->\n<g id=\"edge1\" class=\"edge\">\n<title>Client&#45;&gt;Platform</title>\n<path fill=\"none\" stroke=\"black\" d=\"M180.73,-167.04C177.27,-161.31 173.93,-154.63 172.17,-148 170.44,-141.48 171.58,-134.7 174.02,-128.41\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"177.37,-129.54 178.7,-119.03 171.1,-126.42 177.37,-129.54\"/>\n<text text-anchor=\"middle\" x=\"181.67\" y=\"-140\" font-family=\"Courier,monospace\" font-size=\"10.00\" fill=\"darkblue\">RfQ</text>\n</g>\n<!-- Platform&#45;&gt;Client -->\n<g id=\"edge10\" class=\"edge\">\n<title>Platform&#45;&gt;Client</title>\n<path fill=\"none\" stroke=\"black\" d=\"M192.17,-119.15C192.17,-129.78 192.17,-143.66 192.17,-155.77\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"188.67,-155.82 192.17,-165.82 195.67,-155.82 188.67,-155.82\"/>\n<text text-anchor=\"middle\" x=\"210.67\" y=\"-140\" font-family=\"Courier,monospace\" font-size=\"10.00\" fill=\"darkred\">Quotes</text>\n</g>\n<!-- Dealer1 -->\n<g id=\"node3\" class=\"node\">\n<title>Dealer1</title>\n<ellipse fill=\"lightcoral\" stroke=\"lightcoral\" cx=\"38.17\" cy=\"-18\" rx=\"38.33\" ry=\"18\"/>\n<text text-anchor=\"middle\" x=\"38.17\" y=\"-14.9\" font-family=\"Helvetica-Italic\" font-size=\"12.00\">Dealer 1</text>\n</g>\n<!-- Platform&#45;&gt;Dealer1 -->\n<g id=\"edge2\" class=\"edge\">\n<title>Platform&#45;&gt;Dealer1</title>\n<path fill=\"none\" stroke=\"black\" d=\"M161.58,-98.33C116.81,-95.17 36.82,-86.58 19.17,-65 14.17,-58.89 15.16,-51.27 18.5,-44.01\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"21.67,-45.54 23.72,-35.14 15.63,-41.99 21.67,-45.54\"/>\n<text text-anchor=\"middle\" x=\"28.67\" y=\"-57\" font-family=\"Courier,monospace\" font-size=\"10.00\" fill=\"darkblue\">RfQ</text>\n</g>\n<!-- Dealer2 -->\n<g id=\"node4\" class=\"node\">\n<title>Dealer2</title>\n<ellipse fill=\"lightcoral\" stroke=\"lightcoral\" cx=\"144.17\" cy=\"-18\" rx=\"38.33\" ry=\"18\"/>\n<text text-anchor=\"middle\" x=\"144.17\" y=\"-14.9\" font-family=\"Helvetica-Italic\" font-size=\"12.00\">Dealer 2</text>\n</g>\n<!-- Platform&#45;&gt;Dealer2 -->\n<g id=\"edge4\" class=\"edge\">\n<title>Platform&#45;&gt;Dealer2</title>\n<path fill=\"none\" stroke=\"black\" d=\"M161.45,-92.97C146.56,-87.85 130.02,-79.24 121.17,-65 116.92,-58.18 118.51,-50.47 122.34,-43.33\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"125.46,-44.97 128.14,-34.72 119.65,-41.06 125.46,-44.97\"/>\n<text text-anchor=\"middle\" x=\"130.67\" y=\"-57\" font-family=\"Courier,monospace\" font-size=\"10.00\" fill=\"darkblue\">RfQ</text>\n</g>\n<!-- Dealer3 -->\n<g id=\"node5\" class=\"node\">\n<title>Dealer3</title>\n<ellipse fill=\"lightcoral\" stroke=\"lightcoral\" cx=\"244.17\" cy=\"-18\" rx=\"38.33\" ry=\"18\"/>\n<text text-anchor=\"middle\" x=\"244.17\" y=\"-14.9\" font-family=\"Helvetica-Italic\" font-size=\"12.00\">Dealer 3</text>\n</g>\n<!-- Platform&#45;&gt;Dealer3 -->\n<g id=\"edge6\" class=\"edge\">\n<title>Platform&#45;&gt;Dealer3</title>\n<path fill=\"none\" stroke=\"black\" d=\"M203.19,-82.82C210.44,-71.54 220.04,-56.59 228.12,-43.99\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"231.23,-45.63 233.69,-35.32 225.34,-41.85 231.23,-45.63\"/>\n<text text-anchor=\"middle\" x=\"230.67\" y=\"-57\" font-family=\"Courier,monospace\" font-size=\"10.00\" fill=\"darkblue\">RfQ</text>\n</g>\n<!-- Dealer4 -->\n<g id=\"node6\" class=\"node\">\n<title>Dealer4</title>\n<ellipse fill=\"lightcoral\" stroke=\"lightcoral\" cx=\"341.17\" cy=\"-18\" rx=\"38.33\" ry=\"18\"/>\n<text text-anchor=\"middle\" x=\"341.17\" y=\"-14.9\" font-family=\"Helvetica-Italic\" font-size=\"12.00\">Dealer 4</text>\n</g>\n<!-- Platform&#45;&gt;Dealer4 -->\n<g id=\"edge8\" class=\"edge\">\n<title>Platform&#45;&gt;Dealer4</title>\n<path fill=\"none\" stroke=\"black\" d=\"M222.98,-91.45C241.92,-85.5 266.29,-76.55 286.17,-65 297.32,-58.52 308.46,-49.74 317.76,-41.6\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"320.35,-43.98 325.42,-34.67 315.66,-38.78 320.35,-43.98\"/>\n<text text-anchor=\"middle\" x=\"311.67\" y=\"-57\" font-family=\"Courier,monospace\" font-size=\"10.00\" fill=\"darkblue\">RfQ</text>\n</g>\n<!-- Dealer1&#45;&gt;Platform -->\n<g id=\"edge3\" class=\"edge\">\n<title>Dealer1&#45;&gt;Platform</title>\n<path fill=\"none\" stroke=\"black\" d=\"M48.99,-35.56C56.19,-45.39 66.45,-57.39 78.17,-65 100.29,-79.39 128.65,-88.12 151.55,-93.27\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"151.14,-96.76 161.64,-95.39 152.57,-89.91 151.14,-96.76\"/>\n<text text-anchor=\"middle\" x=\"96.67\" y=\"-57\" font-family=\"Courier,monospace\" font-size=\"10.00\" fill=\"darkred\">Quote1</text>\n</g>\n<!-- Dealer2&#45;&gt;Platform -->\n<g id=\"edge5\" class=\"edge\">\n<title>Dealer2&#45;&gt;Platform</title>\n<path fill=\"none\" stroke=\"black\" d=\"M149.87,-36.19C153.16,-45.1 157.73,-55.97 163.17,-65 165.21,-68.4 167.58,-71.82 170.05,-75.11\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"167.35,-77.34 176.32,-82.97 172.82,-72.97 167.35,-77.34\"/>\n<text text-anchor=\"middle\" x=\"181.67\" y=\"-57\" font-family=\"Courier,monospace\" font-size=\"10.00\" fill=\"darkred\">Quote2</text>\n</g>\n<!-- Dealer3&#45;&gt;Platform -->\n<g id=\"edge7\" class=\"edge\">\n<title>Dealer3&#45;&gt;Platform</title>\n<path fill=\"none\" stroke=\"black\" d=\"M246.92,-36.15C247.55,-45.25 246.93,-56.31 242.17,-65 239.29,-70.24 235.26,-74.87 230.72,-78.9\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"228.46,-76.22 222.71,-85.13 232.75,-81.75 228.46,-76.22\"/>\n<text text-anchor=\"middle\" x=\"263.67\" y=\"-57\" font-family=\"Courier,monospace\" font-size=\"10.00\" fill=\"darkred\">Quote3</text>\n</g>\n<!-- Dealer4&#45;&gt;Platform -->\n<g id=\"edge9\" class=\"edge\">\n<title>Dealer4&#45;&gt;Platform</title>\n<path fill=\"none\" stroke=\"black\" d=\"M339.22,-36.04C337.23,-45.79 333.23,-57.53 325.17,-65 300.27,-88.04 262.05,-96.28 232.96,-99.06\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"232.4,-95.6 222.7,-99.86 232.94,-102.57 232.4,-95.6\"/>\n<text text-anchor=\"middle\" x=\"350.67\" y=\"-57\" font-family=\"Courier,monospace\" font-size=\"10.00\" fill=\"darkred\">Quote4</text>\n</g>\n</g>\n</svg>\n","content_type":"image/svg+xml"},"text/plain":{"content":"<graphviz.graphs.Digraph at 0x1137165e0>","content_type":"text/plain"}}},"children":[],"key":"ewpkmYxGtB"}],"key":"jJDPVKVvOW"}],"key":"aH2PklEiSh"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"","key":"wsSAwGV82D"},{"type":"outputs","id":"DpJPQ6A93okGkx_i0E_bW","children":[],"key":"je5UInUgNP"}],"key":"j08osdale1"}],"key":"EpgJJwAqfP"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Bayesian Modelling","url":"/notebooks/bayesian-theory","group":"Notebooks"},"next":{"title":"Modelling RfQs in Dealer to Client Markets","url":"/notebooks/rfq-models","group":"Notebooks"}}},"domain":"http://localhost:3002"}